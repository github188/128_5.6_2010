
if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_InOutMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_InOutMine]
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_InOutMine As Select * From His_InOutMine_20081 Union All Select * From His_InOutMine_20082 Union All Select * From His_InOutMine_20083 Union All Select * From His_InOutMine_20084 Union All Select * From His_InOutMine_20085 Union All Select * From His_InOutMine_20086 Union All Select * From His_InOutMine_20087 Union All Select * From His_InOutMine_20088 Union All Select * From His_InOutMine_20089 Union All Select * From His_InOutMine_200810 Union All Select * From His_InOutMine_200811 Union All Select * From His_InOutMine_200812 Union All Select * from His_InOutMine_1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_InOutStationHead]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_InOutStationHead]
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_InOutStationHead As Select * from His_InOutStationHead_20081 Union All Select * from His_InOutStationHead_20082 Union All Select * from His_InOutStationHead_20083 Union All Select * from His_InOutStationHead_20084 Union All Select * from His_InOutStationHead_20085 Union All Select * from His_InOutStationHead_20086 Union All Select * from His_InOutStationHead_20087 Union All Select * from His_InOutStationHead_20088 Union All Select * from His_InOutStationHead_20089 Union All Select * from His_InOutStationHead_200810 Union All Select * from His_InOutStationHead_200811 Union All Select * from His_InOutStationHead_200812 Union All Select * from His_InOutStationHead_1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_EmpMonthStat_HH]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[A_EmpMonthStat_HH]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_EmpTimeMonthStat_HH]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[A_EmpTimeMonthStat_HH]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Array_Split]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[Array_Split]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EmpMonthStat]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[EmpMonthStat]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[EmpTimeMonthStat]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[EmpTimeMonthStat]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunConvertTime]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunConvertTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDateBigIntID]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDateBigIntID]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDateBitLong]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDateBitLong]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDateString]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDateString]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDateStringID]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDateStringID]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDisplayAntenna]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDisplayAntenna]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunDisplayAntennaInfo]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunDisplayAntennaInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunInMine]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunInMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunOutMine]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunOutMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunRTAlarm]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunRTAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunRepeatString]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunRepeatString]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunTrend]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunTrend]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunTrendAntenna]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunTrendAntenna]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunTrendInfo]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunTrendInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[FunTrendInfoAntenna]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[FunTrendInfoAntenna]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[GetCodeSenderSetInfo_Table]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[GetCodeSenderSetInfo_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[GetValue]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[GetValue]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[IsEmptyOrNull]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[IsEmptyOrNull]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Max_Card_Num]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[Max_Card_Num]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Max_Card_Num_Long]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[Max_Card_Num_Long]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[StationSumCard]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[StationSumCard]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[f_splitstr]') and xtype in (N'FN', N'IF', N'TF'))
drop function [dbo].[f_splitstr]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create    FUNCTION [dbo].[A_EmpMonthStat_HH](@userid int,@year int,@month int,@Uday int,@Dday int)
RETURNS int
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat int
if(@month=1)
begin
	select @stat=count(UserID) from dbo.His_InOutMine
	where InTime > str(@year-1)+'-12-'+str(@Uday) and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-'+str(@Dday)
	and UserID =@userid
end
else
begin
	select @stat=count(UserID) from dbo.His_InOutMine
	where InTime > str(@year)+'-'+str(@tmpmonth)+'-'+str(@Uday) and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-'+str(@Dday)
	and UserID =@userid
end

return @stat
end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE     FUNCTION [dbo].[A_EmpTimeMonthStat_HH](@userid int,@year int,@month int,@Uday int,@Dday int)
RETURNS varchar(100)
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat varchar(100)
if(@month=1)
begin
	select @stat=ISnull(sum(ContinueTime),'0') from dbo.His_InOutMine
	where InTime > str(@year-1)+'-12-'+str(@Uday) and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-'+str(@Dday)
	and UserID =@userid
end
else
begin
select @stat=ISnull(sum(ContinueTime),'0') from dbo.His_InOutMine
	where InTime > str(@year)+'-'+str(@month)+'-'+str(@Uday) and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-'+str(@Dday)
	and UserID =@userid
end
if (@stat='0')
return @stat

return dbo.FunConvertTime(@stat)
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO



CREATE  FUNCTION [dbo].[Array_Split](@array varchar(3000),@char varchar(1))
RETURNS @tabArray table(col varchar(4))  
as
BEGIN 
declare @where int
set @where = 1
while 1=@where
begin
	declare @tempInt int
	set @tempInt = CHARINDEX(@char,@array)
	if @tempInt > 0
	begin
		insert @tabArray values(SUBSTRING(@array,0,@tempInt))
		set @array = STUFF(@array,1,@tempInt,'')
	end
	if LEN(@array) > 0 and @tempInt = 0
	begin
		insert @tabArray values(@array)
		set @where = 0
	end
end
return
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE    FUNCTION [dbo].[EmpMonthStat](@userid int,@year int,@month int)
RETURNS int
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat int
	select @stat=count(UserID) from dbo.His_InOutMine
	where InTime > str(@year)+'-'+str(@month)+'-1' and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-1'
	and UserID =@userid
return @stat
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE     FUNCTION EmpTimeMonthStat(@userid int,@year int,@month int)
RETURNS varchar(100)
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat varchar(100)
	select @stat=ISnull(sum(ContinueTime),'0') from dbo.His_InOutMine
	where InTime > str(@year)+'-'+str(@month)+'-1' and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-1'
	and UserID =@userid
if (@stat='0')
return @stat

return dbo.FunConvertTime(@stat)
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



--把秒转换为 时分秒
CREATE Function FunConvertTime(@inSecond int)
returns varchar(50)
as
begin
	declare @tmpString varchar(50)
	declare @hour int,@minute int,@second int
	
	set @hour = @inSecond/3600
	set @minute = @inSecond%3600/60
	set @second = @inSecond%3600%60
	set @tmpString = LTRIM(RTRIM(str(@hour)))+'时'+LTRIM(RTRIM(str(@minute)))+'分'+LTRIM(RTRIM(str(@second)))+'秒'
	return @tmpString
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE  function FunDateBigIntID(@InputDate DateTime,@cardNumber bigint)
--将时间和卡号合成一个唯一的ID号的bigint
returns bigint
as
begin
  declare @temBigint bigint
  declare @temStr nvarchar(30)
   set @temStr= dbo. FunDateStringID(@InputDate,@cardNumber)
   set @temBigint=cast(@temStr as bigint)
   return @temBigint
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





CREATE   function FunDateBitLong(@InputDate DateTime)
-- 自动将输入一个日期转化为由年 月 日 时 分 秒 毫秒 组成 的长整型 
   returns  bigint
as

begin
--declare @InputDate DateTime
--set @InputDate=getdate()
     declare @temInt int
     declare @temStr nvarchar(100)
     declare @DateTimeValue bigint
     set @temStr=''

     -- 年 
     set @temInt=DatePart(year,@InputDate)
     set @temStr=cast(@temInt as nvarchar)
     -- 月
     set @temInt=DatePart(month,@InputDate)

      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
     -- 天
     set @temInt=Datepart(day,@InputDate)

      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 时
	 set @temInt=Datepart(Hour,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
         -- 分
      	 set @temInt=Datepart(minute,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 秒
          set @temInt=Datepart(second,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 毫秒
      set @temInt=Datepart(millisecond,@InputDate)
    
          set @temStr=@temStr+cast(@temInt as nvarchar(4))
        
     
     set @DateTimeValue=cast(@temStr as bigint)
       
  
    return @DateTimeValue
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO










CREATE        function FunDateString(@InputDate DateTime)
-- 自动将输入一个日期转化为由年 月 日 时 分 秒 毫秒 组成 的字符串 
   returns  nvarchar(25)
as
begin
--declare @InputDate DateTime
--set @InputDate=getdate()
     declare @temInt int
     declare @temStr nvarchar(100)
     declare @DateTimeValue bigint
     
     set @temStr=''
     -- 年 
     set @temInt=DatePart(year,@InputDate)
     set @temInt=@temInt-7
     set @temStr=@temStr+right(cast(@temInt as nvarchar(4)),2)
     
     -- 月
     set @temInt=DatePart(month,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
     -- 天
     set @temInt=Datepart(day,@InputDate)

      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 时
	 set @temInt=Datepart(Hour,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
         -- 分
      	 set @temInt=Datepart(minute,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 秒
          set @temInt=Datepart(second,@InputDate)
      if @temInt>9
         begin
             set @temStr=@temStr+cast(@temInt as nvarchar(2))
         end
      else
          begin
	     set @temStr=@temStr+'0' +cast(@temInt as nvarchar(2))
          end
      -- 毫秒
      set @temInt=Datepart(millisecond,@InputDate)


set  @temStr=
    
 case len(@temInt)
      when  1 then  
               @temStr+'00'+cast(@temInt as nvarchar(1))
      when 2   then
              @temStr+'0'+cast(@temInt as nvarchar(2))
      when  3   then  
              @temStr+cast(@temInt as nvarchar(3))
      when 4 then
              @temStr+left(cast(@temInt as nvarchar(5)),3)
       when 5 then
               @temStr+left(cast(@temInt as nvarchar(5)),3)
      end

      

  
     
     --set @DateTimeValue=cast(@temStr as bigint)
       
  
    return @temStr
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE   function FunDateStringID(@InputDate DateTime,@cardNumber bigint)
--将时间和卡号合成一个唯一的ID号的字符串
returns nvarchar(28)
as
begin
   declare @newStr nvarchar(28)
   declare @temStr nvarchar(10)
   declare @temInt int
   set @temInt=@cardNumber
   set @newStr=dbo.FunDateString(@InputDate)
   set @temStr=''
   set @temStr=
   case len(@CardNumber)
      when  1 then  
               @temStr+'0000'+cast(@temInt as nvarchar(1))
      when 2   then
              @temStr+'000'+cast(@temInt as nvarchar(2))
      when  3   then  
              @temStr+'00'+cast(@temInt as nvarchar(3))
      when 4 then
              @temStr+'0'+cast(@temInt as nvarchar(4))
       when 5 then
               @temStr+cast(@temInt as nvarchar(5))
       when 6 then
                @temStr+left(cast(@temInt as nvarchar(7)),5)
      end

   set @newStr=@newStr+@temStr

    return @newStr
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE  function FunDisplayAntenna(@array varchar(50))
RETURNS varchar(200)
as
BEGIN
declare @where int
declare @result varchar(50)
set @where = 1
	while @where<=2
	begin
		declare @tempInt int
		set @tempInt = CHARINDEX(',',@array)
		if @tempInt > 0
		begin				
			set @result = SUBSTRING(@array,0,@tempInt)
			set @array = STUFF(@array,1,@tempInt,'')
			if @where = 1				
			set @result = @result+'传输分站,'
			else
			set @result = @result+'读卡分站'
		end
		if LEN(@array) > 0 and @tempInt = 0
		begin
			set @result =@result+ @array+'读卡分站'
		end
		--递增
		set @where = @where +1
	end
return @result
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE   function FunDisplayAntennaInfo(@array varchar(60))
returns varchar(200)
as
begin
declare @tempInt int
set @tempInt = CHARINDEX(':',@array)
declare @d1 varchar(50),@d2 varchar(50)
set @d1 = SUBSTRING(@array,0,@tempInt)
set @d2 = SUBSTRING(@array,@tempInt+1,len(@array))
return dbo.FunDisplayAntenna(@d1)+' => '+dbo.FunDisplayAntenna(@d2)
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE            function FunInMine
(
 	@DetectTime datetime,			-- 检测时间
	@StationAddress int,			-- 基站号
	@StationHeadAddress int,		-- 探头号
	@HeadA bit,						-- 天线 A
	@HeadB bit,						-- 天线 B
	@Cards varchar(6000)
)
returns varchar(6000)
as
begin
/*
declare @temp table(C1 varchar(100))
declare @Cards varchar(6000)
declare @StationAddress int
declare @StationHeadAddress int

set @StationAddress=9
set @StationHeadAddress=1
set @Cards='113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130'
*/

--insert into @temp (C1)
--下井依据，如果一个卡在下井口基站或者井下基站被检测到，且这个卡没有在实时下井表中出现过，
--那么我们就认为此人已下井了，需要记一次下井)
--基站地址取RT_InOutStaion，如果RT_InOutStation中的记录是井下基站则
declare @BlockID int
declare @InMineCards varchar(6000)
set @InMineCards=''
declare cr cursor for (
Select F1 from (select F1 from dbo.f_splitstr(@Cards,',')) as t1
left join dbo.RT_InOutStation RTI On RTI.CodeSenderAddress=t1.F1
inner join dbo.Station_Head_Info SHI 
On SHI.StationAddress=RTI.StationAddress and SHI.StationHeadAddress=RTI.StationHeadAddress
where (SHI.StationHeadTypeID=16 or SHI.StationHeadTypeID=32) 
and (T1.F1 not in (Select CodeSenderAddress from dbo.RT_InOutMine ))
)
open cr
fetch next from cr into @BlockID
while @@fetch_status = 0
begin
--print 'd'
--print @BlockID
set @InMineCards =@InMineCards+cast(@BlockID as nvarchar(8))+','
fetch next from cr into @BlockID
end
close cr
DEALLOCATE cr
--select F1 from dbo.f_splitstr(@InMineCards,',')
--print @InMineCards
--select * from @temp
return @InMineCards
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE            function FunOutMine
(
 	@DetectTime datetime,			-- 检测时间
	@StationAddress int,			-- 基站号
	@StationHeadAddress int,		-- 探头号
	@HeadA bit,						-- 天线 A
	@HeadB bit,						-- 天线 B
	@Cards varchar(6000),
	@NowTime DateTime
)
returns varchar(6000)
as
begin

--declare @temp table(C1 varchar(100))
--declare @Cards varchar(6000)
--declare @StationAddress int
--declare @StationHeadAddress int

--set @StationAddress=9
--set @StationHeadAddress=1
--set @Cards='113,114,1314,118,123'

-- 判断这次所有从井上检测到的发码器,和上次在井下检测到的发码器,如果存在,则返回
--insert into @temp (C1)
-- 如果在上井口基站检测到人，且此人在实时下井表中出现过，那么就算此人出井
-- 其它约束: 如果检测的时间大于上一次上井口基站检测的时间 
-- 或者 上一次上井口基站检测的时间大于当前时间
declare @BlockID int
declare @InMineCards varchar(6000)
set @InMineCards=''
declare cr cursor for (
Select F1 from (select F1 from dbo.f_splitstr(@Cards,',')) as t1
inner join dbo.Station_Head_Info SHI 
On SHI.StationAddress=@StationAddress and SHI.StationHeadAddress=@StationHeadAddress
left join dbo.InMineStationInfo IMSi On IMSi.CodeSenderAddress=t1.F1
where SHI.StationHeadTypeID=8 
and (T1.F1 in (select CodeSenderAddress from dbo.RT_InOutMine))
and (@DetectTime=IMSi.InMineStationTime or IMSi.InMineStationTime>@NowTime )
)
open cr
fetch next from cr into @BlockID
while @@fetch_status = 0
begin
--print 'd'
--print @BlockID
      
        set @InMineCards =@InMineCards+cast(@BlockID as nvarchar(8))+','

fetch next from cr into @BlockID
end
close cr
DEALLOCATE cr
--select F1 from dbo.f_splitstr(@InMineCards,',')
--print @InMineCards


--select * from @temp

return @InMineCards


end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


-- 实时报警列表isAlarm大于0 报警
CREATE  function FunRTAlarm()
returns @tab table([id] int IDENTITY (1, 1),[name] varchar(30),isAlarm int)
as
begin
	-- 基站
	insert into @tab([name],isAlarm)
	select '基站故障',count(StationAddress) from Station_Info
	where StationState = -1000
	-- 超时
	insert into @tab([name],isAlarm)
	select '超时报警', count(CodeSenderAddress) from dbo.RT_OverTimeInfo
	-- 区域报警
	insert into @tab([name],isAlarm)
	select '区域报警',count(CodeSenderAddress) from RT_TerritorialInfo as rt
	left join Territorial_Info as ti on ti.TerritorialID = rt.TerritorialID
	left join Territorial_Type as tt on tt.TerritorialTypeID=ti.TerritorialTypeID
	where tt.IsAlarm = 1 and ti.IsEnable = 1
	return
end




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE       function FunRepeatString
(
  @Cards varchar(6000)
)
-- 自动将输入一个日期转化为由年 月 日 时 分 秒 毫秒 组成 的字符串 
   returns  varchar(6000)
as

begin
       --去除重复的卡和小于或等于0的卡
	Declare @TemCard nvarchar(6)
        Declare @NewCards varchar(6000) -- 新的卡
        set @NewCards=''
        -- 定义游标
	DECLARE temCardTable CURSOR FOR        
	select DISTINCT F1 from dbo.f_splitstr(@Cards,',') where F1>0
        -- 打开游标
	Open temCardTable 
        --去除重复的卡
	FETCH NEXT FROM temCardTable into @TemCard
        while @@fetch_status = 0
        begin
		set @NewCards=@NewCards+@TemCard+','
		FETCH NEXT FROM temCardTable into @TemCard
        end
       CLOSE temCardTable --关闭
       DEALLOCATE temCardTable -- 释放

    return @NewCards
end








GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE function FunTrend(@array varchar(50))
RETURNS varchar(200)
as
BEGIN
declare @where int
declare @tmpTab table([id] int,col int)

set @where = 1
	while @where<=3
	begin
		declare @tempInt int
		set @tempInt = CHARINDEX(',',@array)
		if @tempInt > 0
		begin
			insert @tmpTab values(@where,SUBSTRING(@array,0,@tempInt))
			set @array = STUFF(@array,1,@tempInt,'')
		end
		if LEN(@array) > 0 and @tempInt = 0
		begin
			insert @tmpTab values(@where,@array)
		end
		--递增
		set @where = @where +1
	end
declare @StationHeadPlace varchar(50)
declare @AntennaName varchar(50)
--探头号
declare @AntennaNo int
select @AntennaNo = col from @tmpTab where [id]=3
--1获取A探头名称
	if (@AntennaNo = 1)
	begin
		select @StationHeadPlace=StationHeadPlace,@AntennaName=AntennaA from Station_Head_Info 
		where StationAddress = (
			select col from @tmpTab where [id]=1
			) and StationHeadAddress = (
			select col from @tmpTab where [id]=2
			)
	end
	else
	begin
		select @StationHeadPlace=StationHeadPlace,@AntennaName=AntennaB from Station_Head_Info 
		where StationAddress = (
			select col from @tmpTab where [id]=1
			) and StationHeadAddress = (
			select col from @tmpTab where [id]=2
			)
	end
declare @result varchar(200)
set @result = @StationHeadPlace+' '+@AntennaName
return @result
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE function FunTrendAntenna(@array varchar(50))
RETURNS varchar(200)
as
BEGIN
declare @where int
declare @tmpTab table([id] int,col int)

set @where = 1
	while @where<=2
	begin
		declare @tempInt int
		set @tempInt = CHARINDEX(',',@array)
		if @tempInt > 0
		begin
			insert @tmpTab values(@where,SUBSTRING(@array,0,@tempInt))
			set @array = STUFF(@array,1,@tempInt,'')
		end
		if LEN(@array) > 0 and @tempInt = 0
		begin
			insert @tmpTab values(@where,@array)
		end
		--递增
		set @where = @where +1
	end
declare @StationHeadPlace varchar(50)
declare @AntennaName varchar(50)
--探头号
declare @AntennaNo int
select @AntennaNo = col from @tmpTab where [id]=3
--1获取A探头名称
	if (@AntennaNo = 1)
	begin
		select @StationHeadPlace=StationHeadPlace,@AntennaName=AntennaA from Station_Head_Info 
		where StationAddress = (
			select col from @tmpTab where [id]=1
			) and StationHeadAddress = (
			select col from @tmpTab where [id]=2
			)
	end
	else
	begin
		select @StationHeadPlace=StationHeadPlace,@AntennaName=AntennaB from Station_Head_Info 
		where StationAddress = (
			select col from @tmpTab where [id]=1
			) and StationHeadAddress = (
			select col from @tmpTab where [id]=2
			)
	end
declare @result varchar(200)
set @result = @StationHeadPlace
return @result
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE   function FunTrendInfo(@array varchar(60))
returns varchar(200)
as
begin
declare @tempInt int
set @tempInt = CHARINDEX(':',@array)
declare @d1 varchar(50),@d2 varchar(50)
set @d1 = SUBSTRING(@array,0,@tempInt)
set @d2 = SUBSTRING(@array,@tempInt+1,len(@array))
return dbo.FunTrendAntenna(@d1)+'-'+dbo.FunTrendAntenna(@d2)
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE    function FunTrendInfoAntenna(@array varchar(60))
returns varchar(200)
as
begin
declare @tempInt int
set @tempInt = CHARINDEX(':',@array)
declare @d1 varchar(50),@d2 varchar(50)
set @d1 = SUBSTRING(@array,0,@tempInt)
set @d2 = SUBSTRING(@array,@tempInt+1,len(@array))
return dbo.FunTrendAntenna(@d1)+'-'+dbo.FunTrendAntenna(@d2)
end



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO


--显示发码器配置信息
CREATE function GetCodeSenderSetInfo_Table()
returns @tab table (CsSet int,CodeSenderID int,编号 varchar(50),发码器地址 int,配置类型 varchar(30),称呼 varchar(20))
as
begin
declare cr cursor for select CsSetID,CodeSenderID,CodeSenderAddress,CsTypeID from CodeSender_Set
open cr
declare @CsSetID int
declare @CodeSenderID int
declare @CodeSenderAddress int
declare @CsTypeID int
fetch next from cr into @CsSetID,@CodeSenderID,@CodeSenderAddress,@CsTypeID
while @@fetch_status=0
begin
	if @CsTypeID = 0
	begin
		insert into @tab(CsSet,CodeSenderID,编号,发码器地址,配置类型,称呼)
		select c.CsSetID,c.CodeSenderID,ei.EmpID,c.CodeSenderAddress,
		et.Title,ei.EmpName
		from CodeSender_Set c
		left join EnumTable et On c.CsTypeID = et.EnumID and et.FunID = 3
		left join Emp_Info ei on c.UserID=ei.EmpID
		where c.CsTypeID = 0 and c.CsSetID = @CsSetID
	end
	else
	begin
		insert into @tab(CsSet,CodeSenderID,编号,发码器地址,配置类型,称呼)
		select c.CsSetID,c.CodeSenderID,ei.EquID,c.CodeSenderAddress,
		et.Title,ei.EquName
		from CodeSender_Set c
		left join EnumTable et On c.CsTypeID = et.EnumID and et.FunID = 3
		left join Equ_BaseInfo ei on c.UserID=ei.EquID
		where c.CsTypeID = 1 and c.CsSetID = @CsSetID
	end
	fetch next from cr into @CsSetID,@CodeSenderID,@CodeSenderAddress,@CsTypeID
end
close cr
deallocate cr
return
end


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--AreaDirectiona使用
create FUNCTION [dbo].[GetValue](@array varchar(50),@char varchar(1),@tmp int)
RETURNS varchar(10)
as
BEGIN 
begin
	declare @tabArray varchar(20)
	declare @tempInt int
	set @tempInt = CHARINDEX(@char,@array)
	set @tabArray =SUBSTRING(@array,0,@tempInt)
	set @array = STUFF(@array,1,@tempInt,'')
	if @tmp = 2
	begin
		return @array
	end	
	return @tabArray	
end
return ''
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  Function IsEmptyOrNull
(
	@check_expression varchar(200),
	@replacement_value varchar(200)
)
	returns varchar(200)
As
Begin
	If @check_expression = ''
	Begin
		Return @replacement_value
	End

	Return IsNull(@check_expression, @replacement_value)
End



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE     function Max_Card_Num
(
  @IDString nvarchar(20),
  @CardVaule int
)
returns  nvarchar(25)
as 
begin
declare @MaxCardNum nvarchar(25)
set @MaxCardNum=@IDString
      Set @MaxCardNum=
          case len(@CardVaule)
          when 1 then
               @MaxCardNum+'0000'+cast(@CardVaule as nvarchar(1))
          when 2 then
               @MaxCardNum+'000'+cast(@CardVaule as nvarchar(2))
          when 3 then
               @MaxCardNum+'00'+cast(@CardVaule as nvarchar(3))
          when 4 then
               @MaxCardNum+'0'+cast(@CardVaule as nvarchar(4))
          when 5 then
               @MaxCardNum+cast(@CardVaule as nvarchar(5))
          end
   return @MaxCardNum
end






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create     function Max_Card_Num_Long
(
  @IDString nvarchar(20),
  @CardVaule int
)
returns  nvarchar(25)
as 
begin
declare @MaxCardNum nvarchar(25)
set @MaxCardNum=@IDString
      Set @MaxCardNum=
          case len(@CardVaule)
          when 1 then
               @MaxCardNum+'0000'+cast(@CardVaule as nvarchar(1))
          when 2 then
               @MaxCardNum+'000'+cast(@CardVaule as nvarchar(2))
          when 3 then
               @MaxCardNum+'00'+cast(@CardVaule as nvarchar(3))
          when 4 then
               @MaxCardNum+'0'+cast(@CardVaule as nvarchar(4))
          when 5 then
               @MaxCardNum+cast(@CardVaule as nvarchar(5))
          end
   return @MaxCardNum
end






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

/******  
修改: 
日期  2007. 11.11 
功能:判断某个基站上的发码器统计
修改日期：2008-6-12
修改人：丁
功能：去除重复卡号
******/
CREATE          function StationSumCard
(
    	@csTypeID int, --类型
	@stationAddress int, -- 基站地址
        @temDate datetime -- 上井口基站的时间不能少于此时间的多少秒
)
returns bigint
as
begin

declare @SumCard bigint

set @SumCard=0


declare @IntervalTime bigint -- 间隔时间 显示主界面的上井口基站
--declare @temDate dateTime
--set @temDate=getdate()
 --and  datediff(second,rtcs.StationHeadDetectTime,@temDate)<@IntervalTime



select @IntervalTime=EnumValue FROM dbo.EnumTable
where FunID=14 and EnumID=0 
if @csTypeID=2 
	begin
		-- 人数统计
                select @SumCard=count(1) from (select DISTINCT rtcs.CodeSenderAddress from RealTimeCodeSender as rtcs
		left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
                left join dbo.Station_Head_Info SHI on SHI.StationAddress=rtcs.StationAddress 
               and SHI.StationheadAddress=rtcs.StationHeadAddress
		where rtcs.StationAddress = @stationAddress 
		and (SHI.StationHeadTypeID<>8 or (SHI.StationHeadTypeID=8 
                and datediff(second,rtcs.StationHeadDetectTime,@temDate)<@IntervalTime))
		and (rtcs.LastInStationHeadAntenna=1 or rtcs.LastInStationHeadAntenna=2)) as tmp
                 


	end
else
	begin
		-- 排除上井口基站的人数统计
                select @SumCard=count(1) from (select DISTINCT rtcs.CodeSenderAddress from RealTimeCodeSender as rtcs
		left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
                left join dbo.Station_Head_Info SHI on SHI.StationAddress=rtcs.StationAddress 
               and SHI.StationheadAddress=rtcs.StationHeadAddress
		where rtcs.StationAddress = @stationAddress 		
		and (SHI.StationHeadTypeID<>8 or (SHI.StationHeadTypeID=8 
                and datediff(second,rtcs.StationHeadDetectTime,@temDate)<@IntervalTime)) 
		and (rtcs.LastInStationHeadAntenna=1 or rtcs.LastInStationHeadAntenna=2)
                and Css.CsTypeID=@csTypeID) as tmp

	end

return @SumCard
end

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS OFF 
GO






/****** 对象:  用户定义的函数 dbo.f_splitstr    脚本日期: 2007-6-13 15:33:45 ******/
CREATE   function f_splitstr
(
  @SourceSql varchar(8000),
  @StrSeprate varchar(10)
)
returns @temp table(F1 varchar(5000))
as 
begin
  declare @i int
   set @SourceSql=rtrim(ltrim(@SourceSql))
   set @i=charindex(@StrSeprate,@SourceSql)
   while @i>=1
   begin
     insert @temp values(left(@SourceSql,@i-1))
     set @SourceSql=substring(@SourceSql,@i+1,len(@SourceSql)-@i)
     set @i=charindex(@StrSeprate,@SourceSql)
   end
   if @SourceSql<>'' 
     insert @temp values(@SourceSql)
   return 
end







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO





if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128_RealTimeEmployee_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128_RealTimeEmployee_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_CodeSender_Set_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_CodeSender_Set_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Emp_Info_NoUser_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Emp_Info_NoUser_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RealTime_CodeSender_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RealTime_CodeSender_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_BaseEmpolyee]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_BaseEmpolyee]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_CodeSender_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_CodeSender_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Dept_Info_Select_ComboBox_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Dept_Info_Select_ComboBox_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RT_InStation_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RT_InStation_Table]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE view KJ128N_BaseEmpolyee
as 
--基本人员信息视图
select I.EmpID,I.EmpNo,I.EmpName,I.Sex,N.DeptID,N.DutyID,DI.DeptName,Du.DutyName,Du.DutyClassID from Emp_Info I 
left join dbo.Emp_NowCompany N On I.EmpID=N.EmpID 
Left Join dbo.Dept_Info DI On N.DeptID=DI.DeptID
left Join Duty_Info Du On N.DutyID=Du.DutyID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE  View KJ128N_CodeSender_Info_Table
as
select c.CodeSenderID as 索引编号,c.CodeSenderID as 索引号, c.CodeSenderAddress as 发码器地址,e.Title as 发码器状态,f.Title as 是否使用,c.remark as 备注
FROM dbo.CodeSender_Info c LEFT OUTER JOIN
      dbo.EnumTable e ON c.CodeSenderStateID = e.EnumID AND 
      e.FunID = 2 LEFT OUTER JOIN
      dbo.EnumTable f ON c.IsCodeSenderUser = f.EnumID AND f.FunID = 5



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE  view KJ128N_Dept_Info_Select_ComboBox_View
as
select DeptID, DeptName from Dept_Info



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE    view KJ128N_RT_InStation_Table
as
select CodeSenderAddress as 发码器地址, StationAddress as 基站地址,
StationHeadAddress as 基站探头地址,
StationHeadAntennaA as 天线A,StationHeadAntennaB as 天线B,

StationHeadDetectTime as 进入基站时间,InStationHeadAntenna as 所在天线,
LastStationAddress as 上次基站地址,
LastStationHeadAddress as 上次基站探头地址,
LastStationHeadAntennaA as 上次基站探头天线A,
LastStationHeadAntennaB as 上次基站探头天线B,
LastInStationHeadAntenna as 上次所在天线,
LastStationHeadDetectTime as 上次基站探头检测时间,
Remark as 备注
from dbo.RT_InOutStation  a 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE       view KJ128N_CodeSender_Set_Table
as
select c.CsSetID,c.CodeSenderID,EI.EmpID as 编号,c.CodeSenderAddress as 发码器地址,
ET.Title as 配置类型,EI.EmpName as 称呼 from CodeSender_Set c
left join EnumTable ET On c.CsTypeID=ET.EnumID and ET.FunID=3
left join Emp_Info EI on c.UserID=eI.EmpID where c.CsTypeID=0



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE view KJ128N_Emp_Info_NoUser_Table
as
select empID,EmpName from Emp_info where empID not in
(
select EmpID from Emp_Info e left join CodeSender_set c on e.empId=c.userID where c.CsTypeID=0
)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO







--根据RT_InStation表中信息，取得发码器的实时信息
-- 10 25 增加 RealInAntenna
CREATE                 view KJ128N_RealTime_CodeSender_Info
as
select R.CodeSenderAddress as CodeSenderAddress,
       	c.CsSetID as CsSetID,
  	cast(R.LastStationAddress as nvarchar(4))+','  
                  +cast(R.LastStationHeadAddress as nvarchar(4))+','
                  +cast(R.LastInStationHeadAntenna as nvarchar(4))+':'
                  +cast(R.StationAddress as nvarchar(4))+','
	          +cast(R.StationHeadAddress as nvarchar(4))+','
                  +cast(R.InStationHeadAntenna as nvarchar(4))
                    as CodeSenderDirectional,
       case R.InStationHeadAntenna
            when 1 then s.StationHeadPlace+s.AntennaA
            when 2 then s.StationHeadPlace +s.AntennaB
            else s.StationHeadPlace
       end as LastPlace,
        StationHeadDetectTime,
	R.StationAddress,
	R.StationHeadAddress,
	InStationHeadAntenna,
	R.RtInOutStationId as RtInOutStationId,
        R.StationHeadAntennaA+R.StationHeadAntennaB*2 as RealInAntenna
        
        from dbo.RT_InOutStation R 
	Left join dbo.CodeSender_Set c 
                  on r.CodeSenderAddress=c.CodeSenderAddress
	left join dbo.Station_Head_Info s 
                  on r.StationAddress=s.StationAddress 
        and r.StationHeadAddress=s.StationHeadAddress






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO





CREATE    view KJ128_RealTimeEmployee_Info_Table
as
--卡号	人员编号	姓名	部门	方向性	最后一次检测地点	检测基站及探头	检测时间	持续时间

select R1.CodeSenderAddress as 发码器地址,
BE.EmpNo as 员工编号,BE.EmpName as 员工姓名,BE.DeptName as 部门名称,
CD.Directional as 目标方向,R1.LastPlace as 检测地点, R1.StationAddress as 基站号,R1.StationHeadAddress as 探头号,
R1.StationHeadDetectTime as 检测时间,
datediff(second,R1.StationHeadDetectTime,GETDATE()) as 持续时间
from dbo.RealTimeCodeSender R1
left join dbo.CodeSender_Set C1
on R1.CsSetID =C1.CsSetID 
left join KJ128N_BaseEmpolyee BE 
On C1.userID=BE.EmpID and C1.CsTypeID=0
left join dbo.CodeSender_Directional CD on R1.CodeSenderDirectional=CD.DetectionInfo 
where C1.CsTypeID=0





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Emp_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Emp_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RT_InWll_WorkType]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RT_InWll_WorkType]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_TerSet_Head_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_TerSet_Head_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_TerTypeSet_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_TerTypeSet_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_WorkType_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_WorkType_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetInWellEmpInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetInWellEmpInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetInWellEquInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetInWellEquInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEquInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEquInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTEmptyCardInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTEmptyCardInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_AllDept]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_AllDept]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Dept_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Dept_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Station_Head_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Station_Head_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_TerInfo_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_TerInfo_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetCodeSenderSetInfo_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetCodeSenderSetInfo_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetSmallEmpInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetSmallEmpInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetSmallEquInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetSmallEquInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetStation]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetStation]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Certificate_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Certificate_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_TerType_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_TerType_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Duty_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Duty_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Duty_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Duty_Info_Table]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE  VIEW dbo.KJ128N_Duty_Info
AS
SELECT DutyID AS 职务ID, DutyName AS 职务名称
FROM dbo.Duty_Info




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  VIEW dbo.KJ128N_Duty_Info_Table
AS
SELECT DutyID, DutyName AS 职务名称, DutyClassID, Remark AS 备注
FROM dbo.Duty_Info



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.KJ128N_Certificate_Info_Table
AS
SELECT CerTypeID AS 证书类别, CerName AS 证书名称, CerVestIn AS 发证机关, 
      IsCheckExpDate, Remark AS 备注
FROM dbo.Certificate_Info


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.KJ128N_TerType_Table
AS
SELECT TerritorialTypeID AS 类别编号, TypeName AS 类别名称, IsAlarm AS 是否报警, 
      Remark AS 备注
FROM dbo.Territorial_Type



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.KJ128N_AllDept
AS
SELECT dbo.Dept_Info.DeptID, dbo.Dept_Info.ParentDeptID, dbo.Dept_Info.DeptNO, 
      dbo.Dept_Info.DeptName, dbo.Dept_Info.Remark, dbo.Dept_SysSet.MaxTimeSec, 
      dbo.Dept_SysSet.MinTimeSec, dbo.Dept_Lead.EmpID, dbo.Dept_Lead.LeadDateTime, 
      dbo.Dept_Detail.DeptTel1, dbo.Dept_Detail.DeptTel2, dbo.Dept_Detail.DeptFax, 
      dbo.Dept_Detail.DeptPost, dbo.Dept_Detail.DeptAddress, dbo.Dept_Detail.DeptEmail, 
      dbo.Dept_Info.ClassID
FROM dbo.Dept_Info LEFT OUTER JOIN
      dbo.Dept_Lead ON dbo.Dept_Info.DeptID = dbo.Dept_Lead.DeptID LEFT OUTER JOIN
      dbo.Dept_SysSet ON 
      dbo.Dept_Info.DeptID = dbo.Dept_SysSet.DeptID LEFT OUTER JOIN
      dbo.Dept_Detail ON dbo.Dept_Info.DeptID = dbo.Dept_Detail.DeptID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


/*获取部门的基本信息
*/
CREATE VIEW dbo.KJ128N_Dept_Info_Table
AS
SELECT d.DeptID, d.DeptNO AS 部门编号, d.DeptName AS 部门名称, 
      Ei.EmpName AS 部门领导, ds.MaxTimeSec, ds.MinTimeSec, d.ParentDeptID, 
      d.DeptLevelID AS 部门级别, dbo.InfoClass.ClassName AS 班制名称
FROM dbo.Emp_Info Ei RIGHT OUTER JOIN
      dbo.Dept_Lead dl RIGHT OUTER JOIN
      dbo.InfoClass RIGHT OUTER JOIN
      dbo.Dept_Info d ON dbo.InfoClass.ID = d.ClassID ON dl.DeptID = d.DeptID ON 
      Ei.EmpID = dl.EmpID LEFT OUTER JOIN
      dbo.Dept_SysSet ds ON d.DeptID = ds.DeptID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  VIEW dbo.KJ128N_Station_Head_Info
AS
SELECT dbo.Station_Info.StationID, dbo.Station_Head_Info.StationHeadID, 
      dbo.Station_Info.StationAddress, dbo.Station_Head_Info.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadPlace, dbo.Station_Info.StationPlace
FROM dbo.Station_Head_Info RIGHT OUTER JOIN
      dbo.Station_Info ON 
      dbo.Station_Head_Info.StationAddress = dbo.Station_Info.StationAddress



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  VIEW dbo.KJ128N_TerInfo_Table
AS
SELECT dbo.Territorial_Info.TerritorialID AS 区域编号, 
      dbo.Territorial_Info.TerritorialName AS 区域名称, 
      dbo.Territorial_Info.TerritorialTypeID AS 区域类别编号, 
      dbo.Territorial_Type.TypeName AS 区域类别名称, 
      dbo.Territorial_Info.IsEnable AS 是否启用, 
      dbo.Territorial_Info.Instruction AS 区域介绍, 
      dbo.Territorial_Info.Remark AS 备注
FROM dbo.Territorial_Info LEFT OUTER JOIN
      dbo.Territorial_Type ON 
      dbo.Territorial_Info.TerritorialTypeID = dbo.Territorial_Type.TerritorialTypeID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view View_GetCodeSenderSetInfo_Table
as
select c.CsSetID as 索引编号,c.CsSetID as CsSet,c.CodeSenderID,c.CodeSenderAddress as 发码器地址,
et.Title as 类型,ei.EmpName as 称呼,di.DeptName as 部门名称,en.DeptID,c.CsTypeID
from CodeSender_Set c
left join EnumTable et On c.CsTypeID = et.EnumID and et.FunID = 3
left join Emp_Info ei on c.UserID=ei.EmpID
left join Emp_NowCompany en on en.EmpID = ei.EmpID
left join Dept_Info di on di.DeptID = en.DeptID
where c.CsTypeID = 0
union all
select c.CsSetID as 索引编号,c.CsSetID as CsSet,c.CodeSenderID,c.CodeSenderAddress as 发码器地址,
et.Title as 类型,ei.EquName as 称呼,di.DeptName as 部门名称,ei.DeptID,c.CsTypeID
from CodeSender_Set c
left join EnumTable et On c.CsTypeID = et.EnumID and et.FunID = 3
left join Equ_BaseInfo ei on c.UserID=ei.EquID
left join Dept_Info di on di.DeptID = ei.DeptID
where c.CsTypeID = 1


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View View_GetSmallEmpInfo
as
select ei.EmpID,ei.EmpNO,ei.EmpName,ed.OfficialDesignation
	,di.DeptName,duty.DutyName,ep.Photo,ed.BirthDay
from Emp_Info as ei
left join Emp_NowCompany as enc on enc.EmpID = ei.EmpID
left join Emp_Detail as ed on ed.EmpID = ei.EmpID
left join Emp_Photo as ep on ep.PhotoID = ed.PhotoID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Duty_Info as duty on duty.DutyID = enc.DutyID





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View View_GetSmallEquInfo
as
select ebi.EquID,ebi.EquNO,ebi.EquName,di.DeptName 
	,et.Title,fi.FactoryName,(select Title from EnumTable where EnumID = ebi.EquState
and FunID = 10) as State
from dbo.Equ_BaseInfo as ebi
left join Dept_Info as di on di.DeptID = ebi.DeptID
left join EnumTable as et on et.EnumID = ebi.EquType and et.FunID = 9
left join FactoryInfo as fi on fi.FactoryID = ebi.FactoryID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE  View View_GetStation
as
select aa.* from Station_Head_Info as aa
right join Station_Info as si on si.StationAddress = aa.StationAddress
and si.EditBaseInfo !=-1
where aa.StationAddress <> ''



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  VIEW dbo.KJ128N_Emp_Table
AS
/*SELECT dbo.Emp_Info.EmpID, dbo.Emp_Info.EmpNO AS 员工编号, 
      dbo.Emp_Info.EmpName AS 员工姓名, dbo.Dept_Info.DeptName AS 部门名称, 
      dbo.Dept_Info.DeptLevelID AS 部门级别, dbo.Duty_Info.DutyName AS 职务名称, 
      dbo.Duty_Info.DutyClassID, dbo.Emp_NowCompany.Selectmode, 
      dbo.Dept_Info.DeptID, dbo.Emp_NowCompany.MaxSecTime, 
      dbo.Emp_NowCompany.MinSecTime, dbo.Duty_Info.DutyID, 
      dbo.WorkType_Info.WtName AS 工种名称, dbo.Emp_Detail.Idcard AS 身份证编号, 
      dbo.WorkType_Info.WorkTypeID, dbo.Emp_WorkType.IsEnable
--      员工照片=case when (select count(*) From dbo.Emp_Photo where EmpID=
FROM dbo.Emp_WorkType INNER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID AND 
      dbo.Emp_WorkType.IsEnable = 1 RIGHT OUTER JOIN
      dbo.Emp_Info ON 
      dbo.Emp_WorkType.EmpID = dbo.Emp_Info.EmpID LEFT OUTER JOIN
      dbo.Emp_Detail ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Detail.EmpID LEFT OUTER JOIN
      dbo.Duty_Info RIGHT OUTER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Duty_Info.DutyID = dbo.Emp_NowCompany.DutyID LEFT OUTER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID
*/
SELECT Ei.EmpID, Ei.EmpNO AS 员工编号, Ei.EmpName AS 员工姓名, 
      Dei.DeptName AS 部门名称, Dei.DeptLevelID AS 部门级别, 
      Dui.DutyName AS 职务名称, Dui.DutyClassID, Enc.Selectmode, Dei.DeptID, 
      Enc.MaxSecTime, Enc.MinSecTime, Dui.DutyID, Wi.WtName AS 工种名称, 
      Ed.Idcard AS 身份证编号, Wi.WorkTypeID, Ewt.IsEnable, 
      员工照片 = CASE WHEN
          (SELECT COUNT(*)
         FROM dbo.Emp_Photo
         WHERE EmpID = Ei.EmpID) > 0 THEN '有' ELSE '无' END
FROM Emp_Info AS Ei LEFT JOIN
      Emp_Detail AS Ed ON Ei.EmpID = Ed.EmpID LEFT JOIN
      Emp_WorkType AS Ewt ON Ei.EmpID = Ewt.EmpID and  Ewt.IsEnable=1 LEFT JOIN
      Emp_NowCompany AS Enc ON Enc.EmpID = Ei.EmpID LEFT JOIN
      Dept_Info AS Dei ON Dei.DeptID = Enc.DeptID LEFT JOIN
      Duty_Info AS Dui ON Dui.DutyID = Enc.DutyID LEFT JOIN
      WorkType_Info AS Wi ON Wi.WorkTypeID = Ewt.WorkTypeID 



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.KJ128N_RT_InWll_WorkType
AS
SELECT dbo.WorkType_Info.WtName, dbo.Emp_Info.EmpName, dbo.Emp_Info.EmpID, 
      dbo.WorkType_Info.WorkTypeID, dbo.RT_InOutMine.StationHeadID, 
      dbo.CodeSender_Set.CsSetID, dbo.WorkType_Info.CerTypeID
FROM dbo.Emp_Info LEFT OUTER JOIN
      dbo.Emp_WorkType LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID ON 
      dbo.Emp_Info.EmpID = dbo.Emp_WorkType.EmpID RIGHT OUTER JOIN
      dbo.RT_InOutMine LEFT OUTER JOIN
      dbo.CodeSender_Set ON 
      dbo.RT_InOutMine.CsSetID = dbo.CodeSender_Set.CsSetID ON 
      dbo.Emp_Info.EmpID = dbo.CodeSender_Set.UserID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.KJ128N_TerSet_Head_Table
AS
SELECT dbo.Station_Head_Info.StationHeadID, dbo.Station_Head_Info.StationHeadPlace, 
      dbo.Station_Info.StationID, dbo.Station_Info.StationPlace, 
      dbo.Station_Info.StationAddress, dbo.Territorial_Set.TerritorialID, 
      dbo.Territorial_Set.TerritorialSetID, dbo.Station_Head_Info.StationHeadAddress
FROM dbo.Territorial_Set RIGHT OUTER JOIN
      dbo.Station_Head_Info ON 
      dbo.Territorial_Set.StationHeadID = dbo.Station_Head_Info.StationHeadID LEFT OUTER
       JOIN
      dbo.Station_Info ON 
      dbo.Station_Head_Info.StationAddress = dbo.Station_Info.StationAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


-- 修改视图
CREATE VIEW dbo.KJ128N_TerTypeSet_Table
AS
SELECT dbo.Territorial_Info.TerritorialName AS 区域名称, 
      dbo.Territorial_Type.TypeName AS 类型名称, 
      dbo.Territorial_Set.StationID AS 基站编号, 
      dbo.Station_Head_Info.StationAddress AS 基站地址, 
      dbo.Territorial_Set.StationHeadID AS 探头编号, 
      dbo.Station_Head_Info.StationHeadAddress AS 探头地址, 
      dbo.Territorial_Set.Remark AS 备注, dbo.Territorial_Set.TerritorialSetID, 
      dbo.Territorial_Type.TerritorialTypeID, dbo.Territorial_Info.TerritorialID, 
      dbo.Territorial_Set.IsTerriorialEnter AS 是否为区域口
FROM dbo.Territorial_Type RIGHT OUTER JOIN
      dbo.Territorial_Info ON 
      dbo.Territorial_Type.TerritorialTypeID = dbo.Territorial_Info.TerritorialTypeID FULL OUTER
       JOIN
      dbo.Station_Head_Info RIGHT OUTER JOIN
      dbo.Territorial_Set ON 
      dbo.Station_Head_Info.StationHeadID = dbo.Territorial_Set.StationHeadID ON 
      dbo.Territorial_Info.TerritorialID = dbo.Territorial_Set.TerritorialID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  VIEW dbo.KJ128N_WorkType_Info_Table
AS
SELECT dbo.WorkType_Info.WorkTypeID AS 工种编号, 
      dbo.WorkType_Info.WtName AS 工种名称, 
      dbo.WorkType_Info.CerTypeID AS 证书类别, 
      dbo.Certificate_Info.CerName AS 证书名称, dbo.WorkType_Info.Remark AS 备注, 
      dbo.WorkType_SysSet.MaxTimeSec, dbo.WorkType_SysSet.MinTimeSec, 
      dbo.WorkType_SysSet.WorkTypeSysSetID
FROM dbo.WorkType_Info LEFT OUTER JOIN
      dbo.Certificate_Info ON 
      dbo.WorkType_Info.CerTypeID = dbo.Certificate_Info.CerTypeID LEFT OUTER JOIN
      dbo.WorkType_SysSet ON 
      dbo.WorkType_Info.WorkTypeID = dbo.WorkType_SysSet.WorkTypeID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE   view View_GetInWellEmpInfo
as
select css.CodeSenderAddress,ei.EmpName,di.DeptName,wti.WtName,
duty.DutyName,rtim.InTime,[dbo].FunConvertTime(DATEDIFF(ss, rtim.InTime, getdate())) as sumTime,
enc.DutyID,duty.DutyClassID,wti.WorkTypeID,ed.IDCard,enc.DeptID,css.CsTypeID,ci.CerTypeID
,rtim.RtInOutMineID
from RT_InOutMine as rtim
left join CodeSender_Set as css on css.CsSetID = rtim.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join Emp_WorkType as ewt on ewt.EmpID = css.UserID and ewt.IsEnable=1
left join WorkType_Info as wti on wti.WorkTypeID = ewt.WorkTypeID
left join Duty_Info as duty on duty.DutyID = enc.DutyID
left join Emp_Detail as ed on ed.EmpID = enc.EmpID
left join Certificate_Info as ci on ci.CerTypeID = wti.CerTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE   view View_GetInWellEquInfo
as
select css.CodeSenderAddress,ebi.EquName,di.DeptName,
rtim.InTime,[dbo].FunConvertTime(DATEDIFF(ss, rtim.InTime, getdate())) as sumTime,
ebi.EquNO,ebi.DeptID,css.CsTypeID
	,edi.ProductionDate,ebi.EquType,ebi.FactoryID,rtim.RtInOutMineID
from RT_InOutMine as rtim
left join CodeSender_Set as css on css.CsSetID = rtim.CsSetID
left join Equ_BaseInfo as ebi on ebi.EquID = css.UserID
left join Dept_Info as di on di.DeptID = ebi.DeptID
left join FactoryInfo as fi on fi.FactoryID = ebi.FactoryID
left join dbo.Equ_DetailInfo as edi on edi.EquID = ebi.EquID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO









CREATE         View View_GetRTDeptEmpInfo
as
select css.CodeSenderAddress,ei.EmpName,di.DeptName,wti.WtName,duty.DutyName,
	rtcs.StationHeadDetectTime,cd.Directional,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str
(rtcs.InStationHeadAntenna)) as NowLocation
,enc.DutyID,duty.DutyClassID,wti.WorkTypeID,ed.IDCard,enc.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,ci.CerTypeID
,StationAddress,StationHeadAddress,InStationHeadAntenna
from RealTimeCodeSender as rtcs
--Inner Join RT_InOutMine RTI On RTI.CodeSenderAddress=rtcs.CodeSenderAddress
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join Emp_WorkType as ewt on ewt.EmpID = css.UserID and ewt.IsEnable=1
left join WorkType_Info as wti on wti.WorkTypeID = ewt.WorkTypeID 
left join Duty_Info as duty on duty.DutyID = enc.DutyID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
left join Emp_Detail as ed on ed.EmpID = enc.EmpID
left join Certificate_Info as ci on ci.CerTypeID = wti.CerTypeID










GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE view View_GetRTDeptEquInfo
as
select css.CodeSenderAddress,ebi.EquName,di.DeptName,rtcs.StationHeadDetectTime,cd.Directional,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str(rtcs.InStationHeadAntenna)) as NowLocation
	,ebi.EquNO,ebi.DeptID,rtcs.RTCodeSenderID,css.CsTypeID
	,edi.ProductionDate,ebi.EquType,ebi.FactoryID
from RealTimeCodeSender as rtcs
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Equ_BaseInfo as ebi on ebi.EquID = css.UserID
left join Dept_Info as di on di.DeptID = ebi.DeptID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
left join FactoryInfo as fi on fi.FactoryID = ebi.FactoryID
left join dbo.Equ_DetailInfo as edi on edi.EquID = ebi.EquID







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE   View View_GetRTEmptyCardInfo
as
select rtcs.CodeSenderAddress,
	rtcs.StationHeadDetectTime,rtcs.StationAddress,rtcs.StationHeadAddress,
	rtcs.InStationHeadAntenna,
	(select d.Directional from CodeSender_Directional as d where d.DetectionInfo=rtcs.CodeSenderDirectional) as Directional,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str(rtcs.InStationHeadAntenna)) as NowLocation
	,rtcs.RTCodeSenderID
from RealTimeCodeSender as rtcs
where rtcs.CsSetID is null



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInMine_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInMine_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RT_OverTimeInfo_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[RT_OverTimeInfo_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shen_HisInOutStationHeadInfo_zdc]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shen_HisInOutStationHeadInfo_zdc]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[shenUser_zdc]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[shenUser_zdc]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_Comm_CsEmpEqu]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_Comm_CsEmpEqu]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_Shen_AttendanceClass]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_Shen_AttendanceClass]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[shine_StationInfo_GetList]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[shine_StationInfo_GetList]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStaBreakInfo_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStaBreakInfo_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_OverTime_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_OverTime_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_Admins_UserGroups]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_Admins_UserGroups]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_UserGroup_UserGroupPower]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_UserGroup_UserGroupPower]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_His_InOutMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_His_InOutMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_His_InOutStation]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_His_InOutStation]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_His_InOutStationHead]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_His_InOutStationHead]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetAllDirectional]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetAllDirectional]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE view View_GetAllDirectional
as
select CodeSenderDirlID,dbo.FunTrendInfo(DetectionInfo) as DetectionPlace,Directional,DetectionInfo 
from CodeSender_Directional


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE     view KJ128N_HisStaBreakInfo_View
as
Select  StationAddress as 历史分站编号,  
StationHeadAddress as 历史接收器编号, 
故障类型 = case StationHeadAddress when 0 then '分站故障' else '接收器故障' end,
 StationPlace as 分站或接收器安装位置,  
BadBeginTime as 故障开始时间, 
 BadEndTime as 故障结束时间,  
dbo.FunConvertTime(BadTime) as 故障持续时间 ,
HistoryBadStationsID  
From  HistoryBadStations  

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.KJ128N_OverTime_Info
AS
SELECT CodeSenderAddress AS 发码器, UserName AS 员工姓名, DeptName AS 部门, 
      DelayedStartTime AS 开始超时时间, DelayedEndTime AS 超时结束时间, 
      dbo.FunConvertTime(DelayedTime) AS 超时时长, CsTypeID
FROM dbo.His_OverTimeAlarm


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Shine_Admins_UserGroups
AS
SELECT a.ID, a.Account, a.Password, a.IsEnable AS aIsEnable, a.IsUseEndDate, 
      a.UseEndDate, u.UGName, u.IsEnable AS uIsEnable, u.IsUseEndDate AS Expr1, 
      u.UseEndDate AS Expr2, u.UGPowerID, a.LoginTotal, a.CreateID, a.CreateDate, 
      a.CreateIP, a.FlagTag, a.Style
FROM dbo.Admins a LEFT OUTER JOIN
      dbo.UserGroups u ON u.ID = a.UserGroupID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




/****** Object:  View dbo.Shine_UserGroup_UserGroupPower    Script Date: 2007-6-13 15:33:16 ******/


/****** Object:  View dbo.Shine_UserGroup_UserGroupPower    Script Date: 2007-1-26 16:36:52 ******/
/****** Object:  View dbo.Shine_UserGroup_UserGroupPower    Script Date: 2007-1-25 12:54:51 ******/
CREATE  VIEW dbo.Shine_UserGroup_UserGroupPower
AS
SELECT C.*, U.UGPowerName AS UGPowerName
FROM dbo.UserGroups C LEFT OUTER JOIN
      dbo.UserGroupPower U ON U.ID = C.UGPowerID






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View V_His_InOutMine As Select * from His_InOutMine_1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View V_His_InOutStation As Select * from His_InOutStation_1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View V_His_InOutStationHead As Select * from His_InOutStationHead_1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  view KJ128N_Comm_CsEmpEqu
as
select CsSetID,CsTypeID,UserID,EI.empName from CodeSender_set CS
left join emp_info EI on EI.empID=CS.UserID
where CsTypeID=0

union

select CsSetID,CsTypeID,UserID,EB.EquName from CodeSender_set CS
left join Equ_BaseInfo EB on EB.EquID=CS.UserID
where CsTypeID=1







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.Shine_Shen_AttendanceClass
AS
SELECT dbo.TimerInterval.NameShort, dbo.TimerInterval.ClassID, DATEADD(minute, 
      - dbo.TimerInterval.SWFrontTime, dbo.TimerInterval.StartWorkTime) 
      AS StartWorkTime, DATEADD(minute, dbo.TimerInterval.SWAfterTime, 
      dbo.TimerInterval.StartWorkTime) AS EndWorkTime, dbo.TimerInterval.SWFrontTime, 
      dbo.TimerInterval.SWAfterTime, DATEADD(minute, - dbo.TimerInterval.EWFrontTime, 
      dbo.TimerInterval.EndWorkTime) AS EndTimeFrontTime, DATEADD(minute, 
      dbo.TimerInterval.EWAfterTime, dbo.TimerInterval.EndWorkTime) 
      AS EndTimeAfterTime, dbo.TimerInterval.EWFrontTime, 
      dbo.TimerInterval.EWAfterTime, dbo.TimerInterval.SWDateType, 
      dbo.TimerInterval.EWDateType, dbo.TimerInterval.ID AS TimerIntervalID, 
      dbo.TimerInterval.DataAttendanceType, dbo.Emp_Info.EmpName AS UserName, 
      dbo.Dept_Info.DeptID, dbo.CodeSender_Set.CodeSenderAddress AS BlockID, 
      dbo.CodeSender_Set.UserID, dbo.Dept_Info.DeptName
FROM dbo.InfoClass INNER JOIN
      dbo.TimerInterval ON dbo.InfoClass.ID = dbo.TimerInterval.ClassID INNER JOIN
      dbo.Emp_Info INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID INNER JOIN
      dbo.CodeSender_Set ON dbo.Emp_Info.EmpID = dbo.CodeSender_Set.UserID ON 
      dbo.InfoClass.ID = dbo.Dept_Info.ClassID
WHERE (dbo.CodeSender_Set.CsTypeID = 0)



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.shine_StationInfo_GetList
AS
SELECT sinfo.StationHeadID AS ID, sinfo.StationHeadID AS StationNO, 
      sinfo.StationHeadPlace AS Place, sinfo.StationHeadType AS Type, 
      einfo.Title AS State, sinfo.StationHeadX AS StationX, sinfo.StationHeadY AS StationY, 
      sinfo.StationAddress, sinfo.StationHeadAddress, sinfo.AntennaAX, sinfo.AntennaAY, 
      sinfo.AntennaBX, sinfo.AntennaBY
FROM dbo.Station_Head_Info sinfo LEFT OUTER JOIN
      dbo.EnumTable einfo ON einfo.EnumID = sinfo.StationHeadState AND einfo.FunID = 7



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE        VIEW dbo.KJ128N_HisInMine_Info_View
AS
SELECT Hi.CodeSenderAddress AS 发码器, Ei.EmpName AS 姓名, Di.DeptName AS 部门, 
      Wi.WtName AS 工种, Hi.InWellPlace AS 下井地点, Hi.InTime AS 下井时间, 
      Hi.OutWellPlace AS 上井地点, Hi.OutTime AS 上井时间, 
      dbo.FunConvertTime(Hi.ContinueTime) AS 井下时长, Et.EnumID, Ci.CerTypeID, 
      Dio.DutyID, Wi.WorkTypeID,HisInOutMineID,Idcard
FROM dbo.His_InOutMine Hi LEFT  JOIN
      dbo.Emp_Info Ei ON Ei.EmpID = Hi.UserID  LEFT  JOIN
      dbo.Emp_Detail Ed ON Ed.EmpID = Hi.UserID LEFT  JOIN
      dbo.Emp_NowCompany En ON En.EmpID = Hi.UserID LEFT  JOIN
      dbo.Dept_Info Di ON Di.DeptID = En.DeptID LEFT  JOIN
      dbo.Emp_WorkType Ew ON Ew.EmpID = Hi.UserID and Ew.IsEnable=1 LEFT  JOIN
      dbo.WorkType_Info Wi ON Wi.WorkTypeID = Ew.WorkTypeID LEFT  JOIN
      dbo.Certificate_Info Ci on Ci.CerTypeID=Wi.CerTypeID left  join
      dbo.Emp_Certificate Ec ON Ec.EmpID = Hi.UserID LEFT  JOIN
      dbo.Certificate_Info Cfi ON Cfi.CerTypeID = Ec.CerTypeID LEFT  JOIN
      dbo.Duty_Info Dio ON Dio.DutyID = En.DutyID LEFT  JOIN
      dbo.EnumTable Et ON Et.EnumID = Dio.DutyClassID and Et.FunID = 4
WHERE  Hi.CsTypeID = 0 









GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View RT_OverTimeInfo_View
as

-- 实时超时视图
--　字段说明
/*
	CodeSenderAddress	发码器地址
	CsSetID	发码器配置地址
	CsTypeID	发码器配置类型
	UserID	使用者ID
	InMineTime	下井时间
	StartOverTime	开始超时时间
*/
Select RTI.CodeSenderAddress as CodeSenderAddress, --发码器地址
       CSS.CsSetID as CsSetID,--发码器配置地址
       CSS.CsTypeID as CsTypeID,--发码器配置类型
       CSS.UserID as UserID,--使用者ID
       RTI.InTime as InMineTime,--下井时间
       dateadd(s,(Select MaxSecTime from Emp_NowCompany ENC
       where Css.UserID=ENC.empID),RTI.InTime) as StartOverTime --开始超时时间
from RT_InOutMine RTI 
left join CodeSender_Set CSS on CSS.CsSetID=RTI.CsSetID

where datediff(s,RTI.InTime,GetDate())>(Select MaxSecTime from Emp_NowCompany ENC
       where Css.UserID=ENC.empID)







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



/****** Object:  View dbo.Shen_HisInOutStationHeadInfo_zdc    Script Date: 2007-11-15 09:08:20 ******/





CREATE      view Shen_HisInOutStationHeadInfo_zdc
as

-- 卡号，卡使用者流水，卡使用者名，卡使用者类型，基站地址号，探头地址号，
-- 探头安装位置，进入探头时间，离开探头时间，探头X轴坐标，探头Y轴坐标，在探头滞留时间，部门ID,部门名称
SELECT HisSH.CodeSenderAddress BlockID, HisSH.UserID, HisSH.UserName, 
      HisSH.CsTypeID AS userType, HisSH.StationAddress, HisSH.StationHeadAddress, 
      SHI.StationHeadPlace AS StationPlace, HisSH.InStationHeadTime AS InStationTime, 
      HisSH.OutStationHeadTime AS OutStationTime, SHI.StationHeadX AS StationX, 
      SHI.StationHeadY AS StationY, datediff(s, HisSH.InStationHeadTime, 
      HisSH.OutStationHeadTime) AS StationTime, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptID
         FROM dbo.Emp_NowCompany ENC
         WHERE ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptID
         FROM dbo.Equ_BaseInfo EBI
         WHERE EBI.EquID = HisSH.UserID) END AS DeptID, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Emp_NowCompany ENC ON DI.DeptID = ENC.DeptID AND 
               ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Equ_BaseInfo EBI ON EBI.DeptID = DI.DeptID AND 
               EBI.EquID = HisSH.UserID) END AS DeptName
FROM dbo.His_InOutStationHead HisSH JOIN
      dbo.Station_Head_Info SHI ON HisSH.StationAddress = SHI.StationAddress AND 
      HisSH.StationHeadAddress = SHI.StationHeadAddress
UNION
SELECT rts.codesenderaddress AS BlockID,
          (SELECT 编号
         FROM KJ128N_CodeSender_Set_Table
         WHERE 发码器地址 = rts.codesenderaddress) AS UserID,
          (SELECT 称呼
         FROM KJ128N_CodeSender_Set_Table
         WHERE 发码器地址 = rts.codesenderaddress) AS UserName,
          (SELECT CsTypeID
         FROM CodeSender_Set
         WHERE CodeSenderAddress = rts.codesenderaddress) AS userType, 
      rts.stationaddress, rts.stationheadaddress,
          (SELECT stationheadplace
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationPlace, 
      rts.stationheaddetecttime AS InStationTime, 
      rts.stationheaddetecttime AS OutStationTime,
          (SELECT stationheadx
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationX,
          (SELECT stationheady
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationY, datediff(s, 
      rts.stationheaddetecttime, rts.stationheaddetecttime) AS StationTime, NULL 
      AS DeptID, NULL AS DeptName
FROM RealTimeCodeSender rts
WHERE rts.codesenderaddress IN
          (SELECT 发码器地址
         FROM KJ128N_CodeSender_Set_Table)





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 基站号　探头号 用户类型　用户姓名　探头安装位置　最后一次位置　状态(在天线),部门ID  部门名称  检测时间
CREATE view shenUser_zdc
as
-- CsTypeID 0 表示 员工 1 表示设备
select RTCS.StationAddress,RTCS.StationHeadAddress,Css.CsTypeID as 用户类型,
Case Css.CsTypeID
when 0 then (Select EmpName from Emp_Info EI where EI.EmpID=Css.UserID )
when 1 then (Select EquName from Equ_BaseInfo EBI where EBI.EquID=Css.UserID)
end as UserName,
SHI.StationHeadPlace as 探头安装位置,
RTCs.LastPlace as 最后一次位置,
Case RTCS.InStationHeadAntenna
When 0 then '出探头'
when 1 then 'A天线'
when 2 then 'B天线'
end as 状态,
Case Css.CsTypeID
when 0 then (Select DeptID from  Emp_NowCompany ENC where ENC.empID=Css.UserID)
when 1 then (Select DeptID from  dbo.Equ_BaseInfo EBI1 where EBI1.EquID=Css.UserID)
end as 部门ID,
Case Css.CsTypeID
when 0 then (Select DeptName  from dbo.Dept_Info DI inner join Emp_NowCompany ENC On ENC.DeptID=DI.DeptID and ENC.empID=Css.UserID)
when 1 then  (Select DeptName  from dbo.Dept_Info DI inner join Equ_BaseInfo EBI On EBI.DeptID=DI.DeptID and EBI.EquID=Css.UserID)
end as 部门名称,
RTCs.StationHeadDetectTime as 检测时间



from dbo.RealTimeCodeSender RTCS
Left join CodeSender_Set CSS On CSS.CsSetID=RTCS.CsSetID
Left join dbo.Station_Head_Info SHI On SHI.StationAddress=RTCS.StationAddress 
     and SHI.StationHeadAddress=RTCS.StationHeadAddress






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInOutMineTotal_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInOutMineTotal_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInOutMine_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInOutMine_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStationBad_Ter_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStationBad_Ter_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStationHeadBad_StationHead_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStationHeadBad_StationHead_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStationHead_Emp_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStationHead_Emp_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_His_InoutMine_Emp_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_His_InoutMine_Emp_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RTDirectional_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RTDirectional_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RTStaHeadCode_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RTStaHeadCode_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128_RealTimeEmployee_Info_Table_InMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128_RealTimeEmployee_Info_Table_InMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_RealTimeInStation_All]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_RealTimeInStation_All]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_Tmp_WorkType_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_Tmp_WorkType_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_EmployeeInfo_Detail]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_EmployeeInfo_Detail]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTCodeSenderInfoAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTCodeSenderInfoAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTCodeSenderInfoInWellAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTCodeSenderInfoInWellAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfo_InMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfo_InMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfo_InWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfo_InWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEquInfo_InMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEquInfo_InMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInOutMineEmpNameList]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInOutMineEmpNameList]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellDeptAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellDeptAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellDirectionalAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellDirectionalAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellDutyClassIDAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellDutyClassIDAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellStationHeadEmpInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellStationHeadEmpInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInOutStationHead_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInOutStationHead_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStationHead_Equ_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStationHead_Equ_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_His_InoutMine_Equ_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_His_InoutMine_Equ_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HistoryInOutAntenna_ALL_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HistoryInOutAntenna_ALL_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HistoryInOutAntenna_Equ_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HistoryInOutAntenna_Equ_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RTStaHead_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RTStaHead_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTAreaInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTAreaInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTStationHeadState]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTStationHeadState]
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_InOutStation]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_InOutStation]
GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_AlarmSet_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_AlarmSet_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInOutAntenna_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInOutAntenna_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisOverTime_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisOverTime_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisStationBad_Station_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisStationBad_Station_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HistoryInOutAntenna_Emp_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HistoryInOutAntenna_Emp_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_RTStation_Info_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_RTStation_Info_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_Tmp_Dept_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_Tmp_Dept_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetDeptEmpInWellInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetDeptEmpInWellInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetDeptEmpInWellInfo_InWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetDeptEmpInWellInfo_InWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTStationAntennaInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTStationAntennaInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTStationState]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTStationState]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HistoryInOutAntenna_Null_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HistoryInOutAntenna_Null_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[V_Tmp_Duty_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[V_Tmp_Duty_Emp]
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_InOutStation]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_InOutStation]
GO







SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_InOutStation As Select * from His_InOutStation_20081 Union All Select * from His_InOutStation_20082 Union All Select * from His_InOutStation_20083 Union All Select * from His_InOutStation_20084 Union All Select * from His_InOutStation_20085 Union All Select * from His_InOutStation_20086 Union All Select * from His_InOutStation_20087 Union All Select * from His_InOutStation_20088 Union All Select * from His_InOutStation_20089 Union All Select * from His_InOutStation_200810 Union All Select * from His_InOutStation_200811 Union All Select * from His_InOutStation_200812 Union All Select * from His_InOutStation_1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


-- 进出天线，（未登记 传入参数 CsTypeID Is Null）

CREATE  View KJ128N_HistoryInOutAntenna_Null_View

As

select  HisInStationID, CodeSenderAddress As 发码器,'未登记' As 姓名, Convert(varchar, StationAddress) +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间,StationAddress,StationHeadAddress,CsTypeID

from His_InOutStation



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.V_Tmp_Duty_Emp
AS
SELECT dbo.Duty_Info.DutyID, dbo.Duty_Info.DutyName, 
      dbo.Emp_NowCompany.EmpID
FROM dbo.Duty_Info INNER JOIN
      dbo.Emp_NowCompany ON dbo.Duty_Info.DutyID = dbo.Emp_NowCompany.DutyID






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE view KJ128N_AlarmSet_Info
as
select AlarmSetType,AlarmWaveType,AlarmWavePath,EnumValue
From AlarmSet as Als left join EnumTable as Et on Et.EnumID=Als.AlarmSetType and FunID=12



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE    VIEW KJ128N_HisInOutAntenna_Info_View
AS
Select  CodeSenderAddress As 发码器,  
Ei.EmpName As 名称,  
Convert(varchar, StationAddress) + '.' + Convert(varchar, StationHeadAddress) As 分站@接收器,  
StationHeadPlace As 接收器安装位置, 
 InStationAntenna As 所在天线,  
StationAntennaPlace As 天线地点, 
 StationHeadDetectTime As 监测时间 ,
Hi.CsTypeID , Hi.CsSetID , Hi.StationAddress ,Hi.StationHeadAddress,HisInStationID
 From  His_InOutStation As Hi  Left Join Emp_Info As Ei On Ei.EmpID = Hi.UserID 





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  VIEW dbo.KJ128N_HisOverTime_Info
AS
SELECT CodeSenderAddress AS 发码器, UserName AS 员工姓名, DeptName AS 部门, 
      DelayedStartTime AS 开始超时时间, DelayedEndTime AS 超时结束时间, 
      dbo.FunConvertTime(DelayedTime) AS 超时时长, CsTypeID,HisOverTimeAlarmID
FROM dbo.His_OverTimeAlarm



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 基站安装位置，基站类型 
-- 查询条件 基站地址号 is not null
CREATE  View  KJ128N_HisStationBad_Station_View

AS

select distinct hbs.HistoryBadStationsID, hbs.StationAddress As 基站地址号, si.StationPlace As 基站安装位置,

si.StationType ,BadBeginTime As 故障开始时间,BadEndTime As 故障结束时间,dbo.FunConvertTime(BadTime) As 持续时间 

from  dbo.HistoryBadStations hbs

left join Station_Info As si on si.StationAddress = hbs.StationAddress






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 进出天线 ，（人员 传入参数 CsTypeID = 0）

CREATE  View KJ128N_HistoryInOutAntenna_Emp_View

AS

Select  HisInStationID,CodeSenderAddress As 发码器,   Ei.EmpName As 姓名,   Convert(varchar, StationAddress)  +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间 ,StationAddress,StationHeadAddress,CsTypeID

From His_InOutStation 

Left Join Emp_Info As Ei On Ei.EmpID = His_InOutStation.UserID 




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE  view KJ128N_RTStation_Info_View
as
Select  StationAddress as 分站地址,  
StationPlace as 分站安装位置,  
StationTel as 分站联系电话,  
Et2.Title as 分站类型,  
Et1.Title as 分站状态,  
BreakTime as 分站故障时间  
From  Station_Info  as Si left join EnumTable as Et1 on Si.StationState=Et1.EnumID and Et1.FunID=7  
left join EnumTable as Et2 on Si.StationTypeID=Et2.EnumID and Et2.FunID=1  


--Order By  StationAddress 




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.V_Tmp_Dept_Emp
AS
SELECT dbo.Dept_Info.DeptID, dbo.Dept_Info.DeptName, 
      dbo.Emp_NowCompany.EmpID
FROM dbo.Dept_Info INNER JOIN
      dbo.Emp_NowCompany ON dbo.Dept_Info.DeptID = dbo.Emp_NowCompany.DeptID







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfoInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfoInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE VIEW dbo.View_GetRTDeptEmpInfoInWell
AS
SELECT css.CodeSenderAddress, ei.EmpName, di.DeptName, wti.WtName, 
      duty.DutyName, rtcs.StationHeadDetectTime, cd.Directional, 
      dbo.FunTrend(STR(rtcs.StationAddress) + ',' + STR(rtcs.StationHeadAddress) 
      + ',' + STR(rtcs.InStationHeadAntenna)) AS NowLocation, enc.DutyID, 
      duty.DutyClassID, wti.WorkTypeID, ed.Idcard, enc.DeptID, rtcs.RTCodeSenderID, 
      css.CsTypeID, ci.CerTypeID, rtcs.StationAddress, rtcs.StationHeadAddress, 
      rtcs.InStationHeadAntenna, ei.EmpID
FROM dbo.RT_InOutMine RTIO LEFT OUTER JOIN
      dbo.RealTimeCodeSender rtcs ON 
      RTIO.CodeSenderAddress = rtcs.CodeSenderAddress LEFT OUTER JOIN
      dbo.CodeSender_Set css ON css.CsSetID = rtcs.CsSetID LEFT OUTER JOIN
      dbo.Emp_NowCompany enc ON enc.EmpID = css.UserID LEFT OUTER JOIN
      dbo.Dept_Info di ON di.DeptID = enc.DeptID LEFT OUTER JOIN
      dbo.Emp_Info ei ON ei.EmpID = css.UserID LEFT OUTER JOIN
      dbo.Emp_WorkType ewt ON ewt.EmpID = css.UserID LEFT OUTER JOIN
      dbo.WorkType_Info wti ON wti.WorkTypeID = ewt.WorkTypeID LEFT OUTER JOIN
      dbo.Duty_Info duty ON duty.DutyID = enc.DutyID LEFT OUTER JOIN
      dbo.CodeSender_Directional cd ON 
      cd.DetectionInfo = rtcs.CodeSenderDirectional LEFT OUTER JOIN
      dbo.Emp_Detail ed ON ed.EmpID = enc.EmpID LEFT OUTER JOIN
      dbo.Certificate_Info ci ON ci.CerTypeID = wti.CerTypeID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




-- 部门和该部门实时下井人数
CREATE   view View_GetDeptEmpInWellInfo
as
select di.DeptID,di.DeptName,(select count(EmpName)
	 from View_GetRTDeptEmpInfoInWell where DeptID = di.DeptID) as sumCard
from dbo.Dept_Info as di




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时进出天线信息
CREATE  view View_GetRTStationAntennaInfo
as
Select CodeSenderAddress As 发码器,
StationAddress As 基站号,
StationHeadAddress As 探头号,
StationHeadDetectTime As 探头检测时间,
StationHeadAntennaA As 天线A,
StationHeadAntennaB As 天线B,
LastStationAddress As 上次基站号,
LastStationHeadAddress As 上次探头号,
LastStationHeadAntennaA As 上次天线A,
LastStationHeadAntennaB As 上次天线B
From RT_InOutStation




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO








GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE view View_GetRTStationState
as
select StationAddress as 基站地址,StationPlace as 基站位置
,StationType as 基站类型
,(select Title from EnumTable where FunID=7 and EnumValue=StationState) as 基站状态
,StationAddress as 查看
from
Station_Info 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE   VIEW dbo.KJ128N_HisInOutStationHead_Info_View
AS
SELECT Hi.CodeSenderAddress AS 发码器, Ei.EmpName AS 姓名, Di.DeptName AS 部门, 
      Dio.DutyName AS 职务名称, Hi.StationAddress AS 分站地址, 
      Hi.StationHeadAddress AS 接收器地址, Hi.StationHeadPlace AS 接收器安装位置, 
      Hi.InStationHeadTime AS 进入接收器时间, Hi.OutStationHeadTime AS 离开接收器时间, 
      dbo.FunConvertTime(DATEDIFF(ss, Hi.InStationHeadTime, Hi.OutStationHeadTime)) 
      AS 持续时间, Ed.Idcard, Ci.CerTypeID, Dio.DutyID,HisStationHeadID
FROM dbo.His_InOutStationHead Hi LEFT OUTER JOIN
      dbo.Emp_Info Ei ON Ei.EmpID = Hi.UserID LEFT OUTER JOIN
      dbo.Emp_Detail Ed ON Ed.EmpID = Hi.UserID LEFT OUTER JOIN
      dbo.Emp_NowCompany En ON En.EmpID = Hi.UserID LEFT OUTER JOIN
      dbo.Dept_Info Di ON Di.DeptID = En.DeptID LEFT OUTER JOIN
      dbo.Emp_Certificate Ec ON Ec.EmpID = Hi.UserID LEFT OUTER JOIN
      dbo.Certificate_Info Ci ON Ci.CerTypeID = Ec.CerTypeID LEFT OUTER JOIN
      dbo.Duty_Info Dio ON Dio.DutyID = En.DutyID
WHERE (Hi.CsTypeID = 0)




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 获得发码器，设备名称，部门，生产厂家，探头安装位置，进入探头时间，离开探头时间，持续时间
-- 历史进出探头信息中使用
CREATE  View KJ128N_HisStationHead_Equ_View

As

select Hi.CodeSenderAddress As 发码器,IsNull(Eb.EquName, '未知') As 设备名称, IsNull(Di.DeptName,'未知' ) As 部门,

IsNull(Fi.FactoryName,'未知') As 生产厂家,

Hi.StationHeadPlace As 探头安装位置,  Hi.InStationHeadTime As 进入探头时间,

Hi.OutStationHeadTime As 离开探头时间,  dbo.FunConvertTime(DateDiff(ss, Hi.InStationHeadTime, Hi.OutStationHeadTime)) As 持续时间

,Hi.CsTypeID,Ei.EnumID,Eb.FactoryID,Hi.HisStationHeadID,Di.DeptID

from His_InOutStationHead As Hi

left join Equ_BaseInfo As Eb on Eb.EquID = Hi.UserID
left join Dept_Info As Di on Di.DeptID = Eb.DeptID
left join FactoryInfo As Fi on Fi.FactoryID = Eb.FactoryID
left join (Select * From EnumTable where FunID = 9) as Ei On Ei.EnumID = Eb.EquType





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 设备查询 条件（CsTypeID=1）必须

CREATE View KJ128N_His_InoutMine_Equ_Info_View

As

select  Hi.CodeSenderAddress As 发码器, Eb.EquName As 设备名称,Di.DeptName As 部门,  Fi.FactoryName As 生产厂家,

Hi.InWellPlace As 下井地点,  Hi.InTime As 下井时间,  Hi.OutWellPlace As 上井地点,  Hi.OutTime As 上井时间,

dbo.FunConvertTime(Hi.ContinueTime) As 滞留时间,Hi.CsTypeID,Ei.EnumID,Fi.FactoryID,Di.DeptID,Hi.HisInOutMineID

from His_InOutMine As Hi

left join Equ_BaseInfo As Eb on Eb.EquID = Hi.UserID
left join FactoryInfo As Fi on Fi.FactoryID = Eb.FactoryID
left join Dept_Info As Di on Di.DeptID = Eb.DeptID
left join (Select * From EnumTable where FunID = 9) as Ei On Ei.EnumID = Eb.EquType






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 开始时间，结束时间，发码器，基站位置，探头位置
-- 显示所有信息

CREATE  View KJ128N_HistoryInOutAntenna_ALL_View

As

Select HisInStationID, CodeSenderAddress As 发码器,   Ei.EmpName As 姓名,   Convert(varchar, StationAddress)  +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间 ,StationAddress,StationHeadAddress

From His_InOutStation 

Left Join Emp_Info As Ei On Ei.EmpID = His_InOutStation.UserID

Where CsTypeID = 0

Union All

select HisInStationID, CodeSenderAddress As 发码器,Eb.EquName As 设备名称, Convert(varchar, StationAddress) +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间,StationAddress,StationHeadAddress

from His_InOutStation As Hi

Left join Equ_BaseInfo As Eb on Eb.EquID = UserID where Hi.CsTypeID =1

Union All


select  HisInStationID,CodeSenderAddress As 发码器,'未登记' As 姓名, Convert(varchar, StationAddress) +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间,StationAddress,StationHeadAddress

from His_InOutStation Where CsTypeID Is Null



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 进出天线，（设备 传入参数 CsTypeID = 1）

CREATE  View KJ128N_HistoryInOutAntenna_Equ_View

As

select  HisInStationID, CodeSenderAddress As 发码器,Eb.EquName As 设备名称, Convert(varchar, StationAddress) +'.' + Convert(varchar, StationHeadAddress) As 基站@探头, 

StationHeadPlace As 探头安装位置,   InStationAntenna As 所在天线,  StationAntennaPlace As 天线地点,   StationHeadDetectTime As 检测时间,StationAddress,StationHeadAddress,CsTypeID

from His_InOutStation As Hi

Left join Equ_BaseInfo As Eb on Eb.EquID = UserID





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO





CREATE     view KJ128N_RTStaHead_Info_View
as
Select  Si.StationAddress as 分站地址,  
Si.StationPlace as 分站安装位置,  
Shi.StationHeadAddress as 接收器地址,
Shi.StationHeadPlace as 接收器安装位置,
StationHeadTel as 接收器联系电话,  
Et2.Title as 接收器类型, 
接收器状态=case when Si.StationState =-1000 then '故障' when Si.StationState <>-2000 and Shi.StationHeadState=-1000 then '故障' else '正常' end,
--Et1.Title as 探头状态,  
Shi.BreakTime as 接收器故障时间  
From  Station_Head_Info  as Shi left join EnumTable as Et1 on Shi.StationHeadState=Et1.EnumID and Et1.FunID=7  
left join EnumTable as Et2 on Shi.StationHeadTypeID=Et2.EnumID and Et2.FunID=1  
left join Station_Info as Si on Si.StationAddress=Shi.StationAddress





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时区域信息
CREATE  view View_GetRTAreaInfo
as 
select rti.CodeSenderAddress,ei.EmpNO,ei.EmpName,di.DeptName
,rti.TerritorialName,rti.InTerritorialTime,rti.CsTypeID,di.DeptID
,rti.TerritorialID,ti.TerritorialTypeID,RTTerritorialID
from dbo.RT_TerritorialInfo as rti
left join .Territorial_Info as ti on ti.TerritorialID = rti.TerritorialID
left join Territorial_Type as tt on tt.TerritorialTypeID = ti.TerritorialTypeID
left join Emp_Info as ei on ei.EmpID = rti.UserID
left join Emp_NowCompany as enc on enc.EmpID = ei.EmpID
left join Dept_Info as di on di.DeptID = enc.DeptID
where rti.CsTypeID=0

union all

select CodeSenderAddress,eb.EquNO,eb.EquName,di.DeptName
,rti.TerritorialName,rti.InTerritorialTime,rti.CsTypeID,di.DeptID
,rti.TerritorialID,ti.TerritorialTypeID,RTTerritorialID
from dbo.RT_TerritorialInfo as rti
left join dbo.Territorial_Info as ti on ti.TerritorialID = rti.TerritorialID
left join dbo.Territorial_Type as tt on tt.TerritorialTypeID = ti.TerritorialTypeID
left join Equ_BaseInfo as eb on eb.EquID = rti.UserID
left join Dept_Info as di on di.DeptID = eb.DeptID
where rti.CsTypeID=1




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE view View_GetRTStationHeadState
as
select StationAddress as 基站地址,StationHeadAddress as 探头地址
,StationHeadPlace as 探头位置,StationHeadType as 探头类型
,(select Title from EnumTable where FunID=7 and EnumValue=StationHeadState) as 探头状态,StationHeadID as 查看
,StationHeadID
from 
Station_Head_Info




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE View KJ128N_HisInOutMineTotal_View

As
	
	select distinct  CodeSenderAddress As 发码器编号,UserName As 姓名,di.DeptName As 部门,duty.DutyName As 职务,wi.WtName As 工种,
	hi.InTime As 下井时间,hi.OutTime As 上井时间,dbo.FunConvertTime(hi.ContinueTime) As 滞留时间,en.DeptID,en.DutyID,ew.WorkTypeID
	from His_InOutMine hi 
	left join Emp_NowCompany en  on en.EmpID = hi.userID
	left join Dept_Info di on di.DeptID = en.DeptID
	left join Duty_Info duty on duty.DutyID = en.DutyID
	left join (select * from Emp_WorkType where IsEnable =1) ew on ew.EmpID = en.EmpID
	left join WorkType_Info wi on wi.WorkTypeID = ew.WorkTypeID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE    VIEW dbo.KJ128N_HisInOutMine_Info_View
AS
Select Distinct  Hi.CodeSenderAddress As 发码器,  
Ei.EmpName As 姓名,  
Di.DeptName As 部门,  
Wi.WtName As 工种,  
(  Select Count(*) From His_InOutMine As Hi Where Hi.UserID = Ei.EmpID And Hi.CsTypeID = 0  ) As 下井次数,  
dbo.FunConvertTime((  Select Sum(ContinueTime) From His_InOutMine As Hi Where Hi.UserID = Ei.EmpID And Hi.CsTypeID =0  )) As 下井时长  
,Hi.InTime,Ed.Idcard,Wi.WorkTypeID,Ci.CerTypeID,Dio.DutyID,Et.EnumID,HisInOutMineID

From  Emp_Info As Ei  
Left Join Emp_Detail As Ed On Ed.EmpID = Ei.EmpID 
 Left Join Emp_NowCompany As En On En.EmpID = Ei.EmpID 
 Left Join Dept_Info As Di On Di.DeptID = En.DeptID  
Left Join Emp_WorkType As Ew On Ew.EmpID = Ei.EmpID  
Left Join WorkType_Info As Wi On Wi.WorkTypeID = Ew.WorkTypeID  
Left Join Emp_Certificate As Ec On Ec.EmpID = Ei.EmpID  
Left Join Certificate_Info As Ci On Ci.CerTypeID = Ec.CerTypeID  
Left Join Duty_Info As Dio On Dio.DutyID = En.DutyID  
Left Join EnumTable As Et On Et.EnumID = Dio.DutyClassID  
Left Join His_InOutMine As Hi On Hi.UserID = Ei.EmpID  
Where  Et.FunID = 4 And Hi.CsTypeID = 0 




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 显示区域名称，区域类型，基站安装位置，基站地址号，开始故障时间，结束故障时间，持续时间
-- 查询条件 地址号 is not null 

CREATE  View KJ128N_HisStationBad_Ter_View

AS

select distinct hs.HistoryBadStationsID, hs.StationAddress AS 基站地址号,si.StationPlace As 基站安装位置,ti.TerritorialName As 区域名称,

hs.BadBeginTime AS 故障开始时间,

 hs.BadEndTime AS 故障结束时间, dbo.FunConvertTime(hs.BadTime) As 持续时间,ts.TerritorialID,ti.TerritorialTypeID

from dbo.HistoryBadStations As hs

left join Station_Info As si on si.StationAddress = hs.StationAddress

left join Territorial_Set As ts on ts.StationID = si.StationID

left join Territorial_Info As ti on ti.TerritorialID = ts.TerritorialID





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



/* 显示区域名称，区域类型，探头安装位置，探头地址号，开始故障时间，结束故障时间，持续时间
 查询条件 地址号 is not null 
*/
CREATE VIEW dbo.KJ128N_HisStationHeadBad_StationHead_View
AS
SELECT DISTINCT 
      hs.HistoryBadStationsID, hs.StationAddress AS 基站地址号, 
      hs.StationHeadAddress AS 探头地址号, si.StationHeadPlace AS 探头安装位置, 
      hs.BadBeginTime AS 故障开始时间, hs.BadEndTime AS 故障结束时间, 
      dbo.FunConvertTime(hs.BadTime) AS 持续时间, ts.TerritorialID, ti.TerritorialTypeID, 
      si.StationHeadTypeID
FROM dbo.HistoryBadStations hs LEFT OUTER JOIN
      dbo.Station_Head_Info si ON 
      si.StationHeadAddress = hs.StationHeadAddress LEFT OUTER JOIN
      dbo.Territorial_Set ts ON ts.StationHeadID = si.StationHeadID LEFT OUTER JOIN
      dbo.Territorial_Info ti ON ti.TerritorialID = ts.TerritorialID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 	获得发码器，姓名，部门，工作，探头安装位置，进入探头时间，离开探头时间，持续时间
--  查询条件FunID = 4 And CsTypeID = 0 必需的，部门，姓名，发码器，职务名称，职务等级，工作名称，证书类别，身份证选填

CREATE  View KJ128N_HisStationHead_Emp_View

AS
 
Select  Hi.CodeSenderAddress As 发码器,  Ei.EmpName As 姓名,  Di.DeptName As 部门,

Wi.WtName As 工种,  Hi.StationHeadPlace As 探头安装位置,  Hi.InStationHeadTime As 进入探头时间, 

Hi.OutStationHeadTime As 离开探头时间,  dbo.FunConvertTime(DateDiff(ss, Hi.InStationHeadTime, Hi.OutStationHeadTime)) As 持续时间

,Di.DeptName,Wi.WorkTypeID, Ci.CerTypeID,Dio.DutyID,Et.EnumID,Hi.HisStationHeadID

,Hi.CsTypeID,Et.FunID,Ed.Idcard,Di.DeptID

From  His_InOutStationHead As Hi 

Left Join Emp_Info As Ei On Ei.EmpID = Hi.UserID 
Left Join Emp_Detail As Ed On Ed.EmpID = Hi.UserID 
Left Join Emp_NowCompany As En On En.EmpID = Hi.UserID 
Left Join Dept_Info As Di On Di.DeptID = En.DeptID 
Left Join (select * from Emp_WorkType where IsEnable =1) As Ew On Ew.EmpID = Hi.UserID 
Left Join WorkType_Info As Wi On Wi.WorkTypeID = Ew.WorkTypeID 
Left Join Emp_Certificate As Ec On Ec.EmpID = Hi.UserID 
Left Join Certificate_Info As Ci On Ci.CerTypeID = Ec.CerTypeID 
Left Join Duty_Info As Dio On Dio.DutyID = En.DutyID 
Left Join EnumTable As Et On Et.EnumID = Dio.DutyClassID 






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




-- 人员查询 条件（CsTypeID =0）必须
CREATE  View KJ128N_His_InoutMine_Emp_Info_View
As

select hi.CodeSenderAddress As 发码器编号,hi.UserID,hi.UserName 姓名
			,di.DeptName As 部门,duty.DutyName As  职务,wti.WtName As 工种
			,hi.InTime As 下井时间,hi.InWellPlace As 下井地点,hi.OutTime As 上井时间,hi.OutWellPlace As 上井地点,
			dbo.FunConvertTime(ContinueTime) as 滞留时间,di.DeptID,hi.CsTypeID,duty.DutyID,ew.WorkTypeID,hi.HisInOutMineID
			from His_InOutMine as hi 
			left join CodeSender_Set as css on css.CsSetID=hi.CsSetID
			left join Emp_NowCompany as ei on ei.EmpID=css.UserID
			left join Dept_Info as di on di.DeptID = ei.DeptID
			left join Duty_Info as duty on duty.DutyID = ei.DutyID 
			left join (select * from Emp_WorkType where IsEnable = 1) as ew on ew.EmpID=css.UserID
			left join WorkType_Info as wti on wti.WorkTypeID=ew.WorkTypeID






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  view KJ128N_RTDirectional_View
as
select RtCs.CodeSenderAddress as 发码器,
	名称=case when Css.CsTypeID=0 then Ei.EmpName when Css.CsTypeID=1 then Eqi.EquName end,
	部门=case when Css.CsTypeID=0 then Di1.DeptName when Css.CsTypeID=1 then Di2.DeptName end,
	StationAddress as 基站地址,
	StationHeadAddress as 探头地址,
	Directional as 方向性描述,
	CsTypeID

From RealTimeCodeSender as RtCs left join CodeSender_Directional as CsD on CsD.DetectionInfo=RtCs.CodeSenderDirectional
	left join CodeSender_Set as Css on Css.CsSetID=RtCs.CsSetID
	left join Emp_Info as Ei on Ei.EmpID=Css.UserID and Css.CsTypeID=0
	left join Emp_NowCompany as Enc on Enc.EmpID=Ei.EmpID 
	left join Dept_Info as Di1 on Di1.DeptID=Enc.DeptID 
	left join Equ_BaseInfo as Eqi on Eqi.EquID=Css.UserID and Css.CsTypeID=1
	left join Dept_Info as Di2 on Di2.DeptID=Eqi.DeptID
Where Directional<>''



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO







CREATE      view KJ128N_RTStaHeadCode_Info
as

Select  Rcs.CodeSenderAddress as 发码器,  
	名称=case when Cs.CsTypeID=0 then Ei.EmpName when Cs.CsTypeID=1 then Ebi.EquName end,  
	配置类型= case when Cs.CsTypeID=0 then '人员' when Cs.CsTypeID=1 then '设备' end,  
	部门=case when Cs.CsTypeID=0 then Di1.DeptName when Cs.CsTypeID=1 then Di2.DeptName end,  
	--Cd.Directional as 方向性,  
	Csd.Directional as 方向性,
	StationHeadDetectTime as 监测时间 ,
	Cs.CsTypeID,
	Rcs.StationAddress,Rcs.StationHeadAddress,StationHeadDetectTime,StationHeadTypeID
From  RealTimeCodeSender as Rcs left join CodeSender_Set as Cs on Cs.CsSetID=Rcs.CsSetID  
	left join Emp_Info as Ei on Ei.EmpID=Cs.UserID and Cs.CsTypeID=0  
	left join Emp_NowCompany as Enc on Enc.EmpID=Ei.EmpID  
	left join Dept_Info as Di1 on Di1.DeptID=Enc.DeptID  
 	left join Equ_BaseInfo as Ebi on Ebi.EquID =Cs.UserID and Cs.CsTypeID=1  
	left join Dept_Info as Di2 on Di2.DeptID=Ebi.DeptID 
	left join Station_Head_Info as Shi on Shi.StationHeadAddress=Rcs.StationHeadAddress and Shi.StationAddress=Rcs.StationAddress
	Left Join RT_DirectionalAntenna as Rda on Rcs.CodeSenderAddress=Rda.CodeSenderAddress
	Left Join CodeSender_DirectionalAntenna as Csd on Csd.CodeSenderDirlID=Rda.CodeSenderDirlID








GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO






CREATE     view KJ128_RealTimeEmployee_Info_Table_InMine
as
--卡号	人员编号	姓名	部门	方向性	最后一次检测地点	检测基站及探头	检测时间	持续时间

select R1.CodeSenderAddress as 发码器地址,
BE.EmpNo as 员工编号,BE.EmpName as 员工姓名,BE.DeptName as 部门名称,
CD.Directional as 目标方向,R1.LastPlace as 检测地点, R1.StationAddress as 基站号,R1.StationHeadAddress as 探头号,
R1.StationHeadDetectTime as 检测时间,
datediff(second,R1.StationHeadDetectTime,GETDATE()) as 持续时间
from dbo.RealTimeCodeSender R1
Inner Join RT_InOutMine RTI On R1.CodeSenderAddress=RTI.CodeSenderAddress 
left join dbo.CodeSender_Set C1
on R1.CsSetID =C1.CsSetID 
left join KJ128N_BaseEmpolyee BE 
On C1.userID=BE.EmpID and C1.CsTypeID=0
left join dbo.CodeSender_Directional CD on R1.CodeSenderDirectional=CD.DetectionInfo 

where C1.CsTypeID=0






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE    View Shine_RealTimeInStation_All as 

-- 基站号　探头号 用户类型　用户姓名　探头安装位置　最后一次位置　状态(在天线),部门ID  部门名称  检测时间 方向

-- CsTypeID 0 表示 员工 1 表示设备
SELECT RTCS.CodeSenderAddress BlockID, RTCS.StationAddress, 
      RTCS.StationHeadAddress, Css.CsTypeID UserType, 
      CASE Css.CsTypeID WHEN 0 THEN
          (SELECT EmpName
         FROM Emp_Info EI
         WHERE EI.EmpID = Css.UserID) WHEN 1 THEN
          (SELECT EquName
         FROM Equ_BaseInfo EBI
         WHERE EBI.EquID = Css.UserID) END AS UserName, CSS.UserID, 
      SHI.StationHeadPlace AS Place, RTCs.LastPlace AS NewestPlace, 
      CASE RTCS.InStationHeadAntenna WHEN 0 THEN '出探头' WHEN 1 THEN 'A天线' WHEN
       2 THEN 'B天线' END AS State, CASE Css.CsTypeID WHEN 0 THEN
          (SELECT DeptID
         FROM Emp_NowCompany ENC
         WHERE ENC.empID = Css.UserID) WHEN 1 THEN
          (SELECT DeptID
         FROM dbo.Equ_BaseInfo EBI1
         WHERE EBI1.EquID = Css.UserID) END AS DeptID, 
      CASE Css.CsTypeID WHEN 0 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Emp_NowCompany ENC ON ENC.DeptID = DI.DeptID AND 
               ENC.empID = Css.UserID) WHEN 1 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Equ_BaseInfo EBI ON EBI.DeptID = DI.DeptID AND EBI.EquID = Css.UserID) 
      END AS DeptName, RTCs.StationHeadDetectTime AS StationTime, CSD.Directional, 
      RTCS.LastInStationHeadAntenna, SHI.StationHeadID
FROM dbo.RealTimeCodeSender RTCS 
INNER JOIN
      Rt_inOutMine RTIM ON RTCS.CodeSenderaddress = RTIM.CodeSenderAddress 
LEFT JOIN
      CodeSender_Set CSS ON CSS.CsSetID = RTCS.CsSetID LEFT JOIN
      dbo.Station_Head_Info SHI ON SHI.StationAddress = RTCS.StationAddress AND 
      SHI.StationHeadAddress = RTCS.StationHeadAddress LEFT JOIN
      dbo.CodeSender_Directional CSD ON 
      CSD.DetectionInfo = RTCS.CodeSenderDirectional




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE View V_Tmp_WorkType_Emp
As

SELECT WorkType_Info.WorkTypeID, WorkType_Info.WtName, 
      Emp_NowCompany.EmpID
FROM (select * from Emp_WorkType where IsEnable =1) As Emp_WorkType INNER JOIN
      WorkType_Info ON 
      Emp_WorkType.WorkTypeID = WorkType_Info.WorkTypeID INNER JOIN
      Emp_NowCompany ON 
      Emp_WorkType.EmpID = Emp_NowCompany.EmpID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.View_EmployeeInfo_Detail
AS
SELECT dbo.Emp_Info.EmpID, dbo.Emp_Info.EmpName, dbo.Emp_Info.EmpNO, 
      dbo.Emp_Info.Sex, dbo.Emp_Health.Height, dbo.Emp_Health.Weight, 
      dbo.Emp_Photo.Photo, dbo.Duty_Info.DutyName, dbo.WorkType_Info.WtName, 
      dbo.Emp_Detail.GraduateFrom, dbo.Emp_Detail.NativePlace, 
      dbo.Emp_Detail.Specialty, dbo.Emp_InCompany.ProbationDate, 
      dbo.Emp_Detail.Idcard, dbo.Dept_Info.DeptName, dbo.Emp_Detail.BirthDay, 
      dbo.Emp_Home.HomeTel1, dbo.Emp_Home.HomeAddress, dbo.Emp_Info.Remark, 
      dbo.EnuMinfo.Title
FROM dbo.Emp_Info INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID LEFT OUTER JOIN
      dbo.Emp_Photo ON dbo.Emp_Info.EmpID = dbo.Emp_Photo.EmpID LEFT OUTER JOIN
      dbo.Emp_SysSet ON 
      dbo.Emp_Info.EmpID = dbo.Emp_SysSet.EmpID LEFT OUTER JOIN
      dbo.Emp_WorkType ON 
      dbo.Emp_Info.EmpID = dbo.Emp_WorkType.EmpID LEFT OUTER JOIN
      dbo.Emp_Health ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Health.EmpID LEFT OUTER JOIN
      dbo.Emp_Detail ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Detail.EmpID LEFT OUTER JOIN
      dbo.Emp_Certificate ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Certificate.EmpID LEFT OUTER JOIN
      dbo.Duty_Info ON 
      dbo.Emp_NowCompany.DutyID = dbo.Duty_Info.DutyID LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID LEFT OUTER JOIN
      dbo.Emp_InCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_InCompany.EmpID LEFT OUTER JOIN
      dbo.Emp_Home ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Home.EmpID LEFT OUTER JOIN
      dbo.EnuMinfo ON dbo.Emp_Info.Sex = dbo.EnuMinfo.EnumID
WHERE (dbo.EnuMinfo.FunID = 44)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




-- 实时发码器信息不区分井上井下
CREATE  View View_GetRTCodeSenderInfoAll
as
select css.CodeSenderAddress,ei.EmpName,di.DeptName
,rtcs.StationHeadDetectTime
,dbo.FunConvertTime((Select DateDiff(ss, rtcs.StationHeadDetectTime, getDate()))) As 持续时间
,cd.Directional,rtcs.LastPlace as NowLocation
,enc.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,ei.EmpNO
,StationAddress,StationHeadAddress,InStationHeadAntenna
from RealTimeCodeSender as rtcs
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
where css.CsTypeID=0

union all

select css.CodeSenderAddress,equ.EquName,di.DeptName
,rtcs.StationHeadDetectTime
,dbo.FunConvertTime((Select DateDiff(ss, rtcs.StationHeadDetectTime, getDate()))) As 持续时间
,cd.Directional,rtcs.LastPlace as NowLocation
,equ.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,equ.EquNO
,StationAddress,StationHeadAddress,InStationHeadAntenna
from RealTimeCodeSender as rtcs
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Equ_BaseInfo as equ on equ.EquID = css.UserID
left join Dept_Info as di on di.DeptID = equ.DeptID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
where css.CsTypeID=1




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




--不显示井上的发码器信息 通过实时下井表提取数据
CREATE  View View_GetRTCodeSenderInfoInWellAll
as
select css.CodeSenderAddress,ei.EmpName,di.DeptName
,rtcs.StationHeadDetectTime
,dbo.FunConvertTime((Select DateDiff(ss, rtcs.StationHeadDetectTime, getDate()))) As 持续时间
,cd.Directional,rtcs.LastPlace as NowLocation
,enc.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,ei.EmpNO
,StationAddress,StationHeadAddress,InStationHeadAntenna
from dbo.RT_InOutMine as rtiom
left join RealTimeCodeSender as rtcs on rtiom.CsSetID = rtcs.CsSetID
left join CodeSender_Set as css on css.CsSetID = rtiom.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
where css.CsTypeID=0

union all

select 
css.CodeSenderAddress,equ.EquName,di.DeptName
,rtcs.StationHeadDetectTime
,dbo.FunConvertTime((Select DateDiff(ss, rtcs.StationHeadDetectTime, getDate()))) As 持续时间
,cd.Directional,rtcs.LastPlace as NowLocation
,equ.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,equ.EquNO
,StationAddress,StationHeadAddress,InStationHeadAntenna
from dbo.RT_InOutMine as rtiom
left join RealTimeCodeSender as rtcs on rtiom.CsSetID = rtcs.CsSetID
left join CodeSender_Set as css on css.CsSetID = rtiom.CsSetID
left join Equ_BaseInfo as equ on equ.EquID = css.UserID
left join Dept_Info as di on di.DeptID = equ.DeptID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
where css.CsTypeID=1




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO







CREATE       View View_GetRTDeptEmpInfo_InMine
as
select css.CodeSenderAddress as 发码器 ,ei.EmpName as 人员姓名,di.DeptName as 部门,wti.WtName as 工种 ,duty.DutyName as 职务 ,
	rtcs.StationHeadDetectTime as 监测时间 ,cd.Directional as 方向性,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str
(rtcs.InStationHeadAntenna)) as 所在地点
,enc.DutyID,duty.DutyClassID,wti.WorkTypeID,ed.IDCard,enc.DeptID,css.CsTypeID,ci.CerTypeID
--,StationAddress,StationHeadAddress,InStationHeadAntenna,rtcs.RTCodeSenderID,
from RealTimeCodeSender as rtcs
Inner join RT_InoutMine RTIM On RTCS.CodeSenderAddress=RTIM.CodeSenderAddress 
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join Emp_WorkType as ewt on ewt.EmpID = css.UserID and ewt.IsEnable=1
left join WorkType_Info as wti on wti.WorkTypeID = ewt.WorkTypeID
left join Duty_Info as duty on duty.DutyID = enc.DutyID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
left join Emp_Detail as ed on ed.EmpID = enc.EmpID
left join Certificate_Info as ci on ci.CerTypeID = wti.CerTypeID









GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfo_InWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfo_InWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO







CREATE       View View_GetRTDeptEmpInfo_InWell
as
select distinct css.CodeSenderAddress,ei.EmpName,di.DeptName,wti.WtName,duty.DutyName,
	rtcs.StationHeadDetectTime,cd.Directional,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str
(rtcs.InStationHeadAntenna)) as NowLocation
,enc.DutyID,duty.DutyClassID,wti.WorkTypeID,ed.IDCard,enc.DeptID,rtcs.RTCodeSenderID,css.CsTypeID,ci.CerTypeID
,StationAddress,StationHeadAddress,InStationHeadAntenna
from RealTimeCodeSender as rtcs
Inner join RT_InoutMine RTIM On RTCS.CodeSenderAddress=RTIM.CodeSenderAddress 
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
left join Dept_Info as di on di.DeptID = enc.DeptID
left join Emp_Info as ei on ei.EmpID = css.UserID
left join Emp_WorkType as ewt on ewt.EmpID = css.UserID and ewt.IsEnable=1
left join WorkType_Info as wti on wti.WorkTypeID = ewt.WorkTypeID
left join Duty_Info as duty on duty.DutyID = enc.DutyID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
left join Emp_Detail as ed on ed.EmpID = enc.EmpID
left join Certificate_Info as ci on ci.CerTypeID = wti.CerTypeID
where Css.CSTypeID=0








GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO
-- 部门和该部门实时下井员工人数
CREATE      view View_GetDeptEmpInWellInfo_InWell
as
select di.DeptID,di.DeptName,(select count(distinct EmpName)
	 from View_GetRTDeptEmpInfo_InWell where DeptID = di.DeptID and CSTypeID=0) as sumCard
from dbo.Dept_Info as di
where di.DeptID in ( Select distinct DeptID From Emp_NowCompany)





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO








CREATE     view View_GetRTDeptEquInfo_InMine
as
select css.CodeSenderAddress as 发码器,ebi.EquName as 设备名称,di.DeptName as 部门 ,rtcs.StationHeadDetectTime as 监测时间,cd.Directional as 方向性,
	dbo.FunTrend(str(rtcs.StationAddress)+','+str(rtcs.StationHeadAddress)+','+str
(rtcs.InStationHeadAntenna)) as 所在地点
,ebi.EquNO,ebi.DeptID,rtcs.RTCodeSenderID,css.CsTypeID
,edi.ProductionDate,ebi.EquType,ebi.FactoryID
from RealTimeCodeSender as rtcs
Inner join RT_InoutMine RTIM On RTCS.CodeSenderAddress=RTIM.CodeSenderAddress 
left join CodeSender_Set as css on css.CsSetID = rtcs.CsSetID
left join Equ_BaseInfo as ebi on ebi.EquID = css.UserID
left join Dept_Info as di on di.DeptID = ebi.DeptID
left join CodeSender_Directional as cd on cd.DetectionInfo=rtcs.CodeSenderDirectional
left join FactoryInfo as fi on fi.FactoryID = ebi.FactoryID
left join dbo.Equ_DetailInfo as edi on edi.EquID = ebi.EquID
where Css.CSTypeID=1











GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时下井人员名单 显示下井人员姓名和下井时间
CREATE  view View_GetRTInOutMineEmpNameList
as
select ei.EmpNO,ei.EmpName,rim.InTime from RT_InOutMine as rim
left join CodeSender_Set as css on rim.CsSetID=css.CsSetID
left join Emp_Info as ei on ei.EmpID = css.UserID
where css.CsTypeID=0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




-- 实时部门人数统计
CREATE     view View_GetRTInWellDeptAll
as
select * from (select di.DeptNO,di.DeptID,di.DeptName,(
SELECT count(*) as '下井总人数' FROM RT_InOutMine LEFT OUTER JOIN CodeSender_Set LEFT OUTER JOIN Emp_NowCompany LEFT OUTER JOIN Dept_Info ON Emp_NowCompany.DeptID = Dept_Info.DeptID RIGHT OUTER JOIN 
Emp_Info ON Emp_NowCompany.EmpID = Emp_Info.EmpID ON  CodeSender_Set.UserID = Emp_Info.EmpID ON  RT_InOutMine.CsSetID = CodeSender_Set.CsSetID 
where CsTypeID=0 and Dept_Info.DeptID= di.DeptID 
) as sumEmp
from Dept_Info as di) as X where sumEmp >0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时按方向性人数统计
CREATE  view View_GetRTInWellDirectionalAll
as
select csd.CodeSenderDirlID,csd.DetectionInfo,csd.Directional,
(
select count(RTCodeSenderID)
from RealTimeCodeSender where CodeSenderDirectional = csd.DetectionInfo
) as sumEmp
from CodeSender_Directional as csd




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时职务等级人数统计
CREATE  view View_GetRTInWellDutyClassIDAll
as
select et.EnumID,et.Title,
(
select count(riom.CsSetID) from dbo.RT_InOutMine as riom
left join CodeSender_Set as css on css.CsSetID=riom.CsSetID and CsTypeID=0
left join Emp_NowCompany as enc on enc.EmpID = css.UserID
where enc.DutyID = di.DutyID
) as sumEmp
from EnumTable as et
left join Duty_Info as di on di.DutyClassID = et.EnumID
where et.FunID = 4



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



-- 实时进出探头信息 人员和设备一起查出来 根据CsTypeID区分人员设备
CREATE  view View_GetRTInWellStationHeadEmpInfo
as
Select Ri.CodeSenderAddress As 发码器,Ei.EmpName As 名称,Di.DeptName As 部门,
Si.StationAddress As 基站号,Si.StationHeadAddress As 探头号,
Si.StationHeadPlace As 探头安装位置,Ri.InAntennaPlace As 所在位置,
Ri.InStationHeadTime As 进入探头时间,
dbo.FunConvertTime((Select DateDiff(ss, Ri.InStationHeadTime, getDate()))) As 持续时间,
Ei.EmpNO,Di.DeptID,
Si.StationAddress,Si.StationHeadAddress,Ri.InStationHeadTime,Ri.CsTypeID
From RT_InStationHeadInfo As Ri
Left Join Emp_Info As Ei On Ei.EmpID = Ri.UserID
Left Join Emp_NowCompany As En On En.EmpID = Ri.UserID
Left Join Dept_Info As Di On Di.DeptID = En.DeptID
Left Join Station_Head_Info As Si On Si.StationHeadID = Ri.StationHeadID
where Ri.CsTypeID = 0

UNION all

Select Ri.CodeSenderAddress As 发码器,Ei.EquName As 名称,Di.DeptName As 部门,
Si.StationAddress As 基站号,Si.StationHeadAddress As 探头号,
Si.StationHeadPlace As 探头安装位置,Ri.InAntennaPlace As 所在位置,
Ri.InStationHeadTime As 进入探头时间,
dbo.FunConvertTime((Select DateDiff(ss, Ri.InStationHeadTime, getDate()))) As 持续时间,
Ei.EquNO,Di.DeptID,
Si.StationAddress,Si.StationHeadAddress,Ri.InStationHeadTime,Ri.CsTypeID
From RT_InStationHeadInfo As Ri
Left Join Equ_BaseInfo As Ei On Ei.EquID = Ri.UserID
Left Join Dept_Info As Di On Di.DeptID = Ei.DeptID
Left Join Station_Head_Info As Si On Si.StationHeadID = Ri.StationHeadID
where Ri.CsTypeID = 1




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTDeptEmpInfoInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTDeptEmpInfoInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellDutyIDAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellDutyIDAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetRTInWellWorkTypeAll]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetRTInWellWorkTypeAll]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInTer_Equ_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInTer_Equ_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_InOutTerr_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_InOutTerr_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisInTer_Emp_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisInTer_Emp_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[KJ128N_HisOverTime_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[KJ128N_HisOverTime_View]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO





CREATE  VIEW dbo.KJ128N_HisInTer_Emp_Info
AS
SELECT Hi.CodeSenderAddress AS 发码器, Ei.EmpName AS 员工姓名, 
      Di.DeptName AS 部门名称, Hi.TerritorialTypeName AS 区域类别, 
      Hi.TerritorialName AS 区域名称, Hi.InTerritorialTime AS 进入区域时间, 
      Hi.OutTerritorialTime AS 离开区域时间, dbo.FunConvertTime(DATEDIFF(s, 
      Hi.InTerritorialTime, Hi.OutTerritorialTime)) AS 持续时长, Hi.CsTypeID,
      HisTerritorialID
FROM dbo.His_InOutTerritorial Hi LEFT OUTER JOIN
      dbo.Emp_Info Ei ON Ei.EmpID = Hi.UserID LEFT OUTER JOIN
      dbo.Emp_NowCompany En ON Ei.EmpID = En.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Di ON En.DeptID = Di.DeptID where DATEDIFF(s, 
      Hi.InTerritorialTime, Hi.OutTerritorialTime)>0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE VIEW dbo.KJ128N_HisOverTime_View
AS
SELECT H_OverTime.CodeSenderAddress AS 发码器编号, 
      H_OverTime.UserName AS 姓名, H_OverTime.DelayedStartTime AS 超时开始时间, 
      H_OverTime.DelayedEndTime AS 超时结束时间, 
      dbo.FunConvertTime(H_OverTime.DelayedTime) AS 持续时间, en.DeptID, 
      H_OverTime.CsTypeID, H_OverTime.HisOverTimeAlarmID
FROM dbo.His_OverTimeAlarm H_OverTime LEFT OUTER JOIN
      dbo.Emp_Info ei ON ei.EmpID = H_OverTime.UserID LEFT OUTER JOIN
      dbo.Emp_NowCompany en ON en.EmpID = ei.EmpID LEFT OUTER JOIN
      dbo.Dept_Info di ON di.DeptID = en.DeptID
WHERE (DATEDIFF(ss, H_OverTime.DelayedStartTime, H_OverTime.DelayedEndTime) > 0)



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO






CREATE  VIEW dbo.KJ128N_HisInTer_Equ_Info
AS
SELECT Hi.CodeSenderAddress AS 发码器, Eb.EquName AS 设备名称, 
      Di.DeptName AS 所属部门, Hi.TerritorialTypeName AS 区域类别, 
      Hi.TerritorialName AS 区域名称, Hi.InTerritorialTime AS 进入区域时间, 
      Hi.OutTerritorialTime AS 离开区域时间, dbo.FunConvertTime(DATEDIFF(s, 
      Hi.InTerritorialTime, Hi.OutTerritorialTime)) AS 持续时长, Hi.CsTypeID,
      HisTerritorialID
FROM dbo.His_InOutTerritorial Hi LEFT OUTER JOIN
      dbo.Equ_BaseInfo Eb ON Hi.UserID = Eb.EquID LEFT OUTER JOIN
      dbo.Dept_Info Di ON Eb.DeptID = Di.DeptID where DATEDIFF(s, 
      Hi.InTerritorialTime, Hi.OutTerritorialTime)>0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.KJ128N_InOutTerr_View
AS
SELECT ht.CodeSenderAddress AS 发码器编号, ht.UserName AS 姓名, 
      ht.TerritorialName AS 区域名称, ht.InTerritorialTime AS 进入区域时间, 
      ht.OutTerritorialTime AS 离开区域时间, dbo.FunConvertTime(DATEDIFF(ss, 
      ht.InTerritorialTime, ht.OutTerritorialTime)) AS 滞留时间, ht.HisTerritorialID, 
      ti.TerritorialTypeID, ht.CsTypeID
FROM dbo.His_InOutTerritorial ht LEFT OUTER JOIN
      dbo.Territorial_Info ti ON ti.TerritorialID = ht.TerritorialID
WHERE (DATEDIFF(ss, ht.InTerritorialTime, ht.OutTerritorialTime) > 0)



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE VIEW dbo.View_GetRTDeptEmpInfoInWell
AS
SELECT css.CodeSenderAddress, ei.EmpName, di.DeptName, wti.WtName, 
      duty.DutyName, rtcs.StationHeadDetectTime, cd.Directional, 
      dbo.FunTrend(STR(rtcs.StationAddress) + ',' + STR(rtcs.StationHeadAddress) 
      + ',' + STR(rtcs.InStationHeadAntenna)) AS NowLocation, enc.DutyID, 
      duty.DutyClassID, wti.WorkTypeID, ed.Idcard, enc.DeptID, rtcs.RTCodeSenderID, 
      css.CsTypeID, ci.CerTypeID, rtcs.StationAddress, rtcs.StationHeadAddress, 
      rtcs.InStationHeadAntenna, ei.EmpID
FROM dbo.RT_InOutMine RTIO LEFT OUTER JOIN
      dbo.RealTimeCodeSender rtcs ON 
      RTIO.CodeSenderAddress = rtcs.CodeSenderAddress LEFT OUTER JOIN
      dbo.CodeSender_Set css ON css.CsSetID = rtcs.CsSetID LEFT OUTER JOIN
      dbo.Emp_NowCompany enc ON enc.EmpID = css.UserID LEFT OUTER JOIN
      dbo.Dept_Info di ON di.DeptID = enc.DeptID LEFT OUTER JOIN
      dbo.Emp_Info ei ON ei.EmpID = css.UserID LEFT OUTER JOIN
      dbo.Emp_WorkType ewt ON ewt.EmpID = css.UserID LEFT OUTER JOIN
      dbo.WorkType_Info wti ON wti.WorkTypeID = ewt.WorkTypeID LEFT OUTER JOIN
      dbo.Duty_Info duty ON duty.DutyID = enc.DutyID LEFT OUTER JOIN
      dbo.CodeSender_Directional cd ON 
      cd.DetectionInfo = rtcs.CodeSenderDirectional LEFT OUTER JOIN
      dbo.Emp_Detail ed ON ed.EmpID = enc.EmpID LEFT OUTER JOIN
      dbo.Certificate_Info ci ON ci.CerTypeID = wti.CerTypeID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO





CREATE       view View_GetRTInWellDutyIDAll
as

select Count(CodeSenderAddress) 'sumEmp',DutyID,case when DutyName is null then '未配置' else DutyName end 'DutyName' from (select rti.CodeSenderAddress,di.DutyName,di.DutyID from RT_InOutMine rti left join CodeSender_Set css on rti.CodeSenderAddress = css.CodeSenderAddress left join  Emp_NowCompany En on css.UserID = En.EmpID left join Duty_Info di on En.DutyID = di.DutyID where css.CSTypeID = 0) as A group by DutyName,DutyID







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE     view View_GetRTInWellWorkTypeAll
as


select count(CodeSenderAddress) 'sumEmp',WorkTypeID,WtName=case when WtName is null then '未配置' else WtName end From (select rti.CodeSenderAddress,wi.WorkTypeID,wi.WtName From RT_InOutMine rti left join CodeSender_Set css on rti.CodeSenderAddress = css.CodeSenderAddress
left join Emp_WorkType ewt on ewt.EmpID=css.UserID and css.CsTypeID=0
left join WorkType_Info wi on wi.WorkTypeID=ewt.WorkTypeID
where css.CsTypeID=0) as A group by WorkTypeID,WtName





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeTerrialAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeTerrialAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeTerrialAlarm_Employees]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeTerrialAlarm_Employees]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[zjw_RT_EmpHelp_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[zjw_RT_EmpHelp_View]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_SpecialWorkTypeTerrialSet]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_SpecialWorkTypeTerrialSet]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[view_HistoryInOutTerrialAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[view_HistoryInOutTerrialAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_His_OverEmployees]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_His_OverEmployees]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[zjw_HisEmpHelp_View]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[zjw_HisEmpHelp_View]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



--历史超员
create  view View_His_OverEmployees
as
SELECT His_OverEmployeeID, His_OverEmployeeTypeID,His_RatingEmployeesCount,
His_FactEmployeeCount,(His_FactEmployeeCount-His_RatingEmployeesCount) as His_OverEmpCount
,His_OverEmployeeBeginTime,His_OverEmployeeEndTime,
dbo.FunConvertTime( DATEDIFF(ss,His_OverEmployeeBeginTime, His_OverEmployeeEndTime)) as OverEmpAbidanceTime
FROM His_OverEmployees
where His_OverEmployeeEndTime is not null


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE view zjw_HisEmpHelp_View
as

--历史求救信息视图

select  StationAddress as 分站编号,StationPlace as 分站安装位置,StationHeadAddress as 接收器编号,StationHeadPlace as 接收器安装位置,CodeSenderAddress as 发码器编号,
	EmpName as 姓名, DeptName as 部门, DutyName as 职务,WtName as 工种,Measure as  救援措施, BeginDateTime as 求救开始时间,EndDateTime as 求救结束时间,
	dbo.FunConvertTime(DateDiff(ss, Hi.BeginDateTime, Hi.EndDateTime)) As 求救持续时间,HisEmpHelpID
from His_EmpHelp as Hi





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  VIEW dbo.View_SpecialWorkTypeTerrialSet
AS
SELECT  dbo.CodeSender_Set.CodeSenderAddress, dbo.Emp_Info.EmpName, 
      dbo.Territorial_Info.TerritorialName, dbo.Territorial_Type.TypeName, 
      dbo.WorkType_Info.WtName, dbo.SpecialWorkTypeTerrialSet.IsAlarm, 
      dbo.SpecialWorkTypeTerrialSet.TerriAlarmID, dbo.Territorial_Info.TerritorialID, 
      dbo.Territorial_Type.TerritorialTypeID, dbo.WorkType_Info.WorkTypeID
FROM dbo.SpecialWorkTypeTerrialSet LEFT  JOIN
      dbo.Emp_Info ON 
      dbo.SpecialWorkTypeTerrialSet.EmployeeID = dbo.Emp_Info.EmpID 
 LEFT 
       JOIN
      dbo.CodeSender_Set ON dbo.Emp_Info.EmpID = dbo.CodeSender_Set.UserID
 left JOIN
      dbo.Territorial_Info ON 
      dbo.SpecialWorkTypeTerrialSet.TerrialID = dbo.Territorial_Info.TerritorialID LEFT  JOIN
      dbo.Territorial_Type ON 
      dbo.Territorial_Info.TerritorialTypeID = dbo.Territorial_Type.TerritorialTypeID 
     LEFT 
       JOIN
      dbo.WorkType_Info ON 
      dbo.SpecialWorkTypeTerrialSet.WorkTypeID = dbo.WorkType_Info.WorkTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE     VIEW dbo.view_HistoryInOutTerrialAlarm
AS
SELECT distinct dbo.His_InOutTerritorial.HisTerritorialID, 
      dbo.His_InOutTerritorial.CodeSenderAddress, dbo.His_InOutTerritorial.UserName, 
      dbo.WorkType_Info.WtName, dbo.His_InOutTerritorial.TerritorialTypeName, 
      dbo.His_InOutTerritorial.TerritorialName, dbo.His_InOutTerritorial.InTerritorialTime, 
      dbo.His_InOutTerritorial.OutTerritorialTime, dbo.FunConvertTime(DATEDIFF(second, 
      dbo.His_InOutTerritorial.InTerritorialTime, dbo.His_InOutTerritorial.OutTerritorialTime)) 
      AS StayTime, dbo.SpecialWorkTypeTerrialSet.WorkTypeID, 
      dbo.SpecialWorkTypeTerrialSet.TerrialID, dbo.Territorial_Info.TerritorialTypeID, 
      dbo.His_InOutTerritorial.TerritorialID
FROM dbo.His_InOutTerritorial INNER JOIN
      dbo.SpecialWorkTypeTerrialSet ON 
      dbo.SpecialWorkTypeTerrialSet.EmployeeID = dbo.His_InOutTerritorial.UserID INNER
       JOIN
      dbo.WorkType_Info ON 
      dbo.WorkType_Info.WorkTypeID = dbo.SpecialWorkTypeTerrialSet.WorkTypeID INNER
       JOIN
      dbo.Territorial_Info ON 
      dbo.His_InOutTerritorial.TerritorialID = dbo.Territorial_Info.TerritorialID INNER JOIN
      dbo.Territorial_Type ON 
      dbo.Territorial_Info.TerritorialTypeID = dbo.Territorial_Type.TerritorialTypeID
WHERE (dbo.His_InOutTerritorial.CsTypeID = 0) AND (dbo.His_InOutTerritorial.IsAlarm = 1)




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


/*实时区域报警信息视图*/
CREATE   VIEW dbo.View_RealTimeTerrialAlarm
AS
SELECT  dbo.Emp_Info.EmpName, dbo.RT_TerritorialInfo.CodeSenderAddress, 
      dbo.WorkType_Info.WtName, dbo.RT_TerritorialInfo.InTerritorialTime, 
      dbo.RT_TerritorialInfo.IsAlarm, dbo.RT_TerritorialInfo.TerritorialName, 
      dbo.RT_TerritorialInfo.TerritorialTypeName, dbo.RT_TerritorialInfo.RTTerritorialID, 
      dbo.SpecialWorkTypeTerrialSet.WorkTypeID, dbo.SpecialWorkTypeTerrialSet.TerrialID, 
      dbo.Territorial_Type.TerritorialTypeID, dbo.RT_TerritorialInfo.TerritorialID
FROM dbo.RT_TerritorialInfo left JOIN
      dbo.Emp_Info ON dbo.RT_TerritorialInfo.UserID = dbo.Emp_Info.EmpID left JOIN
      dbo.SpecialWorkTypeTerrialSet ON 
      dbo.RT_TerritorialInfo.UserID = dbo.SpecialWorkTypeTerrialSet.EmployeeID left
       JOIN
      dbo.WorkType_Info ON 
      dbo.SpecialWorkTypeTerrialSet.WorkTypeID = dbo.WorkType_Info.WorkTypeID left
       JOIN
      dbo.Territorial_Info ON 
      dbo.RT_TerritorialInfo.TerritorialID = dbo.Territorial_Info.TerritorialID left JOIN
      dbo.Territorial_Type ON 
      dbo.Territorial_Info.TerritorialTypeID = dbo.Territorial_Type.TerritorialTypeID where dbo.WorkType_Info.WtName is not null





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.View_RealTimeTerrialAlarm_Employees
AS
SELECT DISTINCT 
      dbo.Station_Head_Info.StationAddress, dbo.Station_Head_Info.StationHeadAddress, 
      dbo.SpecialWorkTypeTerrialSet.IsAlarm, dbo.CodeSender_Set.UserID, 
      dbo.CodeSender_Set.CodeSenderAddress, 
      dbo.SpecialWorkTypeTerrialSet.TerrialID
FROM dbo.SpecialWorkTypeTerrialSet LEFT OUTER JOIN
      dbo.CodeSender_Set ON 
      dbo.CodeSender_Set.UserID = dbo.SpecialWorkTypeTerrialSet.EmployeeID LEFT OUTER
       JOIN
      dbo.Territorial_Set ON 
      dbo.SpecialWorkTypeTerrialSet.TerrialID = dbo.Territorial_Set.TerritorialID LEFT OUTER
       JOIN
      dbo.Station_Head_Info ON 
      dbo.Station_Head_Info.StationHeadID = dbo.Station_Head_Info.StationHeadID
WHERE (dbo.SpecialWorkTypeTerrialSet.IsAlarm = 1) AND 
      (dbo.Station_Head_Info.StationHeadID IN
          (SELECT StationHeadID
         FROM dbo.Territorial_Set))


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE view zjw_RT_EmpHelp_View
as
--查询实时求救信息视图
select Si.StationAddress as 分站编号,Si.StationPlace as 分站安装位置,Shi.StationHeadAddress as 接收器编号,Shi.StationHeadPlace as 接收器安装位置,
	Reh.CodeSenderAddress as 发码器编号,Ei.EmpName as 姓名,Dei.DeptName as 部门,Wti.WtName as 工种,Dui.DutyName as 职务,
	Measure as 救援措施 ,BeginDateTime as 求救开始时间,Ei.EmpID
From RT_EmpHelp as Reh left join dbo.Emp_Info as Ei on Reh.EmpID = Ei.EmpID
left join dbo.Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
left join dbo.Dept_Info as Dei on Enc.DeptID=Dei.DeptID
left join dbo.Duty_Info as Dui on Enc.DutyID = Dui.DutyID
left join dbo.Emp_WorkType as Ewt on Ei.EmpID = Ewt.EmpID and Ewt.IsEnable=1
left join dbo.WorkType_Info as Wti on Ewt.WorkTypeID = Wti.WorkTypeID
left join dbo.Station_Info as Si on Reh.StationAddress=Si.StationAddress
left join dbo.Station_Head_Info as Shi on Reh.StationAddress=Shi.StationAddress and Reh.StationHeadAddress=Shi.StationHeadAddress




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[view_RT_InOutMineEmpNameList]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[view_RT_InOutMineEmpNameList]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_HistoryWalkInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_HistoryWalkInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeWalkAlarmInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeWalkAlarmInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeWalkInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeWalkInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_WalkConfigInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_WalkConfigInfo]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--历史行走异常报警信息
create view View_HistoryWalkInfo
as

select hwi.* ,
	shi1.StationHeadPlace as firstPlace,
	shi2.StationHeadPlace as middlePlace,
	shi3.StationHeadPlace as lastPlace
	--enc.DeptId,
	--Dei.DeptName,
	--Css.CodeSenderAddress
	from HistoryWalkInfo as hwi

--	left join Emp_Info ei on ei.EmpId = hwi.EmpId 

	left join Station_Head_Info shi1 on shi1.StationAddress = hwi.FirstStationAddress 
		and shi1.StationHeadAddress = hwi.FirstStationHeadAddress 

	left join Station_Head_Info shi2 on shi2.StationAddress = hwi.MiddleStationAddress 
		and shi2.StationHeadAddress = hwi.MiddleStationHeadAddress 

	left join Station_Head_Info shi3 on shi3.StationAddress = hwi.LastStationAddress 
		and shi3.StationHeadAddress = hwi.LastStationHeadAddress

	--left join Emp_NowCompany enc on enc.EmpId = hwi.EmpId 
	--left join Dept_Info as Dei on enc.DeptID=Dei.DeptId
	--left join CodeSender_Set as Css on ei.EmpID=Css.UserID and Css.CsTypeID=0

	--where Css.CsTypeID=0

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

/*实时行走异常报警信息*/
CREATE VIEW dbo.View_RealTimeWalkAlarmInfo
AS
SELECT     rtwi.RealTimeWalkId AS id, rtwi.EmpID, rtwi.FirstStationAddress, rtwi.FirstStationHeadAddress, rtwi.FirstStationHeadAntennaA, 
                      rtwi.FirstStationHeadAntennaB, rtwi.FirstArriveTime, rtwi.MiddleStationAddress, rtwi.MiddleStationHeadAddress, rtwi.MiddleStationHeadAntennaA, 
                      rtwi.MiddleStationHeadAntennaB, rtwi.MiddleArriveTime, rtwi.LastStationAddress, rtwi.LastStationHeadAddress, rtwi.LastStationHeadAntennaA, 
                      rtwi.LastStationHeadAntennaB, rtwi.LastArriveTime, rtwi.IsAlarm, rtwi.Measure, ei.EmpName, shi1.StationHeadPlace AS firstPlace, 
                      shi2.StationHeadPlace AS middlePlace, shi3.StationHeadPlace AS lastPlace, enc.DeptID, Dei.DeptName, Css.CodeSenderAddress
FROM         dbo.RealTimeWalkInfo AS rtwi LEFT OUTER JOIN
                      dbo.Emp_Info AS ei ON ei.EmpID = rtwi.EmpID LEFT OUTER JOIN
                      dbo.Station_Head_Info AS shi1 ON shi1.StationAddress = rtwi.FirstStationAddress AND 
                      shi1.StationHeadAddress = rtwi.FirstStationHeadAddress LEFT OUTER JOIN
                      dbo.Station_Head_Info AS shi2 ON shi2.StationAddress = rtwi.MiddleStationAddress AND 
                      shi2.StationHeadAddress = rtwi.MiddleStationHeadAddress LEFT OUTER JOIN
                      dbo.Station_Head_Info AS shi3 ON shi3.StationAddress = rtwi.LastStationAddress AND 
                      shi3.StationHeadAddress = rtwi.LastStationHeadAddress LEFT OUTER JOIN
                      dbo.Emp_NowCompany AS enc ON enc.EmpID = rtwi.EmpID LEFT OUTER JOIN
                      dbo.Dept_Info AS Dei ON enc.DeptID = Dei.DeptID LEFT OUTER JOIN
                      dbo.CodeSender_Set AS Css ON ei.EmpID = Css.UserID AND Css.CsTypeID = 0
WHERE     (Css.CsTypeID = 0) AND (rtwi.IsAlarm = 1)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view View_RealTimeWalkInfo
as

select rtwi.* ,ei.EmpName,
	shi1.StationHeadPlace as firstPlace,
	shi2.StationHeadPlace as middlePlace,
	shi3.StationHeadPlace as lastPlace,
	enc.DeptId,
	Dei.DeptName,
	Css.CodeSenderAddress
	from RealTimeWalkInfo as rtwi

	left join Emp_Info ei on ei.EmpId = rtwi.EmpId 

	left join Station_Head_Info shi1 on shi1.StationAddress = rtwi.FirstStationAddress 
		and shi1.StationHeadAddress = rtwi.FirstStationHeadAddress 

	left join Station_Head_Info shi2 on shi2.StationAddress = rtwi.MiddleStationAddress 
		and shi2.StationHeadAddress = rtwi.MiddleStationHeadAddress 

	left join Station_Head_Info shi3 on shi3.StationAddress = rtwi.LastStationAddress 
		and shi3.StationHeadAddress = rtwi.LastStationHeadAddress

	left join Emp_NowCompany enc on enc.EmpId = rtwi.EmpId 
	left join Dept_Info as Dei on enc.DeptID=Dei.DeptId
	left join CodeSender_Set as Css on ei.EmpID=Css.UserID and Css.CsTypeID=0

	where Css.CsTypeID=0



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--视图查询行走异常配置信息
CREATE view View_WalkConfigInfo 
as

select wci.* ,ei.EmpName,
	shi1.StationHeadPlace as firstPlace,
	shi2.StationHeadPlace as middlePlace,
	shi3.StationHeadPlace as lastPlace,
	enc.DeptId,
	Dei.DeptName,
	Css.CodeSenderAddress
	from WalkConfigInfo as wci

	left join Emp_Info ei on ei.EmpId = wci.EmpId 

	left join Station_Head_Info shi1 on shi1.StationAddress = wci.FirstStationAddress 
		and shi1.StationHeadAddress = wci.FirstStationHeadAddress 

	left join Station_Head_Info shi2 on shi2.StationAddress = wci.MiddleStationAddress 
		and shi2.StationHeadAddress = wci.MiddleStationHeadAddress 

	left join Station_Head_Info shi3 on shi3.StationAddress = wci.LastStationAddress 
		and shi3.StationHeadAddress = wci.LastStationHeadAddress

	left join Emp_NowCompany enc on enc.EmpId = wci.EmpId 
	left join Dept_Info as Dei on enc.DeptID=Dei.DeptId
	left join CodeSender_Set as Css on ei.EmpID=Css.UserID and Css.CsTypeID=0

	where Css.CsTypeID=0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.view_RT_InOutMineEmpNameList
AS
SELECT     a.InTime AS 入井时间, c.EmpID AS 员工ID, c.EmpName AS 员工姓名, c.Sex AS 员工性别, e.DeptName AS 员工部门, e.DeptID AS 部门ID, 
                      e.ParentDeptID AS 父部门ID, f.DutyID AS 职务ID, f.DutyClassID AS 职务类型, f.DutyName AS 职务名
FROM         dbo.RT_InOutMine AS a LEFT OUTER JOIN
                      dbo.CodeSender_Set AS b ON a.CsSetID = b.CsSetID LEFT OUTER JOIN
                      dbo.Emp_Info AS c ON b.UserID = c.EmpID LEFT OUTER JOIN
                      dbo.Emp_NowCompany AS d ON c.EmpID = d.EmpID LEFT OUTER JOIN
                      dbo.Dept_Info AS e ON d.DeptID = e.DeptID LEFT OUTER JOIN
                      dbo.Duty_Info AS f ON d.DutyID = f.DutyID
WHERE     (b.CsTypeID = 0)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_Emp_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_Emp_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_His_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_His_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RT_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RT_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[zjw_RtAndHisInOutMine]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[zjw_RtAndHisInOutMine]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[InOutClimeTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[InOutClimeTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[InOutConfineAreaTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[InOutConfineAreaTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[InOutKeyAreaTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[InOutKeyAreaTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimePostInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimePostInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_SelectRealTimePostInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_SelectRealTimePostInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[kj128_his_station_head_time_view_txj]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[kj128_his_station_head_time_view_txj]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_AreaDirection]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_AreaDirection]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_Directional]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_Directional]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_InOutReceiver]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_InOutReceiver]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_GetAllDirectionalAntenna]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_GetAllDirectionalAntenna]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_HistoryPostInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_HistoryPostInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_SelectHistoryPostInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_SelectHistoryPostInfo]
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_AreaDirection As Select * from His_AreaDirection_20081 Union All Select * from His_AreaDirection_20082 Union All Select * from His_AreaDirection_20083 Union All Select * from His_AreaDirection_20084 Union All Select * from His_AreaDirection_20085 Union All Select * from His_AreaDirection_20086 Union All Select * from His_AreaDirection_20087 Union All Select * from His_AreaDirection_20088 Union All Select * from His_AreaDirection_20089 Union All Select * from His_AreaDirection_200810 Union All Select * from His_AreaDirection_200811 Union All Select * from His_AreaDirection_200812 Union All Select * from His_AreaDirection_1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_Directional As Select * from His_Directional_20081 Union All Select * from His_Directional_20082 Union All Select * from His_Directional_20083 Union All Select * from His_Directional_20084 Union All Select * from His_Directional_20085 Union All Select * from His_Directional_20086 Union All Select * from His_Directional_20087 Union All Select * from His_Directional_20088 Union All Select * from His_Directional_20089 Union All Select * from His_Directional_200810 Union All Select * from His_Directional_200811 Union All Select * from His_Directional_200812 Union All Select * from His_Directional_1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE View His_InOutReceiver As Select * from His_InOutReceiver_20081 Union All Select * from His_InOutReceiver_20082 Union All Select * from His_InOutReceiver_20083 Union All Select * from His_InOutReceiver_20084 Union All Select * from His_InOutReceiver_20085 Union All Select * from His_InOutReceiver_20086 Union All Select * from His_InOutReceiver_20087 Union All Select * from His_InOutReceiver_20088 Union All Select * from His_InOutReceiver_20089 Union All Select * from His_InOutReceiver_200810 Union All Select * from His_InOutReceiver_200811 Union All Select * from His_InOutReceiver_200812 Union All Select * from His_InOutReceiver_1
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE view View_GetAllDirectionalAntenna
as
select CodeSenderDirlID,dbo.FunTrendInfoAntenna(DetectionInfo) as DetectionPlace,Directional,dbo.FunDisplayAntennaInfo(DetectionInfo) as DetectionInfo
from CodeSender_DirectionalAntenna

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--历史岗位异常信息视图
create view View_HistoryPostInfo
as
select * from His_PostInfo as hpi
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--查询历史岗位异常信息视图
CREATE view View_SelectHistoryPostInfo
as

select HisPostID, TerritorialID, EmpID,CodeSenderAddress as 标识卡编号,
EmpName as 姓名, WorkTime as 工作时间, BeginTime as 开始工作时间,
EndTime as 结束工作时间, FactTime as 实际工作时间, IsAlarm as 是否报警,
DeptName as 部门, WorkName as 工种, DutyName as 职务, TerritorialName as 区域, 
Meansure as 措施
  from His_PostInfo


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



--出入地域时刻(视图)
CREATE view InOutClimeTime
as

select HisTerritorialID, CodeSenderAddress,UserName,DeptName,TerritorialName,InTerritorialTime,OutTerritorialTime,
	dbo.FunConvertTime(DATEDIFF (ss,InTerritorialTime,OutTerritorialTime)) as ContinueTime,TerritorialID 
from dbo.His_InOutTerritorial as Hiot left join  Emp_NowCompany as Enc on Hiot.UserID=Enc.EmpID and Hiot.CsTypeID=0
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID

where TerritorialTypeName ='地域' and CsTypeID is not null


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--出入限制区域时刻(视图)
CREATE view InOutConfineAreaTime
as

select HisTerritorialID, CodeSenderAddress,UserName,DeptName,TerritorialName,InTerritorialTime,OutTerritorialTime,
	dbo.FunConvertTime(DATEDIFF (ss,InTerritorialTime,OutTerritorialTime)) as ContinueTime,TerritorialID 
from dbo.His_InOutTerritorial as Hiot left join  Emp_NowCompany as Enc on Hiot.UserID=Enc.EmpID and Hiot.CsTypeID=0
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID

where TerritorialTypeName ='限制区域' and CsTypeID is not null




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--出入重点区域时刻(视图)
CREATE view InOutKeyAreaTime
as
select HisTerritorialID, CodeSenderAddress,UserName,DeptName,TerritorialName,InTerritorialTime,OutTerritorialTime,
	dbo.FunConvertTime(DATEDIFF (ss,InTerritorialTime,OutTerritorialTime)) as ContinueTime,TerritorialID 
from dbo.His_InOutTerritorial as Hiot left join  Emp_NowCompany as Enc on Hiot.UserID=Enc.EmpID and Hiot.CsTypeID=0
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID

where TerritorialTypeName ='重点区域' and CsTypeID is not null



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--实时岗位异常信息视图
create view View_RealTimePostInfo
as
select ei.EmpName,di.DeptName, ti.TerritorialName,rtpi.BeginTime,rtpi.IsArrive,rtpi.Meansure
from RT_PostInfo as rtpi
left join Emp_Info as ei on rtpi.EmpID= ei.EmpID
left join Territorial_Info as ti on rtpi.TerritorialID= ti.TerritorialID
left join Emp_NowCompany as enc on rtpi.EmpID=enc.EmpID
left join Dept_Info as di on Enc.DeptID=di.DeptID
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO






--查询实时岗位异常信息视图（执行过）
CREATE    view View_SelectRealTimePostInfo
as

select Css.CodeSenderAddress,ei.EmpName,Dei.DeptName,ti.TerritorialName,rtpi.IsArrive,rtpi.BeginTime,rtpi.TerritorialID--,rtpi.Meansure --rtpi.*,ei.EmpName,ti.TerritorialName 
from RT_PostInfo rtpi 
left join Emp_Info ei on ei.EmpID = rtpi.EmpID
left join Territorial_Info ti on ti.TerritorialID = rtpi.TerritorialID
left join CodeSender_Set as Css on rtpi.EmpID=Css.UserID and Css.CsTypeID=0
left join Emp_NowCompany as Enc on rtpi.EmpID=Enc.EmpID
left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.kj128_his_station_head_time_view_txj
AS
SELECT dbo.His_InOutStationHead.UserID, dbo.His_InOutStationHead.UserName, 
      dbo.His_InOutStationHead.InStationHeadTime, 
      dbo.His_InOutStationHead.OutStationHeadTime, dbo.Station_Info.StationPlace, 
      dbo.His_InOutStationHead.StationHeadPlace, dbo.Dept_Info.DeptName, 
      dbo.His_InOutStationHead.StationAddress, 
      dbo.His_InOutStationHead.StationHeadAddress, 
      dbo.His_InOutStationHead.HisStationHeadID, dbo.Dept_Info.DeptNO, 
      dbo.His_InOutStationHead.CodeSenderAddress, dbo.Dept_Info.DeptID
FROM dbo.Emp_Info INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID RIGHT OUTER JOIN
      dbo.Station_Info INNER JOIN
      dbo.His_InOutStationHead ON 
      dbo.Station_Info.StationAddress = dbo.His_InOutStationHead.StationAddress ON 
      dbo.Emp_Info.EmpID = dbo.His_InOutStationHead.UserID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE     VIEW [dbo].[A_KJ128N_Emp_Table]
AS
SELECT Ei.EmpNO AS 编号, Ei.EmpName AS 姓名, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wi.WtName AS 工种, 
      Ed.Idcard AS 身份证,Ei.EmpID, Dei.DeptID--,Dui.DutyID,Wi.WorkTypeID
FROM Emp_Info AS Ei LEFT JOIN
      Emp_Detail AS Ed ON Ei.EmpID = Ed.EmpID LEFT JOIN
      Emp_WorkType AS Ewt ON Ei.EmpID = Ewt.EmpID and  Ewt.IsEnable=1 LEFT JOIN
      Emp_NowCompany AS Enc ON Enc.EmpID = Ei.EmpID LEFT JOIN
      Dept_Info AS Dei ON Dei.DeptID = Enc.DeptID LEFT JOIN
      Duty_Info AS Dui ON Dui.DutyID = Enc.DutyID LEFT JOIN
      WorkType_Info AS Wi ON Wi.WorkTypeID = Ewt.WorkTypeID 



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE view View_His_Info
as
select hi.CodeSenderAddress,hi.[name]
,dbo.GetValue(dbo.GetValue(hi.DirectionalInfo,':',2),',',1) as StationAddress
,dbo.GetValue(dbo.GetValue(hi.DirectionalInfo,':',2),',',2) as StationHeadAddress
,DirectionalTitle,NowTime
,(select TerritorialName from Territorial_Info where TerritorialID= ts.TerritorialID) as TerritorialName
,enc.DeptID,ew.WorkTypeID
,(hi.[id] + hi.NowTime) as [ID]
from dbo.His_Directional as hi
left join dbo.Territorial_Set as ts on ts.StationID = (select StationID from dbo.Station_Info where StationAddress=dbo.GetValue(dbo.GetValue(DirectionalInfo,':',2),',',1)) 
and ts.StationHeadID=(select StationHeadID from dbo.Station_Head_Info where StationAddress=dbo.GetValue(dbo.GetValue(DirectionalInfo,':',2),',',1)
and StationHeadAddress=dbo.GetValue(dbo.GetValue(DirectionalInfo,':',2),',',2))
--查询使用
left join dbo.CodeSender_Set as cs on cs.CodeSenderAddress = hi.CodeSenderAddress and cs.CsTypeID=0
left join Emp_Info as ei on ei.EmpID = cs.UserID
left join dbo.Emp_WorkType as ew on ew.EmpID=ei.EmpID and IsEnable=1
left join dbo.Emp_NowCompany as enc on enc.EmpID = ei.EmpID
left join dbo.Dept_Info as di on di.DeptID = enc.DeptID
where cs.CsTypeID=0

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view View_RT_Info
as
select 
ri.CodeSenderAddress
,ei.EmpName as EmpName
,ris.StationAddress as StationAddress,ris.StationHeadAddress as StationHeadAddress
,(select Directional from RT_DirectionalAntenna as rdi 
left join dbo.CodeSender_DirectionalAntenna as cd on cd.CodeSenderDirlID = rdi.CodeSenderDirlID
where station = ris.StationAddress and Antenna = ris.StationHeadAddress and CodeSenderAddress = ri.CodeSenderAddress) as RT_Directional
,ri.InTime as InTime
,dbo.FunConvertTime(DATEDIFF(second, ri.InTime, getdate())) as WorkTime
,(select TerritorialName from Territorial_Info where TerritorialID= ts.TerritorialID) as TerritorialName
,enc.DeptID,ew.WorkTypeID
from RT_InOutMine as ri
left join RT_InOutStation as ris on ris.CodeSenderAddress = ri.CodeSenderAddress
left join RT_DirectionalAntenna as rd on rd.CodeSenderAddress = ri.CodeSenderAddress
left join dbo.Territorial_Set as ts on ts.StationID = (select StationID from dbo.Station_Info where StationAddress=ris.StationAddress) 
and ts.StationHeadID=(select StationHeadID from dbo.Station_Head_Info where StationAddress=ris.StationAddress and StationHeadAddress=ris.StationHeadAddress)
--查询使用
left join dbo.CodeSender_Set as cs on cs.CodeSenderAddress = ri.CodeSenderAddress and cs.CsTypeID=0
left join Emp_Info as ei on ei.EmpID = cs.UserID
left join dbo.Emp_WorkType as ew on ew.EmpID=ei.EmpID and IsEnable=1
left join dbo.Emp_NowCompany as enc on enc.EmpID = ei.EmpID
left join dbo.Dept_Info as di on di.DeptID = enc.DeptID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view zjw_RtAndHisInOutMine
as

select RtInOutMineID as [ID],Ri.CodeSenderAddress as CodeSenderAddress,Ei.EmpName as EmpName,Dei.DeptName as DeptName,
	Wt.WtName as WtName,
	Shi.StationAddress as InStationAddress ,Shi.StationHeadAddress as InStationHeadAddress,
	Shi.StationHeadPlace as InWellPlace,Ri.InTime as InTime, Rcs.LastPlace as Place,
	null as OutStationAddress ,null as OutStationHeadAddress,null as OutWellPlace,null as OutTime,
	dbo.FunConvertTime(DATEDIFF (ss,Ri.InTime,Getdate())) as ContinueTime
	
From dbo.RT_InOutMine as Ri left join Station_Head_Info as Shi on Ri.StationHeadID=Shi.StationHeadID
	left join dbo.CodeSender_Set as Css on Ri.CodeSenderAddress=Css.CodeSenderAddress and CsTypeID=0
	left join Emp_Info as Ei on Css.UserID=Ei.EmpID
	left join Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
	left join Emp_WorkType as Ewt on Ei.EmpID=Ewt.EmpID and Ewt.IsEnable=1
	left join WorkType_Info as Wt on Ewt.WorkTypeID=Wt.WorkTypeID
	left join dbo.RealTimeCodeSender as Rcs on Ri.CodeSenderAddress=Rcs.CodeSenderAddress


union 

select Hi.HisInOutMineID as [ID],Hi.CodeSenderAddress as CodeSenderAddress,UserName as EmpName,Dei.DeptName as DeptName,
	Wt.WtName as WtName,
	Hi.InStationAddress as InStationAddress,Hi.InStationHeadAddress as InStationHeadAddress,Hi.InWellPlace as InWellPlace,
	Hi.InTime as InTime,'已出井'as Place,
	Hi.OutStationAddress,Hi.OutStationHeadAddress,Hi.OutWellPlace,Hi.OutTime,dbo.FunConvertTime(Hi.ContinueTime) as ContinueTime
	 
From dbo.His_InOutMine as Hi left join Emp_NowCompany as Enc on Hi.UserID=Enc.EmpID and Hi.CsTypeID=0
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
	left join Emp_WorkType as Ewt on Hi.UserID=Ewt.EmpID and Ewt.IsEnable=1 and Hi.CsTypeID=0
	left join WorkType_Info as Wt on Ewt.WorkTypeID=Wt.WorkTypeID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_AlarmTree_Path]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_AlarmTree_Path]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_RTEmpOverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_RTEmpOverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTEmpOverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTEmpOverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeDistribution]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeDistribution]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeOverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeOverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_workType_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_workType_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_Path]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_Path]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_Territorial]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_Territorial]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_Path]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_Path]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_Territorial]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_Territorial]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_Territorial_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_Territorial_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_HisOverTime_Info]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_HisOverTime_Info]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_TerSet_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_TerSet_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_TerTypeSet_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_TerTypeSet_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_WorkType_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_WorkType_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_TerritorialTree_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_TerritorialTree_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_TerritorialTree_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_TerritorialTree_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_Territorial_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_Territorial_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_Territorial_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_Territorial_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryDistribution]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryDistribution]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryDownWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryDownWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryInOutArea]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryInOutArea]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryOverTimeAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryOverTimeAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryWorkExceptionAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryWorkExceptionAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeAreaAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeAreaAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeDownWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeDownWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeInArea]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeInArea]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeWorkException]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeWorkException]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RtEmpInfo]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RtEmpInfo]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_HisInOutStationHeadInfo_zzha]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_HisInOutStationHeadInfo_zzha]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[view_HisInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[view_HisInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_AlarmTreeHis_Territorial]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_AlarmTreeHis_Territorial]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_AlarmTree_Territorial]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_AlarmTree_Territorial]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_Electricity]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_Electricity]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_StationHeadBreak]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_StationHeadBreak]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_Territorial_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_Territorial_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_AllDept]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_AllDept]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_Dept_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_Dept_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_TerInfo_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_TerInfo_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_View_GetAllDirectionalAntenna]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_View_GetAllDirectionalAntenna]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryEquipmentBreakDown]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryEquipmentBreakDown]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeEquipmentState]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeEquipmentState]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_Territorial_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_Territorial_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_Dept_EmpOverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_Dept_EmpOverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_Station]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_Station]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_StationHead]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_StationHead]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_Cer_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_Cer_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_KJ128N_Duty_Info_Table]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_KJ128N_Duty_Info_Table]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Tree_Dept]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Tree_Dept]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HistoryOverEmployeesAlarm]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HistoryOverEmployeesAlarm]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_RealTimeOverEmployee]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_RealTimeOverEmployee]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_Directional_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_Directional_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_DutyInfo_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_DutyInfo_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_DutyLever_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_DutyLever_RTInWell]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_AlarmTree_StationHeadBreak]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_AlarmTree_StationHeadBreak]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Data_HisCount]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Data_HisCount]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_Alarm_StationHeadBreak
as
Select Shi.StationAddress as 传输分站编号,
	Si.StationPlace as 传输分站位置,
	Shi.StationHeadAddress as 读卡分站编号,
	Shi.StationHeadPlace as 读卡分站位置,
	Shi.StationHeadTel as 分站联系电话,
	Shi.StationHeadType as 分站类型,
	Shi.BreakTime as 故障开始时间
From Station_Head_Info as Shi Left Join Station_Info as Si on Shi.StationAddress=Si.StationAddress
Where StationHeadState=-1000


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_AlarmTree_StationHeadBreak
as
Select 'S'+ CONVERT(varchar,传输分站编号) as ID,
传输分站位置 as Name,
'0' as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From A_Alarm_StationHeadBreak

Union

Select 'H'+ CONVERT(varchar,读卡分站编号) as ID,
读卡分站位置 as Name,
'S'+ CONVERT(varchar,传输分站编号) as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From A_Alarm_StationHeadBreak

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表信息
CREATE view [dbo].[View_RealTimeInWell]
as
SELECT     rtIm.CodeSenderAddress,e.EmpNo,e.EmpName,d.DeptName,wi.WtName,duty.DutyName,en.ClassGroup,ic.ClassName,tim.IntervalName,shi.StationHeadPlace, 
rtIm.InTime,convert(varchar(20),datediff(mi,rtIm.InTime,getdate())/60)+'时'+convert(varchar(20),datediff(mi,rtIm.InTime,getdate())%60)+'分' as InTimeLong, 
rtis.StationHeadPlace AS InWellPlace,convert(varchar(20),datediff(mi,rtis.StationHeadDetectTime,getdate())/60)+'时'+convert(varchar(20),datediff(mi,rtis.StationHeadDetectTime,getdate())%60)+'分' as InHereLong,
rtis.StationHeadDetectTime,ti.TerritorialName,csdi.Directional,d.DeptID,wi.WorkTypeID, duty.DutyID,  duty.DutyClassID, ti.TerritorialID, csdi.CodeSenderDirlID
FROM         dbo.RT_InOutMine AS rtIm INNER JOIN
                      dbo.CodeSender_Set AS cs ON rtIm.CodeSenderAddress = cs.CodeSenderAddress INNER JOIN
                      dbo.Emp_Info AS e ON e.EmpID = cs.UserID AND cs.CsTypeID = 0 INNER JOIN
                      dbo.Station_Head_Info AS shi ON shi.StationHeadID = rtIm.StationHeadID LEFT OUTER JOIN
                      dbo.Emp_NowCompany AS en ON e.EmpID = en.EmpID LEFT OUTER JOIN
                      dbo.Dept_Info AS d ON d.DeptID = en.DeptID LEFT OUTER JOIN
                      dbo.Duty_Info AS duty ON duty.DutyID = en.DutyID LEFT OUTER JOIN
                      dbo.Emp_WorkType AS ew ON ew.EmpID = e.EmpID AND ew.IsEnable = 1 LEFT OUTER JOIN
                      dbo.WorkType_Info AS wi ON wi.WorkTypeID = ew.WorkTypeID LEFT OUTER JOIN
                      dbo.Territorial_Set AS ts ON ts.StationHeadID = rtIm.StationHeadID LEFT OUTER JOIN
                      dbo.Territorial_Info AS ti ON ti.TerritorialID = ts.TerritorialID LEFT OUTER JOIN
                          (SELECT     rts.CodeSenderAddress, rts.StationHeadDetectTime, shif.StationHeadPlace
                            FROM          dbo.RT_InOutStation AS rts INNER JOIN
                                                   dbo.Station_Head_Info AS shif ON rts.StationAddress = shif.StationAddress AND rts.StationHeadAddress = shif.StationHeadAddress) 
                      AS rtis ON rtis.CodeSenderAddress = rtIm.CodeSenderAddress LEFT OUTER JOIN
                      dbo.RealTimeAttendance AS rta ON rta.BlockID = cs.CodeSenderAddress LEFT OUTER JOIN
                      dbo.InfoClass AS ic ON ic.ID = rta.ClassID LEFT OUTER JOIN
                      dbo.TimerInterval AS tim ON tim.ID = rta.TimerIntervalID LEFT OUTER JOIN
                      dbo.RT_DirectionalAntenna AS rtdi ON rtdi.CodeSenderAddress = rtIm.CodeSenderAddress LEFT OUTER JOIN
                      dbo.CodeSender_DirectionalAntenna AS csdi ON csdi.CodeSenderDirlID = rtdi.CodeSenderDirlID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表部门树视图
CREATE view [dbo].[A_DeptTree_RTInWell]
as
select Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.DeptID=Dei.DeptID) as Num,
Dei.serialno
From Dept_Info as Dei

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_HisAlarm_Dept_EmpOverTime
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num 
From Dept_Info as Dei
Order by SerialNO




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_HisAlarm_Station
as
Select StationAddress as 分站编号,StationPlace as 分站位置,BadBeginTime as 故障开始时间,BadEndTime as 故障结束时间,
	dbo.FunConvertTime(BadTime) as 故障持续时长,HistoryBadStationsID
From HistoryBadStations
Where BadTime>0 and StationHeadAddress =0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_HisAlarm_StationHead
as
Select StationAddress as 传输分站编号,StationHeadAddress as 读卡分站编号, StationPlace as 读卡分站位置,BadBeginTime as 故障开始时间,BadEndTime as 故障结束时间,
	dbo.FunConvertTime(BadTime) as 故障持续时长,HistoryBadStationsID
From HistoryBadStations
Where BadTime>0 and StationHeadAddress <>0




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

CREATE view A_KJ128N_Cer_Info_Table
as

Select CerName as 名称,CerVestIn as 发证机关,Remark as 备注,CerTypeID
From Certificate_Info

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE   VIEW A_KJ128N_Duty_Info_Table
AS
SELECT DutyName AS 名称, Et.Title as 等级, Dui.Remark AS 备注,DutyID
FROM dbo.Duty_Info as Dui left join  EnumTable as Et on Dui.DutyClassID=Et.EnumID
Where Et.FunID=4



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_Tree_Dept
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num 
From Dept_Info as Dei
order by SerialNO



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryOverEmployeesAlarm
AS
SELECT His_FactEmployeeCount, '上限超员' AS type, His_OverEmployeeBeginTime, 
      His_OverEmployeeEndTime
FROM dbo.His_OverEmployees


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeOverEmployee
AS
SELECT RT_FactEmployeeCount, '上限超员' AS type, RT_OverEmployeeBeginTime
FROM dbo.RT_OverEmployees


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表方向性树视图
CREATE view a_Directional_RTInWell
as
select wt.CodeSenderDirlID as ID,
wt.Directional as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.CodeSenderDirlID=wt.CodeSenderDirlID) as Num 
From CodeSender_DirectionalAntenna as wt 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表职务树视图
CREATE view a_DutyInfo_RTInWell
as
select wt.DutyID as ID,
wt.DutyName as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.DutyID=wt.DutyID) as Num 
From Duty_Info as wt

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表职务等级树视图
CREATE view a_DutyLever_RTInWell
as
select wt.EnumID as ID,
wt.Title as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.DutyClassID=wt.EnumID) as Num 
From EnumTable as wt where wt.funid=4

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_AlarmTreeHis_Territorial
as

select 'T'+ CONVERT(varchar,Tt.TerritorialTypeID) as ID,
Tt.TypeName as Name ,
'0' as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From Territorial_Type as Tt 

Union

Select 'I'+ Convert(varchar,Ti.TerritorialID) as ID,
Ti.TerritorialName as Name,
'T'+Convert(varchar,Ti.TerritorialTypeID) as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From Territorial_Info as Ti



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE    view A_Alarm_Territorial
as
select CodeSenderAddress as 标识卡号,EmpName as 姓名,WtName as 工种,
	TerritorialTypeName as 区域类型,Rtt.TerritorialName as 区域名称, InTerritorialTime as 进入区域时间,
	dbo.FunConvertTime(datediff(s,InTerritorialTime,GetDate())) as 滞留时长,Ti.TerritorialTypeID,Rtt.TerritorialID
From RT_TerritorialInfo as Rtt left join Emp_Info as Ei on Rtt.UserID=Ei.EmpID and Rtt.CsTypeID=0
	Left Join Emp_WorkType as Ewt on Ei.EmpID=Ewt.EmpID
	Left Join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
	Left join Territorial_Info as Ti on Rtt.TerritorialID=Ti.TerritorialID
 
Where IsAlarm =1 and Rtt.CsTypeID=0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_AlarmTree_Territorial
as

select 'T'+ CONVERT(varchar,Tt.TerritorialTypeID) as ID,
Tt.TypeName as Name ,
'0' as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
0 as Num
From Territorial_Type as Tt 

Union

Select 'I'+ Convert(varchar,Ti.TerritorialID) as ID,
Ti.TerritorialName as Name,
'T'+Convert(varchar,Ti.TerritorialTypeID) as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select count(1) From A_Alarm_Territorial as Att Where Att.TerritorialID=Ti.TerritorialID)
From Territorial_Info as Ti


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_Alarm_Electricity
as
Select  Csi.CodeSenderAddress as 标识卡号, 
	 Et.Title as 标识卡状态, 
	 配置类型= case when CsTypeID= 0 then '人员' when CsTypeID=1 then '设备' else null end, 
	称呼=case when CsTypeID=0 then EmpName when CsTypeID=1 then EquName else null end, 
	部门=case when CsTypeID=0 then Di1.DeptName else null end,CsTypeID
From CodeSender_Info as Csi left join CodeSender_Set as Css on Csi.CodeSenderAddress =Css.CodeSenderAddress 
Left Join Emp_Info as Ei on Ei.EmpID=Css.UserID and CsTypeID=0 
Left Join Emp_NowCompany as Enc on Enc.EmpID=Ei.EmpID 
Left Join Dept_Info as Di1 on Di1.DeptID=Enc.DeptID 
Left Join Equ_BaseInfo as Ebi on Ebi.EquID=Css.UserID and Css.CsTypeID=1 
Left Join Dept_Info as Di2 on Di2.DeptID=Ebi.DeptID 
Left Join EnumTable as Et on Et.EnumID=Csi.CodeSenderStateID and Et.FunID=2 
Where Csi.CodeSenderStateID = 4 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_His_Territorial_Equ
as
Select  Hit.CodeSenderAddress as 标识卡号,Ebi.EquName as 设备名称,Ebi.EquNO as 设备编号,Dei.DeptName as 部门,
	Hit.TerritorialTypeName as 区域类型,Hit.TerritorialName as 区域名称,InTerritorialTime as 进入时间,OutTerritorialTime as 离开时间,
	dbo.FunConvertTime(datediff(s,Hit.InTerritorialTime,Hit.OutTerritorialTime)) as 持续时长,HisTerritorialID
From His_InOutTerritorial as Hit Left join Equ_BaseInfo as Ebi on Hit.UserID=Ebi.EquID and Hit.CsTypeID=1
	left join Dept_Info as Dei on Ebi.DeptID=Dei.DeptID
Where Hit.CsTypeID=1



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE   VIEW A_KJ128N_AllDept
AS
SELECT dbo.Dept_Info.DeptID, dbo.Dept_Info.ParentDeptID, dbo.Dept_Info.DeptNO, 
      dbo.Dept_Info.DeptName, dbo.Dept_Info.Remark, dbo.Dept_SysSet.MaxTimeSec, 
      dbo.Dept_SysSet.MinTimeSec, dbo.Dept_Lead.EmpID, dbo.Dept_Lead.LeadDateTime, 
      dbo.Dept_Detail.DeptTel1, dbo.Dept_Detail.DeptTel2, dbo.Dept_Detail.DeptFax, 
      dbo.Dept_Detail.DeptPost, dbo.Dept_Detail.DeptAddress, dbo.Dept_Detail.DeptEmail, 
      dbo.Dept_Info.ClassID,UnitPrice,SerialNO
FROM dbo.Dept_Info LEFT OUTER JOIN
      dbo.Dept_Lead ON dbo.Dept_Info.DeptID = dbo.Dept_Lead.DeptID LEFT OUTER JOIN
      dbo.Dept_SysSet ON 
      dbo.Dept_Info.DeptID = dbo.Dept_SysSet.DeptID LEFT OUTER JOIN
      dbo.Dept_Detail ON dbo.Dept_Info.DeptID = dbo.Dept_Detail.DeptID left join UnitPrice as Up on dbo.Dept_Info.DeptID=Up.DeptID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



/*
获取部门的基本信息
*/
CREATE  VIEW A_KJ128N_Dept_Info_Table
AS

Select Dei.DeptNO as 编号 ,Dei.DeptName as 部门,Ic.ClassName as 班制,case ParentDeptID when 0 then '无' else (Select DeptName From Dept_Info Where DeptID=Dei.ParentDeptID) end as 上级部门 ,
dbo.FunConvertTime(MaxTimeSec) as 最大工作时间,
dbo.FunConvertTime(MinTimeSec) as 最小工作时间,Dei.DeptID
From Dept_Info as Dei left join InfoClass as Ic on Dei.ClassID=Ic.ID
	left join Dept_SysSet as Ds on Dei.DeptID=Ds.DeptID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_KJ128N_TerInfo_Table
as

Select Ti.TerritorialName as 区域名称,Tt.TypeName as 区域类型, 最大工作人数 = case when Tc.TerEmpCount =-1 then null else Tc.TerEmpCount end,
	最大工作时间=case when Tc.TerWorkTime =-1 then null when Tc.TerWorkTime is null then null else dbo.FunConvertTime(Tc.TerWorkTime) end,
	Ti.Remark as 备注,Ti.TerritorialID,Ti.TerritorialTypeID
From  Territorial_Info as Ti left join Territorial_Type as Tt on Ti.TerritorialTypeID=Tt.TerritorialTypeID
left join Territorial_Config as Tc on Ti.TerritorialID=Tc.TerritorialID











GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE view A_View_GetAllDirectionalAntenna
as

Select Csd.BeginStationAddress as 起始传输分站,Csd.BeginStationHeadAddress as 起始读卡分站,Shi1.StationHeadPlace as 起始位置,
	Csd.EndStationAddress as 终止传输分站 ,Csd.EndStationHeadAddress as 终止读卡分站,Shi2.StationHeadPlace as 终止位置,
	Csd.Directional as 描述,CodeSenderDirlID
From CodeSender_DirectionalAntenna as Csd Left Join Station_Head_Info as Shi1 on Csd.BeginStationAddress=Shi1.StationAddress and Csd.BeginStationHeadAddress=Shi1.StationHeadAddress
	Left Join  Station_Head_Info as Shi2 on Csd.EndStationAddress=Shi2.StationAddress and Csd.EndStationHeadAddress =Shi2.StationHeadAddress

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryEquipmentBreakDown
AS
SELECT dbo.Station_Info.StationID, dbo.HistoryBadStations.StationPlace, 
      dbo.HistoryBadStations.BadBeginTime, dbo.HistoryBadStations.BadEndTime, 
      dbo.HistoryBadStations.BadTime
FROM dbo.HistoryBadStations INNER JOIN
      dbo.Station_Info ON 
      dbo.HistoryBadStations.StationAddress = dbo.Station_Info.StationAddress
WHERE dbo.HistoryBadStations.stationheadaddress = 0
UNION ALL
SELECT dbo.Station_Head_Info.StationHeadID, dbo.HistoryBadStations.StationPlace, 
      dbo.HistoryBadStations.BadBeginTime, dbo.HistoryBadStations.BadEndTime, 
      dbo.HistoryBadStations.BadTime
FROM dbo.Station_Head_Info INNER JOIN
      dbo.HistoryBadStations ON 
      dbo.Station_Head_Info.StationAddress = dbo.HistoryBadStations.StationAddress AND 
      dbo.Station_Head_Info.StationHeadAddress = dbo.HistoryBadStations.StationHeadAddress
WHERE dbo.HistoryBadStations.stationheadaddress <> 0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeEquipmentState
AS
SELECT stationid, stationplace,
          (SELECT title
         FROM EnumTable
         WHERE funid = 7 AND enumid = station_info.stationstate) AS state, 
      breaktime
FROM station_info
UNION ALL
SELECT stationheadid, stationheadplace,
          (SELECT title
         FROM EnumTable
         WHERE funid = 7 AND enumid = station_head_info.stationheadstate) AS state, 
      breaktime
FROM station_head_info


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表区域树视图
CREATE view a_Territorial_RTInWell
as
select wt.TerritorialID as ID,
wt.TerritorialName as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.TerritorialID=wt.TerritorialID) as Num 
From Territorial_Info as wt

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



CREATE  view A_Alarm_Path
as
select Css.CodeSenderAddress as 标识卡号,ei.EmpName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,Wti.WtName as 工种,si.StationPlace as 传输分站位置,
	shi.StationHeadPlace as 读卡分站位置, ALarmDatetime as 开始时间,Dei.DeptID
from RealTimeAlarmPathInfo as rtap left join CodeSender_Set as Css on rtap.EmpID=Css.UserID and Css.CsTypeID=0
left join Emp_Info as ei on ei.EmpID=rtap.EmpID
left join Emp_NowCompany as Enc on Enc.EmpID=ei.EmpID
left join Dept_Info as Dei on Enc.DeptID = Dei.DeptID
left join Duty_Info as Dui on Enc.DutyID = Dui.DutyID
left join Emp_WorkType as Ewt on ei.EmpID = Ewt.EmpID
left join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID

left join Station_Info as si on si.StationAddress=rtap.StationAddress
left join Station_Head_Info as shi on shi.StationHeadAddress=rtap.StationHeadAddress 
and shi.StationAddress = rtap.StationAddress







GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_HisAlarm_Path

AS

Select CodeSenderAddress as 标识卡号,Hpa.EmpName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,Wti.WtName as 工种,
	Si.StationPlace as 传输分站位置,Shi.StationHeadPlace as 读卡分站位置,AlertBeginTime as 开始时间,
	AlertEndTime as 结束时间,dbo.FunConvertTime(datediff(s,AlertBeginTime,AlertEndTime)) as 持续时长,ID as HisAlarmPathID
From His_PathAlert as Hpa left join CodeSender_Set as Css on Hpa.EmpID = Css.UserID and Css.CsTypeID=0
	left join Emp_NowCompany as Enc on Hpa.EmpID = Enc.EmpID
	left join Dept_Info as Dei on Enc.DeptID = Dei.DeptID
	left join Duty_Info as Dui on Enc.DutyID = Dui.DutyID
	Left Join Emp_WorkType as Ewt on Hpa.EmpID = Ewt.EmpID
	Left Join WorkType_Info as Wti on Ewt.WorkTypeID = Wti.WorkTypeID
	Left Join Station_Info as Si on Hpa.StationAddress = Si.StationAddress
	Left Join Station_Head_Info as Shi on Hpa.StationAddress = Shi.StationAddress and Hpa.StationHeadAddress = Shi.StationHeadAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_HisAlarm_Territorial 
as
select CodeSenderAddress as 标识卡号,UserName as 姓名,Wti.WtName as 工种,
	TerritorialTypeName as 区域类型,TerritorialName as 区域名称,InTerritorialTime as 进入区域时间,
	OutTerritorialTime as 离开区域时间,dbo.FunConvertTime(datediff(s,InTerritorialTime,OutTerritorialTime)) as 滞留时长,
	HisTerritorialID

From dbo.His_InOutTerritorial as Hit left join dbo.Emp_WorkType as Ewt on Hit.UserID= Ewt.EmpID and Hit.CsTypeID =0 
	left join dbo.WorkType_Info as Wti on Ewt.WorkTypeID = Wti.WorkTypeID
where CsTypeID =0 and IsAlarm = 1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_His_Territorial_Emp
as
Select  Hit.CodeSenderAddress as 标识卡号,Hit.UserName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,Wti.WtName as 工种,
	Hit.TerritorialTypeName as 区域类型,Hit.TerritorialName as 区域名称,InTerritorialTime as 进入时间,OutTerritorialTime as 离开时间,
	dbo.FunConvertTime(datediff(s,Hit.InTerritorialTime,Hit.OutTerritorialTime)) as 持续时长,HisTerritorialID
From His_InOutTerritorial as Hit Left Join Emp_NowCompany as Enc on Hit.UserID=Enc.EmpID
	left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
	left join Duty_Info as Dui on Enc.DutyID=Dui.DutyID
	Left join Emp_WorkType as Ewt on Hit.UserID=Ewt.EmpID and Ewt.IsEnable=1
	Left Join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
Where Hit.CsTypeID=0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




create   VIEW A_KJ128N_HisOverTime_Info
AS
SELECT CodeSenderAddress AS 标识卡号, UserName AS 姓名, DeptName AS 部门, Dui.DutyName as 职务,Wti.WtName as 工种,
      DelayedStartTime AS 开始时间, DelayedEndTime AS 结束时间, 
      dbo.FunConvertTime(DelayedTime) AS 持续时长, CsTypeID,HisOverTimeAlarmID
FROM dbo.His_OverTimeAlarm as Hot left join dbo.Emp_WorkType as Ewt on Hot.UserID = Ewt.EmpID and Hot.CsTypeID=0
	left join dbo.WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
	Left join dbo.Emp_NowCompany as Enc on Hot.UserID=Enc.EmpID and Hot.CsTypeID=0
	left join dbo.Duty_Info as Dui on Enc.DutyID = Dui.DutyID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_KJ128N_TerSet_Table
as
select Ti.TerritorialName as 区域名称, Tt.TypeName as 区域类型,Shi.StationAddress as 传输分站编号,Shi.StationHeadAddress as 读卡分站编号,StationHeadPlace as 读卡分站位置, IsTerriorialEnter as 是否区域口
	,Ts.TerritorialID,Ti.TerritorialTypeID
From Territorial_Info as Ti left join Territorial_Type as Tt on Ti.TerritorialTypeID=Tt.TerritorialTypeID
left join Territorial_Set as Ts on Ti.TerritorialID=Ts.TerritorialID
left join Station_Head_Info as Shi on Ts.StationHeadID=Shi.StationHeadID 




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



-- 修改视图
create  VIEW dbo.A_KJ128N_TerTypeSet_Table
AS
SELECT dbo.Territorial_Info.TerritorialName AS 区域名称, 
      dbo.Territorial_Type.TypeName AS 区域类型, 
      dbo.Station_Head_Info.StationAddress AS 传输分站编号, 
      dbo.Station_Head_Info.StationHeadAddress AS 读卡分站编号, 
      dbo.Station_Head_Info.StationHeadPlace as 读卡分站位置,
      dbo.Territorial_Set.IsTerriorialEnter AS 是否为区域口,
      dbo.Territorial_Set.TerritorialSetID, 
      dbo.Territorial_Type.TerritorialTypeID, dbo.Territorial_Info.TerritorialID
FROM dbo.Territorial_Type RIGHT OUTER JOIN
      dbo.Territorial_Info ON 
      dbo.Territorial_Type.TerritorialTypeID = dbo.Territorial_Info.TerritorialTypeID FULL OUTER
       JOIN
      dbo.Station_Head_Info RIGHT OUTER JOIN
      dbo.Territorial_Set ON 
      dbo.Station_Head_Info.StationHeadID = dbo.Territorial_Set.StationHeadID ON 
      dbo.Territorial_Info.TerritorialID = dbo.Territorial_Set.TerritorialID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE   VIEW A_KJ128N_WorkType_Info_Table
AS
Select Wt.WtName as 工种,
	Ci.CerName AS 证书,
	dbo.FunConvertTime(Wts.MaxTimeSec) as 最大工作时间,
	dbo.FunConvertTime(Wts.MinTimeSec) as 最小工作时间,
	Wt.Remark as 备注,
	Wt.WorkTypeID,Wts.MaxTimeSec,Wts.MinTimeSec
From WorkType_Info as Wt Left join WorkType_SysSet as Wts on Wt.WorkTypeID=Wts.WorkTypeID
	left join Certificate_Info as Ci on Wt.CerTypeID=Ci.CerTypeID 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_RT_TerritorialTree_Emp
as
select 'T'+ CONVERT(varchar,Tt.TerritorialTypeID) as ID,
Tt.TypeName as Name ,
'0' as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
0 as Num
From Territorial_Type as Tt 

Union

Select 'I'+ Convert(varchar,Ti.TerritorialID) as ID,
Ti.TerritorialName as Name,
'T'+Convert(varchar,Ti.TerritorialTypeID) as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select count(1) From RT_TerritorialInfo as Rtt Where Rtt.TerritorialID=Ti.TerritorialID And CsTypeID=0)
From Territorial_Info as Ti





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_RT_TerritorialTree_Equ
as
select 'T'+ CONVERT(varchar,Tt.TerritorialTypeID) as ID,
Tt.TypeName as Name ,
'0' as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
0 as Num
From Territorial_Type as Tt 

Union

Select 'I'+ Convert(varchar,Ti.TerritorialID) as ID,
Ti.TerritorialName as Name,
'T'+Convert(varchar,Ti.TerritorialTypeID) as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select count(1) From RT_TerritorialInfo as Rtt Where Rtt.TerritorialID=Ti.TerritorialID And CsTypeID=1)
From Territorial_Info as Ti





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_RT_Territorial_Emp
as
select Rtt.CodeSenderAddress as 标识卡号,Ei.EmpName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,Wti.WtName as 工种,
	Rtt.TerritorialTypeName as 区域类型,Rtt.TerritorialName as 区域名称,InTerritorialTime as 进入时间,
	dbo.FunConvertTime(datediff(s,Rtt.InTerritorialTime,GetDate())) as 持续时长, Csd.Directional as 方向性
From RT_TerritorialInfo as Rtt left join RT_DirectionalAntenna as Rtd on Rtt.CodeSenderAddress = Rtd.CodeSenderAddress
left join CodeSender_DirectionalAntenna as Csd on Rtd.CodeSenderDirlID=Csd.CodeSenderDirlID
left join CodeSender_Set as Css on Rtt.CodeSenderAddress = Css.CodeSenderAddress 
left join Emp_Info as Ei on Css.UserID= Ei.EmpID
left join Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
left join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
left join Duty_Info as Dui on Enc.DutyID=Dui.DutyID
left join Emp_WorkType as Ewt on Ei.EmpID=Ewt.EmpID
left join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
Where Rtt.CsTypeID=0



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

create view A_RT_Territorial_Equ
as
Select Rtt.CodeSenderAddress as 标识卡号,Ebi.EquName as 设备名称,Ebi.EquNO as 设备编号,Dei.DeptName as 部门,
	Rtt.TerritorialTypeName as 区域类型,Rtt.TerritorialName as 区域名称,InTerritorialTime as 进入时间,
	dbo.FunConvertTime(datediff(s,Rtt.InTerritorialTime,GetDate())) as 持续时长, Csd.Directional as 方向性
From RT_TerritorialInfo as Rtt left join RT_DirectionalAntenna as Rtd on Rtt.CodeSenderAddress = Rtd.CodeSenderAddress
left join CodeSender_DirectionalAntenna as Csd on Rtd.CodeSenderDirlID=Csd.CodeSenderDirlID
Left Join Equ_BaseInfo as Ebi on Rtt.UserID=Ebi.EquID and Rtt.CsTypeID=1
left join Dept_Info as Dei on Ebi.DeptID= Dei.DeptID
Where Rtt.CsTypeID=1

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryDistribution
AS
SELECT dbo.His_InOutStation.CodeSenderAddress, dbo.Emp_Info.EmpName, 
      CONVERT(varchar(20), dbo.His_InOutStation.StationAddress) 
      + '.' + CONVERT(varchar(20), dbo.His_InOutStation.StationHeadAddress) AS address, 
      dbo.His_InOutStation.StationHeadPlace, 
      dbo.His_InOutStation.StationHeadDetectTime, dbo.Dept_Info.DeptName, 
      dbo.Duty_Info.DutyName, dbo.WorkType_Info.WtName, 
      dbo.CodeSender_DirectionalAntenna.Directional, 
      CASE dbo.His_InOutStation.InStationAntenna WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN
       2 THEN '1' END AS inout
FROM dbo.His_InOutStation LEFT OUTER JOIN
      dbo.CodeSender_DirectionalAntenna LEFT OUTER JOIN
      dbo.His_Directional ON 
      dbo.CodeSender_DirectionalAntenna.CodeSenderDirlID = dbo.His_Directional.id ON 
      dbo.His_InOutStation.CodeSenderAddress = dbo.His_Directional.CodeSenderAddress LEFT
       OUTER JOIN
      dbo.CodeSender_Set ON 
      dbo.His_InOutStation.CsSetID = dbo.CodeSender_Set.CsSetID LEFT OUTER JOIN
      dbo.Emp_NowCompany ON 
      dbo.CodeSender_Set.UserID = dbo.Emp_NowCompany.EmpID LEFT OUTER JOIN
      dbo.Emp_WorkType ON 
      dbo.CodeSender_Set.UserID = dbo.Emp_WorkType.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID INNER JOIN
      dbo.Emp_Info ON 
      dbo.His_InOutStation.UserID = dbo.Emp_Info.EmpID LEFT OUTER JOIN
      dbo.Duty_Info ON dbo.Emp_NowCompany.DutyID = dbo.Duty_Info.DutyID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryDownWell
AS
SELECT dbo.His_InOutMine.CodeSenderAddress, dbo.His_InOutMine.UserName, 
      dbo.Dept_Info.DeptName, dbo.Duty_Info.DutyName, dbo.WorkType_Info.WtName, 
      dbo.His_InOutMine.InTime, CONVERT(varchar(20), 
      dbo.His_InOutMine.InStationAddress) + '.' + CONVERT(varchar(20), 
      dbo.His_InOutMine.InStationHeadAddress) AS inaddress, 
      dbo.His_InOutMine.InWellPlace, dbo.His_InOutMine.OutTime, CONVERT(varchar(20), 
      dbo.His_InOutMine.OutStationAddress) + '.' + CONVERT(varchar(20), 
      dbo.His_InOutMine.OutStationHeadAddress) AS outaddress, 
      dbo.His_InOutMine.OutWellPlace
FROM dbo.WorkType_Info INNER JOIN
      dbo.Emp_WorkType ON 
      dbo.WorkType_Info.WorkTypeID = dbo.Emp_WorkType.WorkTypeID INNER JOIN
      dbo.Dept_Info INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Dept_Info.DeptID = dbo.Emp_NowCompany.DeptID INNER JOIN
      dbo.Duty_Info ON dbo.Emp_NowCompany.DutyID = dbo.Duty_Info.DutyID INNER JOIN
      dbo.His_InOutMine ON 
      dbo.Emp_NowCompany.EmpID = dbo.His_InOutMine.UserID ON 
      dbo.Emp_WorkType.EmpID = dbo.His_InOutMine.UserID
WHERE (dbo.His_InOutMine.CsTypeID = 0)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryInOutArea
AS
SELECT Hit.CodeSenderAddress AS 标识卡号, Hit.UserName AS 姓名, 
      Hit.TerritorialName AS 区域名称, Hit.TerritorialTypeName AS 区域类型, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      Hit.InTerritorialTime AS 进入时间, Hit.OutTerritorialTime AS 离开时间, 
      dbo.FunConvertTime(DATEDIFF(s, Hit.InTerritorialTime, Hit.OutTerritorialTime)) 
      AS 持续时长
FROM dbo.His_InOutTerritorial Hit LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Hit.UserID = Enc.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Hit.UserID = Ewt.EmpID AND 
      Ewt.IsEnable = 1 LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID
WHERE (Hit.CsTypeID = 0)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HistoryOverTimeAlarm
AS
SELECT Hot.CodeSenderAddress AS 标识卡号, Hot.UserName AS 姓名, 
      Hot.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      Hot.InMineTime AS 下井时间, Hot.DelayedStartTime AS 开始时间, 
      Hot.DelayedEndTime AS 结束时间, dbo.FunConvertTime(Hot.DelayedTime) 
      AS 持续时长
FROM dbo.His_OverTimeAlarm Hot LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Hot.UserID = Ewt.EmpID AND 
      Hot.CsTypeID = 0 LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Hot.UserID = Enc.EmpID AND 
      Hot.CsTypeID = 0 LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.Data_HistoryWorkExceptionAlarm
AS
SELECT Css.CodeSenderAddress AS 标识卡号, Hpa.EmpName AS 姓名, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      '' AS 工作异常描述, Hpa.AlertBeginTime AS 开始时间, 
      Hpa.AlertEndTime AS 结束时间, dbo.FunConvertTime(DATEDIFF(s, 
      Hpa.AlertBeginTime, Hpa.AlertEndTime)) AS 持续时长
FROM dbo.His_PathAlert Hpa LEFT OUTER JOIN
      dbo.CodeSender_Set Css ON Hpa.EmpID = Css.UserID AND 
      Css.CsTypeID = 0 LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Hpa.EmpID = Enc.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Hpa.EmpID = Ewt.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID LEFT OUTER JOIN
      dbo.Station_Info Si ON Hpa.StationAddress = Si.StationAddress LEFT OUTER JOIN
      dbo.Station_Head_Info Shi ON Hpa.StationAddress = Shi.StationAddress AND 
      Hpa.StationHeadAddress = Shi.StationHeadAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeAreaAlarm
AS
SELECT dbo.RT_TerritorialInfo.CodeSenderAddress, dbo.Emp_Info.EmpName, 
      dbo.Dept_Info.DeptName, dbo.Duty_Info.DutyName, dbo.WorkType_Info.WtName, 
      dbo.RT_TerritorialInfo.TerritorialTypeName, dbo.RT_TerritorialInfo.TerritorialName, 
      '' AS alarmdis, dbo.RT_TerritorialInfo.InTerritorialTime
FROM dbo.RT_TerritorialInfo INNER JOIN
      dbo.Emp_Info ON dbo.RT_TerritorialInfo.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID LEFT OUTER JOIN
      dbo.Duty_Info ON 
      dbo.Emp_NowCompany.DutyID = dbo.Duty_Info.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType ON 
      dbo.Emp_Info.EmpID = dbo.Emp_WorkType.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeDownWell
AS
SELECT R1.CodeSenderAddress AS 发码器地址, BE.EmpName AS 员工姓名, 
      BE.DeptName, BE.DutyName, dbo.WorkType_Info.WtName, 
      R1.StationHeadDetectTime AS 检测时间, CONVERT(varchar(20), R1.StationAddress) 
      + '.' + CONVERT(varchar(20), R1.StationHeadAddress) AS address, 
      R1.LastPlace AS 检测地点
FROM dbo.RealTimeCodeSender R1 INNER JOIN
      dbo.RT_InOutMine RTI ON 
      R1.CodeSenderAddress = RTI.CodeSenderAddress LEFT OUTER JOIN
      dbo.CodeSender_Set C1 ON R1.CsSetID = C1.CsSetID LEFT OUTER JOIN
      dbo.KJ128N_BaseEmpolyee BE ON C1.UserID = BE.EmpID AND 
      C1.CsTypeID = 0 LEFT OUTER JOIN
      dbo.CodeSender_Directional CD ON 
      R1.CodeSenderDirectional = CD.DetectionInfo LEFT OUTER JOIN
      dbo.Emp_WorkType ON BE.EmpID = dbo.Emp_WorkType.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID
WHERE (C1.CsTypeID = 0)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeInArea
AS
SELECT Rtt.CodeSenderAddress AS 标识卡号, Ei.EmpName AS 姓名, 
      Rtt.TerritorialName AS 区域名称, Rtt.TerritorialTypeName AS 区域类型, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      Rtt.InTerritorialTime AS 进入时间
FROM dbo.RT_TerritorialInfo Rtt LEFT OUTER JOIN
      dbo.RT_DirectionalAntenna Rtd ON 
      Rtt.CodeSenderAddress = Rtd.CodeSenderAddress LEFT OUTER JOIN
      dbo.CodeSender_DirectionalAntenna Csd ON 
      Rtd.CodeSenderDirlID = Csd.CodeSenderDirlID LEFT OUTER JOIN
      dbo.CodeSender_Set Css ON 
      Rtd.CodeSenderAddress = Css.CodeSenderAddress LEFT OUTER JOIN
      dbo.Emp_Info Ei ON Css.UserID = Ei.EmpID LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Ei.EmpID = Enc.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Ei.EmpID = Ewt.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID
WHERE (Rtt.CsTypeID = 0)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeWorkException
AS
SELECT Css.CodeSenderAddress AS 标识卡号, ei.EmpName AS 姓名, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, '' AS 描述, 
      rtap.AlarmDatetime AS 开始时间
FROM dbo.RealTimeAlarmPathInfo rtap LEFT OUTER JOIN
      dbo.CodeSender_Set Css ON rtap.EmpID = Css.UserID AND 
      Css.CsTypeID = 0 LEFT OUTER JOIN
      dbo.Emp_Info ei ON ei.EmpID = rtap.EmpID LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Enc.EmpID = ei.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON ei.EmpID = Ewt.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Wti.WorkTypeID = Wti.WorkTypeID LEFT OUTER JOIN
      dbo.Station_Info si ON si.StationAddress = rtap.StationAddress LEFT OUTER JOIN
      dbo.Station_Head_Info shi ON 
      shi.StationHeadAddress = rtap.StationHeadAddress AND 
      shi.StationAddress = rtap.StationAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RtEmpInfo
AS
SELECT dbo.CodeSender_Set.CodeSenderAddress, dbo.Emp_Info.EmpName, 
      dbo.Dept_Info.DeptName, dbo.Duty_Info.DutyName, dbo.WorkType_Info.WtName, 
      dbo.Emp_Search.EmpTel2
FROM dbo.Emp_Info LEFT OUTER JOIN
      dbo.Emp_WorkType ON 
      dbo.Emp_Info.EmpID = dbo.Emp_WorkType.EmpID LEFT OUTER JOIN
      dbo.WorkType_Info ON 
      dbo.Emp_WorkType.WorkTypeID = dbo.WorkType_Info.WorkTypeID LEFT OUTER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID LEFT OUTER JOIN
      dbo.CodeSender_Set ON 
      dbo.Emp_Info.EmpID = dbo.CodeSender_Set.UserID LEFT OUTER JOIN
      dbo.Emp_Detail ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Detail.EmpID LEFT OUTER JOIN
      dbo.Emp_Search ON 
      dbo.Emp_Info.EmpID = dbo.Emp_Search.EmpID LEFT OUTER JOIN
      dbo.Duty_Info ON dbo.Emp_NowCompany.DutyID = dbo.Duty_Info.DutyID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Shine_HisInOutStationHeadInfo_zzha
AS
SELECT HisSH.CodeSenderAddress BlockID, HisSH.UserID, HisSH.UserName, 
      HisSH.CsTypeID AS userType, HisSH.StationAddress, HisSH.StationHeadAddress, 
      SHI.StationHeadPlace AS StationPlace, HisSH.InStationHeadTime AS InStationTime, 
      HisSH.OutStationHeadTime AS OutStationTime, SHI.StationHeadX AS StationX, 
      SHI.StationHeadY AS StationY, datediff(s, HisSH.InStationHeadTime, 
      HisSH.OutStationHeadTime) AS StationTime, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptID
         FROM dbo.Emp_NowCompany ENC
         WHERE ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptID
         FROM dbo.Equ_BaseInfo EBI
         WHERE EBI.EquID = HisSH.UserID) END AS DeptID, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Emp_NowCompany ENC ON DI.DeptID = ENC.DeptID AND 
               ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Equ_BaseInfo EBI ON EBI.DeptID = DI.DeptID AND 
               EBI.EquID = HisSH.UserID) END AS DeptName
FROM dbo.His_InOutStationHead HisSH JOIN
      dbo.Station_Head_Info SHI ON HisSH.StationAddress = SHI.StationAddress AND 
      HisSH.StationHeadAddress = SHI.StationHeadAddress
UNION
SELECT rts.codesenderaddress AS BlockID,
          (SELECT 编号
         FROM KJ128N_CodeSender_Set_Table
         WHERE 发码器地址 = rts.codesenderaddress) AS UserID,
          (SELECT 称呼
         FROM KJ128N_CodeSender_Set_Table
         WHERE 发码器地址 = rts.codesenderaddress) AS UserName,
          (SELECT CsTypeID
         FROM CodeSender_Set
         WHERE CodeSenderAddress = rts.codesenderaddress) AS userType, 
      rts.stationaddress, rts.stationheadaddress,
          (SELECT stationheadplace
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationPlace, 
      rts.stationheaddetecttime AS InStationTime, 
      rts.stationheaddetecttime AS OutStationTime,
          (SELECT stationheadx
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationX,
          (SELECT stationheady
         FROM Station_Head_Info
         WHERE stationaddress = rts.stationaddress AND 
               stationheadaddress = rts.stationheadaddress) AS StationY, datediff(s, 
      rts.stationheaddetecttime, rts.stationheaddetecttime) AS StationTime, NULL 
      AS DeptID, NULL AS DeptName
FROM RT_InOutStation rts
WHERE rts.codesenderaddress IN
          (SELECT 发码器地址
         FROM KJ128N_CodeSender_Set_Table)


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--历史下井视图
CREATE view view_HisInWell
as
select his.CodeSenderAddress,his.UserName,d.deptName,wi.wtName,duty.DutyName,his.inTime,his.InWellPlace,his.outtime,his.outWellPlace,
		convert(varchar(20),datediff(mi,his.inTime,his.outtime)/60)+'时'+convert(varchar(20),datediff(mi,his.inTime,his.outtime)%60)+'分' as InTimeLong,
	   d.deptID,ew.workTypeID,duty.dutyID
from His_InOutMine his left outer join 
Emp_Info e on his.userid=e.empid LEFT OUTER JOIN
dbo.Emp_NowCompany AS en ON e.EmpID = en.EmpID LEFT OUTER JOIN
dbo.Dept_Info AS d ON d.DeptID = en.DeptID LEFT OUTER JOIN
dbo.Duty_Info AS duty ON duty.DutyID = en.DutyID LEFT OUTER JOIN
dbo.Emp_WorkType AS ew ON ew.EmpID = e.EmpID AND ew.IsEnable = 1 LEFT OUTER JOIN
dbo.WorkType_Info AS wi ON wi.WorkTypeID = ew.WorkTypeID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_AlarmTree_Path
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_Alarm_Path as Ap where Ap.DeptID=Dei.DeptID) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_Alarm_RTEmpOverTime
as
select rto.CodeSenderAddress as 标识卡号,Ei.EmpName as 姓名, Dei.DeptName as 部门, Dui.DutyName as 职务, Wti.WtName as 工种,
	rto.StartOverTime as 开始时间, dbo.FunConvertTime(datediff(s,rto.StartOverTime,GetDate())) as 持续时长
From RT_OverTimeInfo_View as rto left join Emp_Info as Ei on rto.UserID=Ei.EmpID and rto.CsTypeID=0
	left join Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
	left join Dept_Info as Dei on Enc.DeptID = Dei.DeptID 
	left join Duty_Info as Dui on Enc.DutyID = Dui.DutyID
	left join Emp_WorkType  as Ewt on Ei.EmpID=Ewt.EmpID and Ewt.IsEnable=1
	left join WorkType_Info as Wti on Ewt.WorkTypeID = Wti.WorkTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_DeptTree_RTEmpOverTime
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From RT_OverTimeInfo_View as Rtv left join Emp_NowCompany as Enc on Rtv.UserID=Enc.EmpID and Rtv.CsTypeID=0
where Rtv.CsTypeID=0 and  Enc.DeptID=Dei.DeptID) as Num 
From Dept_Info as Dei
order by SerialNO

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeDistribution
AS
SELECT dbo.RealTimeCodeSender.CodeSenderAddress AS CodeSenderAddress, 
      dbo.KJ128N_Emp_Table.员工姓名 AS empname, CONVERT(varchar(20), 
      dbo.RealTimeCodeSender.StationAddress) + '.' + CONVERT(varchar(20), 
      dbo.RealTimeCodeSender.StationHeadAddress) AS address, 
      dbo.RealTimeCodeSender.LastPlace AS stationheadpalce, 
      dbo.RealTimeCodeSender.StationHeadDetectTime AS detecttime, 
      dbo.KJ128N_Emp_Table.部门名称 AS deptname, 
      dbo.KJ128N_Emp_Table.职务名称 AS dutyname, 
      dbo.KJ128N_Emp_Table.工种名称 AS wtname, 
      dbo.CodeSender_DirectionalAntenna.Directional AS Directional, 
      CASE dbo.RealTimeCodeSender.InStationHeadAntenna WHEN 0 THEN '0' WHEN 1 THEN
       '1' WHEN 2 THEN '1' END AS InStationHeadAntenna
FROM dbo.CodeSender_Set INNER JOIN
      dbo.RealTimeCodeSender ON 
      dbo.CodeSender_Set.CsSetID = dbo.RealTimeCodeSender.CsSetID INNER JOIN
      dbo.Emp_Info ON dbo.CodeSender_Set.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.KJ128N_Emp_Table ON 
      dbo.Emp_Info.EmpID = dbo.KJ128N_Emp_Table.EmpID INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RealTimeCodeSender.StationAddress = dbo.Station_Head_Info.StationAddress AND
       dbo.RealTimeCodeSender.StationHeadAddress = dbo.Station_Head_Info.StationHeadAddress
       LEFT OUTER JOIN
      dbo.CodeSender_DirectionalAntenna INNER JOIN
      dbo.RT_DirectionalAntenna ON 
      dbo.CodeSender_DirectionalAntenna.CodeSenderDirlID = dbo.RT_DirectionalAntenna.CodeSenderDirlID
       ON 
      dbo.RealTimeCodeSender.CodeSenderAddress = dbo.RT_DirectionalAntenna.CodeSenderAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_RealTimeOverTime
AS
SELECT rto.CodeSenderAddress AS 标识卡号, Ei.EmpName AS 姓名, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      rto.InMineTime, rto.StartOverTime AS 开始时间
FROM dbo.RT_OverTimeInfo_View rto LEFT OUTER JOIN
      dbo.Emp_Info Ei ON rto.UserID = Ei.EmpID AND rto.CsTypeID = 0 LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Ei.EmpID = Enc.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Ei.EmpID = Ewt.EmpID AND 
      Ewt.IsEnable = 1 LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--实时下井表工种树视图
CREATE view a_workType_RTInWell
as
select wt.workTypeID as ID,
wt.wtName as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.workTypeID=wt.workTypeID) as Num 
From WorkType_Info as wt
union all
select 99999 as id,'未配置' as Name,0 as ParentID,'true' as IsChild ,'true' as IsUserNum ,count(1) as Num From View_RealTimeInWell 
where codeSenderAddress not in(select codeSenderAddress from View_RealTimeInWell vr
join WorkType_Info wi on vr.workTypeID=wi.workTypeID)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.Data_HisCount
AS
SELECT 'Data_HistoryDistribution' AS tablename, COUNT(*) AS num
FROM Data_HistoryDistribution
UNION ALL
SELECT 'Data_HistoryDownWell' AS tablename, COUNT(*) AS num
FROM Data_HistoryDownWell
UNION ALL
SELECT 'Data_HistoryEquipmentBreakDown' AS tablename, COUNT(*) AS num
FROM Data_HistoryEquipmentBreakDown
UNION ALL
SELECT 'Data_HistoryInOutArea' AS tablename, COUNT(*) AS num
FROM Data_HistoryInOutArea
UNION ALL
SELECT 'Data_HistoryOverEmployeesAlarm' AS tablename, COUNT(*) AS num
FROM Data_HistoryOverEmployeesAlarm
UNION ALL
SELECT 'Data_HistoryOverTimeAlarm' AS tablename, COUNT(*) AS num
FROM Data_HistoryOverTimeAlarm
UNION ALL
SELECT 'Data_HistoryWorkExceptionAlarm' AS tablename, COUNT(*) AS num
FROM Data_HistoryWorkExceptionAlarm


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTConfineArea_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTConfineArea_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTConfineArea_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTConfineArea_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTDistrictArea_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTDistrictArea_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTDistrictArea_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTDistrictArea_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTKeyArea_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTKeyArea_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTKeyArea_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTKeyArea_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_ConfineArea_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_ConfineArea_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_ConfineArea_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_ConfineArea_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RtCodeSenderEmpView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RtCodeSenderEmpView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_RTEmpHelp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_RTEmpHelp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTLackSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTLackSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTOverSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTOverSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_InOutStationView1]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_InOutStationView1]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_StationHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_StationHead_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_Ter_EmpOverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_Ter_EmpOverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTDeptView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTDeptView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTStaHead_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTStationHeadView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTStationHeadView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTWorkTypeView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTWorkTypeView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RtCodeSenderEquView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RtCodeSenderEquView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_rt_stationview]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_rt_stationview]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[RT_Terr_OverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[RT_Terr_OverTime]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_RTLackSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_RTLackSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_RTOverSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_RTOverSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_CodeSenderSetView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_CodeSenderSetView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_EquView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_EquView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_LackSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_LackSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_OverSpeed]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_OverSpeed]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_InOutStationView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_InOutStationView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_StationHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_StationHead_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTStaHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTStaHead_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RT_InOutStationView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RT_InOutStationView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_SWorkTer]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_SWorkTer]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StaHeadTree_HisStaHead]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StaHeadTree_HisStaHead]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StaHeadTree_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StaHeadTree_RTStaHead_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StaHeadTree_RTStaHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StaHeadTree_RTStaHead_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Alarm_RTTerOverEmp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Alarm_RTTerOverEmp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTEmpHelp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTEmpHelp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTStaHead_Emp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTStaHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTStaHead_Equ]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_EmpHelp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_EmpHelp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_HisAlarm_TerOverEmp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_HisAlarm_TerOverEmp]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[AssociateAlertView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[AssociateAlertView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[AssociateConfigView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[AssociateConfigView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[AssociateView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[AssociateView]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[His_Terr_OverTime]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[His_Terr_OverTime]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create   view A_Alarm_RTTerOverEmp
as
Select TerritorialName as 区域名称,TerritorialTypeName as 区域类别,NowTerEmpCount as 当前区域人数,TerEmpCount as 区域额定人数,NowOverCount as 区域超员人数,MaxOverCount as 最高超员人数,
	OverEmpBeginTime as 开始时间,dbo.FunConvertTime(datediff(s,OverEmpBeginTime,GetDate())) as 持续时长
From dbo.RT_TerOverEmp


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE  view A_Alarm_RTEmpHelp
as
select 	Reh.CodeSenderAddress as 标识卡号,Ei.EmpName as 姓名,Dei.DeptName as 部门,Wti.WtName as 工种,Dui.DutyName as 职务,
	 Si.StationAddress as 传输分站编号,Si.StationPlace as 传输分站位置,Shi.StationHeadAddress as 读卡分站编号,Shi.StationHeadPlace as 读卡分站位置,
	BeginDateTime as 求救开始时间,dbo.FunConvertTime(datediff(s,BeginDateTime,GetDate())) as 持续时长,Measure as 救援措施 ,RTEmpHelpID
From RT_EmpHelp as Reh left join dbo.Emp_Info as Ei on Reh.EmpID = Ei.EmpID
left join dbo.Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
left join dbo.Dept_Info as Dei on Enc.DeptID=Dei.DeptID
left join dbo.Duty_Info as Dui on Enc.DutyID = Dui.DutyID
left join dbo.Emp_WorkType as Ewt on Ei.EmpID = Ewt.EmpID and Ewt.IsEnable=1
left join dbo.WorkType_Info as Wti on Ewt.WorkTypeID = Wti.WorkTypeID
left join dbo.Station_Info as Si on Reh.StationAddress=Si.StationAddress
left join dbo.Station_Head_Info as Shi on Reh.StationAddress=Shi.StationAddress and Reh.StationHeadAddress=Shi.StationHeadAddress



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_DeptTree_RTEmpHelp
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_Alarm_RTEmpHelp as Aos where Aos.部门=Dei.DeptName) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE   view A_RTStaHead_Emp
as
Select Rts.CodeSenderAddress as 标识卡号,Ei.EmpName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,Wti.WtName as 工种,
	Shi.StationAddress as 传输分站编号,Shi.StationHeadAddress as 读卡分站编号,Shi.StationHeadPlace as 读卡分站位置,
	Rts.StationHeadDetectTime as 监测时间,
	进出状态=case when StationHeadAntennaA=0 and StationHeadAntennaB=0 then '出读卡分站' else '进读卡分站' end,
	Dei.DeptID,StationHeadTypeID	--,Si.StationPlace as 传输分站位置
From RT_InOutStation as Rts Left Join Station_Head_Info as Shi on Rts.StationAddress=Shi.StationAddress and Rts.StationHeadAddress=Shi.StationHeadAddress
	Left Join CodeSender_Set as Css on Rts.CodeSenderAddress=Css.CodeSenderAddress
	Left Join Emp_Info as Ei on Css.UserID=Ei.EmpID
	Left Join Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
	Left Join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
	Left Join Duty_Info as Dui on Enc.DutyID=Dui.DutyID
	Left Join Emp_WorkType as Ewt on Ei.EmpID=Ewt.EmpID and Ewt.IsEnable=1
	Left join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
Where Css.CsTypeID=0 and datediff(s,StationHeadDetectTime,GetDate())>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE   view A_DeptTree_RTStaHead_Emp
as
select Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select count(1) From A_RTStaHead_Emp as Rt Where Rt.DeptID=Dei.DeptID)as Num 
From Dept_Info as Dei



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE   view A_RTStaHead_Equ
as
Select Rts.CodeSenderAddress as 标识卡号,Ebi.EquNO as 设备编号,Ebi.EquName as 设备名称,Dei.DeptName as 部门,
	 Shi.StationAddress as 传输分站编号,Shi.StationHeadAddress as 读卡分站编号,Shi.StationHeadPlace as 读卡分站位置,
	Rts.StationHeadDetectTime as 监测时间,
	进出状态=case when StationHeadAntennaA=0 and StationHeadAntennaB=0 then '出读卡分站' else '进读卡分站' end,
	Dei.DeptID,StationHeadTypeID--,Si.StationPlace as 传输分站位置
From RT_InOutStation as Rts Left Join Station_Head_Info as Shi on Rts.StationAddress=Shi.StationAddress and Rts.StationHeadAddress=Shi.StationHeadAddress
	Left Join CodeSender_Set as Css on Rts.CodeSenderAddress=Css.CodeSenderAddress
	Left join Equ_BaseInfo as Ebi on Css.UserID=Ebi.EquID
	Left Join Dept_Info as Dei on Ebi.DeptID=Dei.DeptID
Where Css.CsTypeID=1 and datediff(s,StationHeadDetectTime,GetDate())>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create   view A_DeptTree_RTStaHead_Equ
as
select Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select count(1) From A_RTStaHead_Equ Where DeptID=Dei.DeptID)as Num 
From Dept_Info as Dei


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_HisAlarm_EmpHelp
as
select  CodeSenderAddress as 标识卡号,EmpName as 姓名, DeptName as 部门, WtName as 工种,DutyName as 职务,
	StationAddress as 传输分站编号,StationPlace as 传输分站位置,StationHeadAddress as 读卡分站编号,StationHeadPlace as 读卡分站位置,
	BeginDateTime as 开始时间,EndDateTime as 结束时间,dbo.FunConvertTime(DateDiff(ss, Hi.BeginDateTime, Hi.EndDateTime)) As 持续时长,
	Measure as  救援措施, HisEmpHelpID
from His_EmpHelp as Hi



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE  view A_HisAlarm_TerOverEmp
as

Select TerritorialName as 区域名称,TerritorialTypeName as 区域类型,TerEmpCount as 区域额定工作人数,MaxOverCount as 最大超员人数,
OverEmpBeginTime as 开始时间,OverEmpEndTime as 结束时间,HisTerOverEmpID
From dbo.His_TerOverEmp


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--实时交接班异常信息
create view AssociateAlertView
as
select id,stationAddress,stationHeadAddress,stationHeadPlace,beginTime,endTime,empName1,empName2,
 isFlagEmp1=CASE isFlagEmp1 WHEN 1 THEN '异常' WHEN 2 THEN '正常' END,isFlagEmp2=case isFlagEmp2 when 1 then '异常' when 2 then '正常' end
 from Associate where endtime<getdate() and DATEADD(hour, 1, endtime)>getdate() and (isflagemp1<>2 or isflagemp2<>2)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--交接班配置信息
create view AssociateConfigView
as
select id,stationAddress,stationHeadAddress,stationHeadPlace,beginTime,endTime,empName1,empName2 from Associate where endTime>getdate()

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

--历史交接班信息
create view AssociateView
as
select id,beginTime,endTime,stationAddress,stationHeadAddress,stationHeadPlace,
	empName1,isFlagEmp1=CASE isFlagEmp1 WHEN 1 THEN '异常' WHEN 2 THEN '正常' END,empName2,
 isFlagEmp2=case isFlagEmp2 when 1 then '异常' when 2 then '正常' end
   from Associate where endtime<getdate()

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




CREATE   View His_Terr_OverTime
as
--历史区域超时报警视图
select Ht.CodeSenderAddress,
	Ht.EmpName,
	Ht.TerritorialID,
	Ht.TerritorialName,
	Ht.TerritorialTypeName,
	Ht.InTerritorialTime,
	dateadd(s,(Select TerWorkTime from His_TerritorialEmpOverTime as Ht1 where Ht.HisTerEmpOverTimeID = Ht1.HisTerEmpOverTimeID),Ht.InTerritorialTime) as StartOverTime, --开始超时时间
	OutTerritorialTime,
	dbo.FunConvertTime(datediff(s,Ht.InTerritorialTime,Ht.OutTerritorialTime)-(Select TerWorkTime from His_TerritorialEmpOverTime as Ht2 where Ht.HisTerEmpOverTimeID = Ht2.HisTerEmpOverTimeID)) as Duration,
	Ht.HisTerEmpOverTimeID
From His_TerritorialEmpOverTime as Ht






GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create     view A_Alarm_RTLackSpeed
as
select Hos.CodeSenderAddress as 标识卡号,Hos.EmpName as 姓名,DeptName as 部门,FirstStationAddress as 起始传输分站编号,
	FirstStationHeadAddress as 起始读卡分站编号,Shi1.StationHeadPlace as 起始读卡分站位置,FirstMonitoringTime as 起始读卡分站监测时间, LastStationAddress as 终点传输分站编号,LastStationHeadAddress as 终点读卡分站编号,
	Shi2.StationHeadPlace as 终点读卡分站位置,LastMonitoringTime as 终点读卡分站监测时间, dbo.FunConvertTime(LackWalkTime) as 额定行走时间,
	dbo.FunConvertTime(DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)) as 实际行走时间,HisOverSpeedID
From His_OverSpeed as Hos left join Station_Head_Info as Shi1 on Hos.FirstStationAddress=Shi1.StationAddress and Hos.FirstStationHeadAddress=Shi1.StationHeadAddress
	left join Station_Head_Info as Shi2 on Hos.LastStationAddress=Shi2.StationAddress and Hos.LastStationHeadAddress =Shi2.StationHeadAddress
where IsOutWell=0 and IsLackSpeed =1 and DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create    view A_Alarm_RTOverSpeed
as
select Hos.CodeSenderAddress as 标识卡号,Hos.EmpName as 姓名,DeptName as 部门,FirstStationAddress as 起始传输分站编号,
	FirstStationHeadAddress as 起始读卡分站编号,Shi1.StationHeadPlace as 起始读卡分站位置,FirstMonitoringTime as 起始读卡分站监测时间, LastStationAddress as 终点传输分站编号,LastStationHeadAddress as 终点读卡分站编号,
	Shi2.StationHeadPlace as 终点读卡分站位置,LastMonitoringTime as 终点读卡分站监测时间, dbo.FunConvertTime(WalkTime) as 额定行走时间,
	dbo.FunConvertTime(DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)) as 实际行走时间,HisOverSpeedID
From His_OverSpeed as Hos left join Station_Head_Info as Shi1 on Hos.FirstStationAddress=Shi1.StationAddress and Hos.FirstStationHeadAddress=Shi1.StationHeadAddress
	left join Station_Head_Info as Shi2 on Hos.LastStationAddress=Shi2.StationAddress and Hos.LastStationHeadAddress =Shi2.StationHeadAddress
where IsOutWell=0 and IsOverSpeed =1 and DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.A_CodeSenderSetView
AS
SELECT c.CodeSenderAddress AS 标识卡号, ET.Title AS 类型, EI.EmpName AS 称呼, 
      dbo.Dept_Info.DeptName AS 部门
FROM dbo.Emp_Info Emp_Info_1 INNER JOIN
      dbo.Emp_Info EI ON Emp_Info_1.EmpID = EI.EmpID INNER JOIN
      dbo.Emp_NowCompany ON Emp_Info_1.EmpID = dbo.Emp_NowCompany.EmpID AND 
      EI.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID RIGHT OUTER JOIN
      dbo.CodeSender_Set c LEFT OUTER JOIN
      dbo.EnumTable ET ON c.CsTypeID = ET.EnumID AND ET.FunID = 3 ON 
      EI.EmpID = c.UserID
WHERE (c.CsTypeID = 0)
UNION ALL
SELECT c.CodeSenderAddress AS 发码器地址, ET.Title AS 配置类型, 
      dbo.Equ_BaseInfo.EquName AS 称呼, dbo.Dept_Info.DeptName
FROM dbo.CodeSender_Set c INNER JOIN
      dbo.Equ_BaseInfo ON c.UserID = dbo.Equ_BaseInfo.EquID INNER JOIN
      dbo.Dept_Info ON 
      dbo.Equ_BaseInfo.DeptID = dbo.Dept_Info.DeptID LEFT OUTER JOIN
      dbo.EnumTable ET ON c.CsTypeID = ET.EnumID AND ET.FunID = 3
WHERE (c.CsTypeID = 1)



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO




CREATE  VIEW dbo.A_EquView
AS
SELECT dbo.Equ_BaseInfo.EquNO AS 编号, dbo.Equ_BaseInfo.EquName AS 名称,
          (SELECT title
         FROM EnumTable
         WHERE funid = 9 AND enumid = EquType) AS 类型,
          (SELECT title
         FROM EnumTable
         WHERE enumid = EquState AND funid = 10) AS 状态, 
      dbo.Dept_Info.DeptName AS 所属部门, dbo.FactoryInfo.FactoryName AS 生产商, 
      dbo.Equ_BaseInfo.Remark AS 备注,
	EquID
FROM dbo.Equ_BaseInfo LEFT OUTER JOIN
      dbo.Dept_Info ON 
      dbo.Equ_BaseInfo.DeptID = dbo.Dept_Info.DeptID LEFT OUTER JOIN
      dbo.FactoryInfo ON dbo.Equ_BaseInfo.FactoryID = dbo.FactoryInfo.FactoryID




GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_HisAlarm_LackSpeed
as
select Hos.CodeSenderAddress as 标识卡号,Hos.EmpName as 姓名,DeptName as 部门,FirstStationAddress as 起始传输分站编号,
	FirstStationHeadAddress as 起始读卡分站编号,Shi1.StationHeadPlace as 起始读卡分站位置,FirstMonitoringTime as 起始读卡分站监测时间, LastStationAddress as 终点传输分站编号,LastStationHeadAddress as 终点读卡分站编号,
	Shi2.StationHeadPlace as 终点读卡分站位置,LastMonitoringTime as 终点读卡分站监测时间, dbo.FunConvertTime(LackWalkTime) as 额定行走时间,
	dbo.FunConvertTime(DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)) as 实际行走时间,HisOverSpeedID
From His_OverSpeed as Hos left join Station_Head_Info as Shi1 on Hos.FirstStationAddress=Shi1.StationAddress and Hos.FirstStationHeadAddress=Shi1.StationHeadAddress
	left join Station_Head_Info as Shi2 on Hos.LastStationAddress=Shi2.StationAddress and Hos.LastStationHeadAddress =Shi2.StationHeadAddress
where IsOutWell=1 and IsLackSpeed =1 and DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)>0



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_HisAlarm_OverSpeed
as
select Hos.CodeSenderAddress as 标识卡号,Hos.EmpName as 姓名,DeptName as 部门,FirstStationAddress as 起始传输分站编号,
	FirstStationHeadAddress as 起始读卡分站编号,Shi1.StationHeadPlace as 起始读卡分站位置,FirstMonitoringTime as 起始读卡分站监测时间, LastStationAddress as 终点传输分站编号,LastStationHeadAddress as 终点读卡分站编号,
	Shi2.StationHeadPlace as 终点读卡分站位置,LastMonitoringTime as 终点读卡分站监测时间, dbo.FunConvertTime(WalkTime) as 额定行走时间,
	dbo.FunConvertTime(DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)) as 实际行走时间,HisOverSpeedID
From His_OverSpeed as Hos left join Station_Head_Info as Shi1 on Hos.FirstStationAddress=Shi1.StationAddress and Hos.FirstStationHeadAddress=Shi1.StationHeadAddress
	left join Station_Head_Info as Shi2 on Hos.LastStationAddress=Shi2.StationAddress and Hos.LastStationHeadAddress =Shi2.StationHeadAddress
where IsOutWell=1 and IsOverSpeed =1 and DATEDIFF(ss,FirstMonitoringTime,LastMonitoringTime)>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--历史进出天线
CREATE view A_His_InOutStationView
as
SELECT     CodeSenderAddress AS 标识卡号,
                          (SELECT     EmpName
                            FROM          dbo.Emp_Info
                            WHERE      (EmpID = dbo.His_InOutStation.UserID)) AS 称呼,
                          (SELECT     StationPlace
                            FROM          dbo.Station_Info
                            WHERE      (StationAddress = dbo.His_InOutStation.StationAddress)) AS 传输分站, StationHeadPlace AS 读卡分站, StationAntennaPlace AS 天线位置, 
                      CASE His_InOutStation.InStationAntenna WHEN 1 THEN
                          (SELECT     TOP 1 'A'
                            FROM          Station_Head_Info) WHEN 2 THEN
                          (SELECT     TOP 1 'B'
                            FROM          Station_Head_Info) WHEN 0 THEN
                          (SELECT     TOP 1 '出探头'
                            FROM          Admins) END AS 天线, StationHeadDetectTime AS 结束巡检时间, StationAddress, StationHeadAddress, InStationAntenna, CsTypeID, 
                      HisInStationID
FROM         dbo.His_InOutStation

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_His_StationHead_Equ
as
Select His.CodeSenderAddress as 标识卡号,His.UserName as 设备名称,Dei.DeptName as 部门,
	His.StationAddress as 传输分站编号,His.StationHeadAddress as 读卡分站编号,His.StationHeadPlace as 读卡分站位置,
	His.InStationHeadTime as 进入时间,His.OutStationHeadTime as 离开时间,
	dbo.FunConvertTime(datediff(s,His.InStationHeadTime,His.OutStationHeadTime)) as 持续时长,HisStationHeadID
From His_InOutStationHead as His left join Equ_BaseInfo as Ebi on His.UserID=Ebi.EquID
	Left Join Dept_Info as Dei on Ebi.DeptID=Dei.DeptID
Where His.CsTypeID=1 and datediff(s,His.InStationHeadTime,His.OutStationHeadTime)>0


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.A_RT_InOutStationView
AS
SELECT dbo.RT_InOutStation.CodeSenderAddress AS 标识卡号, 
      dbo.Station_Info.StationPlace AS 传输分站, 
      dbo.Station_Head_Info.StationHeadPlace AS 读卡分站, 
      dbo.RT_InOutStation.StationHeadDetectTime AS 结束巡检时间, 
      Station_Info_1.StationPlace AS 上次传输分站, 
      Station_Head_Info_1.StationHeadPlace AS 上次读卡分站, 
      dbo.RT_InOutStation.LastStationHeadDetectTime AS 上次结束巡检时间, 
      dbo.RT_InOutStation.StationAddress, dbo.RT_InOutStation.StationHeadAddress, 
      dbo.RT_InOutStation.InStationHeadAntenna, 
      dbo.Station_Head_Info.StationHeadTypeID, dbo.CodeSender_Set.CsTypeID
FROM dbo.Station_Head_Info Station_Head_Info_1 INNER JOIN
      dbo.Station_Info Station_Info_1 INNER JOIN
      dbo.Station_Head_Info INNER JOIN
      dbo.RT_InOutStation INNER JOIN
      dbo.Station_Info ON 
      dbo.RT_InOutStation.StationAddress = dbo.Station_Info.StationAddress ON 
      dbo.Station_Head_Info.StationAddress = dbo.RT_InOutStation.StationAddress AND 
      dbo.Station_Head_Info.StationHeadAddress = dbo.RT_InOutStation.StationHeadAddress
       ON Station_Info_1.StationAddress = dbo.RT_InOutStation.LastStationAddress ON 
      Station_Head_Info_1.StationAddress = dbo.RT_InOutStation.LastStationAddress AND 
      Station_Head_Info_1.StationHeadAddress = dbo.RT_InOutStation.LastStationHeadAddress
       LEFT OUTER JOIN
      dbo.CodeSender_Set ON 
      dbo.RT_InOutStation.CodeSenderAddress = dbo.CodeSender_Set.CodeSenderAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.A_SWorkTer
AS
SELECT dbo.WorkType_Info.WtName AS 工种名称, 
      dbo.Territorial_Info.TerritorialName AS 区域名称, 
      dbo.Territorial_Type.TypeName AS 区域类型, dbo.SWorkTypeTerrialSet.TerriAlarmID, 
      dbo.Territorial_Info.TerritorialTypeID, dbo.Territorial_Info.TerritorialID
FROM dbo.SWorkTypeTerrialSet INNER JOIN
      dbo.WorkType_Info ON 
      dbo.SWorkTypeTerrialSet.WorkTypeID = dbo.WorkType_Info.WorkTypeID INNER JOIN
      dbo.Territorial_Info ON 
      dbo.SWorkTypeTerrialSet.TerrialID = dbo.Territorial_Info.TerritorialID INNER JOIN
      dbo.Territorial_Type ON 
      dbo.Territorial_Info.TerritorialTypeID = dbo.Territorial_Type.TerritorialTypeID


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create    view A_StaHeadTree_HisStaHead
as
Select 'S'+ CONVERT(varchar,Si.StationAddress) as ID,
Si.StationPlace as Name,
'0' as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From Station_Info as Si

Union

Select 'H'+ CONVERT(varchar,Shi.StationHeadAddress) as ID,
Shi.StationHeadPlace as Name,
'S'+ CONVERT(varchar,Shi.StationAddress) as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From Station_Head_Info as Shi



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create  view A_StaHeadTree_RTStaHead_Emp
as
Select 'S'+ CONVERT(varchar,Si.StationAddress) as ID,
Si.StationPlace as Name,
'0' as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
0 as Num
From Station_Info as Si

Union

Select 'H'+ CONVERT(varchar,Shi.StationHeadAddress) as ID,
Shi.StationHeadPlace as Name,
'S'+ CONVERT(varchar,Shi.StationAddress) as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select Count(1) From A_RTStaHead_Emp Where 读卡分站编号=Shi.StationHeadAddress and 传输分站编号=Shi.StationAddress) as Num
From Station_Head_Info as Shi


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create  view A_StaHeadTree_RTStaHead_Equ
as
Select 'S'+ CONVERT(varchar,Si.StationAddress) as ID,
Si.StationPlace as Name,
'0' as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
0 as Num
From Station_Info as Si

Union

Select 'H'+ CONVERT(varchar,Shi.StationHeadAddress) as ID,
Shi.StationHeadPlace as Name,
'S'+ CONVERT(varchar,Shi.StationAddress) as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(Select Count(1) From A_RTStaHead_Equ Where 读卡分站编号=Shi.StationHeadAddress and 传输分站编号=Shi.StationAddress) as Num
From Station_Head_Info as Shi


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create    view A_DeptTree_RTLackSpeed
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_Alarm_RTLackSpeed as Aos where Aos.部门=Dei.DeptName) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create   view A_DeptTree_RTOverSpeed
as
select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_Alarm_RTOverSpeed as Aos where Aos.部门=Dei.DeptName) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE view A_His_InOutStationView1
as
select HisInStationID,标识卡号,称呼,convert(varchar(20),传输分站)+'@'+convert(varchar(20),读卡分站) as 传输_读卡分站,天线位置,天线,结束巡检时间,stationAddress,
StationHeadAddress,InStationAntenna,CsTypeID
from A_His_InOutStationView

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


/***********************9-4************************/

CREATE VIEW dbo.A_His_StationHead_Emp
AS
SELECT CodeSenderAddress AS 标识卡号, UserName AS 姓名, 
      StationAddress AS 传输分站编号, StationHeadAddress AS 读卡分站编号, 
      StationHeadPlace AS 读卡分站位置, InStationHeadTime AS 进入时间, 
      OutStationHeadTime AS 离开时间, dbo.FunConvertTime(DATEDIFF(s, 
      InStationHeadTime, OutStationHeadTime)) AS 持续时长, HisStationHeadID, 
      UserID
FROM dbo.His_InOutStationHead His
WHERE (CsTypeID = 0) AND (DATEDIFF(s, InStationHeadTime, OutStationHeadTime) > 0)



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE  view A_His_Ter_EmpOverTime
as
select his.HisTerEmpOverTimeID id,de.DeptID deid,his.TerritorialID tid,  his.CodeSenderAddress 标识卡,his.EmpName 姓名,de.DeptName 部门,du.DutyName 职务,(select WtName from dbo.WorkType_Info as a left join dbo.Emp_WorkType as b on a.WorkTypeID=b.WorkTypeID where b.EmpID=em.EmpID) 工种,his.TerritorialName 区域名称,his.TerritorialTypeName 区域类型, his.StartOverTime 开始时间,his.OutTerritorialTime 结束时间,his.Duration 持续时长
                             from dbo.His_Terr_OverTime as his 
                            left join dbo.CodeSender_Set as cs on his.CodeSenderAddress=cs.CodeSenderAddress 
                           left join dbo.Emp_NowCompany as em on cs.UserID=em.EmpID 
                             left join dbo.Dept_Info as de on em.DeptID=de.DeptID 
                             left join dbo.Duty_Info as du on em.DutyID=du.DutyID 
                             where cs.CsTypeID=0 


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_RTDeptView
AS
SELECT TOP 100 PERCENT
          (SELECT COUNT(dbo.Emp_Info.EmpName)
         FROM dbo.RT_InStationHeadInfo INNER JOIN
               dbo.RT_InOutMine ON 
               dbo.RT_InStationHeadInfo.CodeSenderAddress = dbo.RT_InOutMine.CodeSenderAddress
                INNER JOIN
               dbo.CodeSender_Set ON 
               dbo.RT_InOutMine.CsSetID = dbo.CodeSender_Set.CsSetID INNER JOIN
               dbo.Emp_Info ON 
               dbo.CodeSender_Set.UserID = dbo.Emp_Info.EmpID INNER JOIN
               dbo.Emp_NowCompany ON 
               dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
               dbo.Dept_Info ON 
               dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID
         WHERE DeptName = dept.deptname AND dbo.RT_InStationHeadInfo.cstypeid = 0) 
      AS num, DeptName
FROM dbo.Dept_Info dept
ORDER BY SerialNO
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.A_RTStationHeadView
AS
SELECT dbo.RealTimeCodeSender.CodeSenderAddress AS 标识卡, 
      dbo.Emp_Info.EmpName AS 姓名, dbo.Dept_Info.DeptName AS 部门, 
      dbo.RealTimeCodeSender.StationHeadDetectTime AS 时间, 
      dbo.RealTimeCodeSender.StationAddress, 
      dbo.RealTimeCodeSender.StationHeadAddress
FROM dbo.CodeSender_Set INNER JOIN
      dbo.Emp_NowCompany INNER JOIN
      dbo.Emp_Info ON dbo.Emp_NowCompany.EmpID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID ON 
      dbo.CodeSender_Set.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.RealTimeCodeSender ON 
      dbo.CodeSender_Set.CsSetID = dbo.RealTimeCodeSender.CsSetID
WHERE (dbo.RealTimeCodeSender.CodeSenderAddress IN
          (SELECT DISTINCT codesenderaddress
         FROM dbo.RT_InOutMine))



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_RTWorkTypeView
AS
SELECT (SELECT COUNT(dbo.Emp_Info.EmpName)
          FROM dbo.WorkType_Info INNER JOIN
                dbo.Emp_WorkType ON 
                dbo.WorkType_Info.WorkTypeID = dbo.Emp_WorkType.WorkTypeID INNER JOIN
                dbo.RT_InOutStation INNER JOIN
                dbo.RT_InOutMine ON 
                dbo.RT_InOutStation.CodeSenderAddress = dbo.RT_InOutMine.CodeSenderAddress
                 INNER JOIN
                dbo.CodeSender_Set ON 
                dbo.RT_InOutMine.CsSetID = dbo.CodeSender_Set.CsSetID INNER JOIN
                dbo.Emp_Info ON 
                dbo.CodeSender_Set.UserID = dbo.Emp_Info.EmpID INNER JOIN
                dbo.Station_Head_Info ON 
                dbo.RT_InOutStation.StationAddress = dbo.Station_Head_Info.StationAddress AND
                 dbo.RT_InOutStation.StationHeadAddress = dbo.Station_Head_Info.StationHeadAddress
                 INNER JOIN
                dbo.Emp_NowCompany ON 
                dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
                dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID ON 
                dbo.Emp_WorkType.EmpID = dbo.Emp_Info.EmpID
          WHERE wtname LIKE wk.wtname AND cstypeid = 0 AND isenable = 1) AS num, 
      WtName
FROM dbo.WorkType_Info wk

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



CREATE VIEW dbo.A_RtCodeSenderEquView
AS
SELECT dbo.RealTimeCodeSender.CodeSenderAddress AS 标识卡号, 
      dbo.Equ_BaseInfo.EquName AS 设备名称, dbo.Equ_BaseInfo.EquNO AS 设备编号, 
      dbo.A_EquView.类型 AS 设备类型, dbo.A_EquView.生产商 AS 生产厂家, 
      dbo.Equ_DetailInfo.ProductionDate AS 生产日期, dbo.A_EquView.所属部门 AS 部门, 
      dbo.RealTimeCodeSender.LastPlace AS 位置, 
      dbo.RealTimeCodeSender.StationHeadDetectTime AS 监测时间, 
      dbo.CodeSender_DirectionalAntenna.Directional AS 方向性, 
      dbo.Equ_BaseInfo.DeptID, dbo.RealTimeCodeSender.StationAddress, 
      dbo.RealTimeCodeSender.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadTypeID
FROM dbo.RealTimeCodeSender INNER JOIN
      dbo.CodeSender_Set ON 
      dbo.CodeSender_Set.CodeSenderAddress = dbo.RealTimeCodeSender.CodeSenderAddress
       INNER JOIN
      dbo.Equ_BaseInfo ON dbo.CodeSender_Set.UserID = dbo.Equ_BaseInfo.EquID AND 
      dbo.CodeSender_Set.UserID = dbo.Equ_BaseInfo.EquID INNER JOIN
      dbo.A_EquView ON dbo.Equ_BaseInfo.EquNO = dbo.A_EquView.编号 INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RealTimeCodeSender.StationAddress = dbo.Station_Head_Info.StationAddress AND
       dbo.RealTimeCodeSender.StationHeadAddress = dbo.Station_Head_Info.StationHeadAddress
       LEFT OUTER JOIN
      dbo.RT_DirectionalAntenna ON 
      dbo.RT_DirectionalAntenna.CodeSenderAddress = dbo.RealTimeCodeSender.CodeSenderAddress
       INNER JOIN
      dbo.CodeSender_DirectionalAntenna ON 
      dbo.CodeSender_DirectionalAntenna.CodeSenderDirlID = dbo.RT_DirectionalAntenna.CodeSenderDirlID
       LEFT OUTER JOIN
      dbo.Equ_DetailInfo ON dbo.CodeSender_Set.UserID = dbo.Equ_DetailInfo.EquID



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.A_rt_stationview
AS
SELECT *
FROM A_RT_InOutStationView
WHERE (标识卡号 IN
          (SELECT CodeSenderAddress
         FROM RT_InOutMine))
UNION
SELECT *
FROM A_RT_InOutStationView
WHERE stationheadtypeid = 8


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE View RT_Terr_OverTime
as
--实时区域超时视图
select Rt.CodeSenderAddress,
	Ei.EmpName,
	Rt.TerritorialName,	
	TerritorialTypeName,
	Rt.InTerritorialTime, 
	dateadd(s,(Select TerWorkTime from Territorial_Config as Tc where Rt.TerritorialID = Tc.TerritorialID),Rt.InTerritorialTime) as StartOverTime, --开始超时时间
	Rt.TerritorialID,
	Ti.TerritorialTypeID
From RT_TerritorialInfo as Rt left join Emp_Info as Ei on Rt.UserID=Ei.EmpID and Rt.CsTypeID=0
	left join Territorial_Info as Ti on Rt.TerritorialID=Ti.TerritorialID
Where datediff(s,Rt.InTerritorialTime,GetDate())>(Select TerWorkTime from Territorial_Config as Tc where Rt.TerritorialID = Tc.TerritorialID)





GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create  view A_DeptTree_RTDistrictArea_Emp
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_Territorial_Emp as Aos where Aos.部门=Dei.DeptName and Aos.区域类型='地域') as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create  view A_DeptTree_RTDistrictArea_Equ
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_Territorial_Equ as Aos where Aos.部门=Dei.DeptName and Aos.区域类型='地域') as Num 
From Dept_Info as Dei
order by SerialNO

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create  view A_DeptTree_RTKeyArea_Emp
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_Territorial_Emp as Aos where Aos.部门=Dei.DeptName and Aos.区域类型='重点区域') as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create  view A_DeptTree_RTKeyArea_Equ
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_Territorial_Equ as Aos where Aos.部门=Dei.DeptName and Aos.区域类型='重点区域') as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view A_RT_ConfineArea_Emp
as
Select * From dbo.A_RT_Territorial_Emp
Where 区域类型='限制区域'

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view A_RT_ConfineArea_Equ
as
Select * From dbo.A_RT_Territorial_Equ
Where 区域类型='限制区域'


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


CREATE VIEW dbo.A_RtCodeSenderEmpView
AS
SELECT dbo.RealTimeCodeSender.CodeSenderAddress AS 标识卡号, 
      dbo.KJ128N_Emp_Table.员工姓名 AS 姓名, 
      dbo.KJ128N_Emp_Table.部门名称 AS 部门, 
      dbo.KJ128N_Emp_Table.工种名称 AS 工种, 
      dbo.KJ128N_Emp_Table.职务名称 AS 职务, 
      dbo.RealTimeCodeSender.LastPlace AS 位置, 
      dbo.RealTimeCodeSender.StationHeadDetectTime AS 监测时间, 
      dbo.CodeSender_DirectionalAntenna.Directional AS 方向性, 
      dbo.Emp_NowCompany.DeptID, dbo.RealTimeCodeSender.StationAddress, 
      dbo.RealTimeCodeSender.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadTypeID
FROM dbo.CodeSender_Set INNER JOIN
      dbo.RealTimeCodeSender ON 
      dbo.CodeSender_Set.CsSetID = dbo.RealTimeCodeSender.CsSetID INNER JOIN
      dbo.Emp_Info ON dbo.CodeSender_Set.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.KJ128N_Emp_Table ON 
      dbo.Emp_Info.EmpID = dbo.KJ128N_Emp_Table.EmpID INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RealTimeCodeSender.StationAddress = dbo.Station_Head_Info.StationAddress AND
       dbo.RealTimeCodeSender.StationHeadAddress = dbo.Station_Head_Info.StationHeadAddress
       LEFT OUTER JOIN
      dbo.CodeSender_DirectionalAntenna INNER JOIN
      dbo.RT_DirectionalAntenna ON 
      dbo.CodeSender_DirectionalAntenna.CodeSenderDirlID = dbo.RT_DirectionalAntenna.CodeSenderDirlID
       ON 
      dbo.RealTimeCodeSender.CodeSenderAddress = dbo.RT_DirectionalAntenna.CodeSenderAddress


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create  view A_DeptTree_RTConfineArea_Emp
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_ConfineArea_Emp as Aos where Aos.部门=Dei.DeptName) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO



create  view A_DeptTree_RTConfineArea_Equ
as

select top 2000 Dei.DeptID as ID,
Dei.DeptName as Name ,
Dei.ParentDeptID as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From A_RT_ConfineArea_Equ as Aos where Aos.部门=Dei.DeptName) as Num 
From Dept_Info as Dei
order by SerialNO


GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_Path]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_Path]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_PathTree]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_PathTree]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_View_His_OverEmployees]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_View_His_OverEmployees]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


create view A_PathTree
as
Select Id ,
PathName as Name,
'0' as ParentID,
'true' as IsChild ,
'false' as IsUserNum ,
0 as Num
From Path_Info

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create view A_View_His_OverEmployees
as
Select His_RatingEmployeesCount as 额定超员人数,His_FactEmployeeCount as 超员最高人数, (His_FactEmployeeCount-His_RatingEmployeesCount) as 超员人数,
His_OverEmployeeBeginTime as 开始时间,
  His_OverEmployeeEndTime as 结束时间,dbo.FunConvertTime( DATEDIFF(ss,His_OverEmployeeBeginTime, His_OverEmployeeEndTime)) as 持续时长,
His_OverEmployeeID
FROM His_OverEmployees
where His_OverEmployeeEndTime is not null

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

create  view A_His_Path
as
Select Css.CodeSenderAddress as 标识卡号,Ei.EmpName as 姓名,Dei.DeptName as 部门,Dui.DutyName as 职务,
	Wti.WtName as 工种,Ti.IntervalName as 班次,Pai.PathName as 巡检路线,CheckBeginTime as 开始时间,
	CheckEndTime as 结束时间, dbo.FunConvertTime(datediff(s,CheckBeginTime,CheckEndTime)) as 持续时长,Hpc.ID as HisPathID
From HisPathCheck as Hpc Left Join Path_Emp_Relation as Per on Hpc.EmpID=Per.EmpID
	Left Join Path_Info as Pai on Per.PathNo=Pai.PathNo
	Left Join CodeSender_Set as Css on Hpc.EmpID=Css.UserID and Css.CsTypeID=0
	Left Join Emp_Info as Ei on Hpc.EmpID=Ei.EmpID
	Left Join Emp_NowCompany as Enc on Ei.EmpID=Enc.EmpID
	Left Join Dept_Info as Dei on Enc.DeptID=Dei.DeptID
	Left Join Duty_Info as Dui on Enc.DutyID=Dui.DutyID
	Left Join Emp_WorkType as Ewt on Ei.EmpID=Ewt.EmpID and Ewt.IsEnable=1
	Left Join WorkType_Info as Wti on Ewt.WorkTypeID=Wti.WorkTypeID
	Left Join TimerInterval as Ti on Hpc.Interval=Ti.ID
Where Pai.PathName is not null and Css.CsTypeID=0 



GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE view [dbo].[View_RealTimeInWell]
as
SELECT     rtIm.CodeSenderAddress,e.EmpNo,e.EmpName,d.DeptName,wi.WtName,duty.DutyName,en.ClassGroup,ic.ClassName,tim.IntervalName,shi.StationHeadPlace, 
rtIm.InTime,convert(varchar(20),datediff(mi,rtIm.InTime,getdate())/60)+'时'+convert(varchar(20),datediff(mi,rtIm.InTime,getdate())%60)+'分' as InTimeLong, 
rtis.StationHeadPlace AS InWellPlace,convert(varchar(20),datediff(mi,rtis.StationHeadDetectTime,getdate())/60)+'时'+convert(varchar(20),datediff(mi,rtis.StationHeadDetectTime,getdate())%60)+'分' as InHereLong,
rtis.StationHeadDetectTime,csdi.Directional,d.DeptID,wi.WorkTypeID, duty.DutyID,  duty.DutyClassID, csdi.CodeSenderDirlID
FROM         dbo.RT_InOutMine AS rtIm INNER JOIN
                      dbo.CodeSender_Set AS cs ON rtIm.CodeSenderAddress = cs.CodeSenderAddress INNER JOIN
                      dbo.Emp_Info AS e ON e.EmpID = cs.UserID AND cs.CsTypeID = 0 INNER JOIN
                      dbo.Station_Head_Info AS shi ON shi.StationHeadID = rtIm.StationHeadID LEFT OUTER JOIN
                      dbo.Emp_NowCompany AS en ON e.EmpID = en.EmpID LEFT OUTER JOIN
                      dbo.Dept_Info AS d ON d.DeptID = en.DeptID LEFT OUTER JOIN
                      dbo.Duty_Info AS duty ON duty.DutyID = en.DutyID LEFT OUTER JOIN
                      dbo.Emp_WorkType AS ew ON ew.EmpID = e.EmpID AND ew.IsEnable = 1 LEFT OUTER JOIN
                      dbo.WorkType_Info AS wi ON wi.WorkTypeID = ew.WorkTypeID LEFT OUTER JOIN
                      --dbo.Territorial_Set AS ts ON ts.StationHeadID = rtIm.StationHeadID LEFT OUTER JOIN
                      --dbo.Territorial_Info AS ti ON ti.TerritorialID = ts.TerritorialID LEFT OUTER JOIN
                          (SELECT     rts.CodeSenderAddress, rts.StationHeadDetectTime, shif.StationHeadPlace
                            FROM          dbo.RT_InOutStation AS rts INNER JOIN
                                                   dbo.Station_Head_Info AS shif ON rts.StationAddress = shif.StationAddress AND rts.StationHeadAddress = shif.StationHeadAddress) 
                      AS rtis ON rtis.CodeSenderAddress = rtIm.CodeSenderAddress LEFT OUTER JOIN
                      dbo.RealTimeAttendance AS rta ON rta.BlockID = cs.CodeSenderAddress LEFT OUTER JOIN
                      dbo.InfoClass AS ic ON ic.ID = rta.ClassID LEFT OUTER JOIN
                      dbo.TimerInterval AS tim ON tim.ID = rta.TimerIntervalID LEFT OUTER JOIN
                      dbo.RT_DirectionalAntenna AS rtdi ON rtdi.CodeSenderAddress = rtIm.CodeSenderAddress LEFT OUTER JOIN
                      dbo.CodeSender_DirectionalAntenna AS csdi ON csdi.CodeSenderDirlID = rtdi.CodeSenderDirlID
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

ALTER     FUNCTION [dbo].[EmpMonthStat](@userid int,@year int,@month int)
RETURNS int
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat int
	select @stat=count(UserID) from dbo.His_InOutMine
	where InTime >= str(@year)+'-'+str(@month)+'-1' and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-1'
	and UserID =@userid
return @stat
end

GO


ALTER      FUNCTION EmpTimeMonthStat(@userid int,@year int,@month int)
RETURNS varchar(100)
as
BEGIN
declare @tmpmonth int
declare @tmpyear int
if @month=12
begin
	set @tmpyear = @year+1
	set @tmpmonth = 1
end
else
begin
	set @tmpyear = @year
	set @tmpmonth = @month+1
end

declare @stat varchar(100)
	select @stat=ISnull(sum(ContinueTime),'0') from dbo.His_InOutMine
	where InTime >= str(@year)+'-'+str(@month)+'-1' and InTime<str(@tmpyear)+'-'+str(@tmpmonth)+'-1'
	and UserID =@userid
if (@stat='0')
return @stat

return dbo.FunConvertTime(@stat)
end

GO

ALTER   view A_Alarm_StationHeadBreak
as
Select Shi.StationAddress as 传输分站编号,
	Si.StationPlace as 传输分站位置,
	Shi.StationHeadAddress as 读卡分站编号,
	Shi.StationHeadPlace as 读卡分站位置,
	Shi.StationHeadTel as 分站联系电话,
	Shi.StationHeadType as 分站类型,
	'读卡分站故障' as 故障类型,
	Shi.BreakTime as 故障开始时间
From Station_Head_Info as Shi Left Join Station_Info as Si on Shi.StationAddress=Si.StationAddress
Where StationHeadState=-1000

union

Select Shi.StationAddress as 传输分站编号,
	Si.StationPlace as 传输分站位置,
	Shi.StationHeadAddress as 读卡分站编号,
	Shi.StationHeadPlace as 读卡分站位置,
	Shi.StationHeadTel as 分站联系电话,
	Shi.StationHeadType as 分站类型,
	'传输分站故障' as 故障类型,
	Si.BreakTime as 故障开始时间
From Station_Head_Info as Shi left join Station_Info as Si on Shi.StationAddress = Si.StationAddress
Where Si.StationState=-1000 and Shi.StationHeadState <> -1000


GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StationHeadState]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StationHeadState]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE   view [dbo].[A_StationHeadState]
as

select (cast(Shi.StationAddress as varchar(20))+'-'+cast(Shi.StationHeadAddress as varchar(20))) as 读卡分站编号,
	Shi.StationHeadPlace as 安装位置,
	'传输分站故障' as 分站状态,
	Shi.StationHeadType as 读卡分站类型,
	SHi.AntennaA as 天线A,
	Shi.AntennaB as 天线B,		
	Shi.StationHeadTel as 联系电话,
	Shi.Remark AS 备注,Shi.StationHeadAddress,Shi.StationAddress
from Station_Head_Info as Shi left join Station_Info as Si on Shi.StationAddress=Si.StationAddress
where  Si.StationState = -1000

Union

select (cast(Shi.StationAddress as varchar(20))+'-'+cast(Shi.StationHeadAddress as varchar(20))) as 读卡分站编号,
	Shi.StationHeadPlace as 安装位置,
	'读卡分站故障' as 分站状态,
	Shi.StationHeadType as 读卡分站类型,
	SHi.AntennaA as 天线A,
	Shi.AntennaB as 天线B,		
	Shi.StationHeadTel as 联系电话,
	Shi.Remark AS 备注,Shi.StationHeadAddress,Shi.StationAddress
from Station_Head_Info as Shi left join Station_Info as Si on Shi.StationAddress=Si.StationAddress
where Si.StationState <> -1000 and  Shi.StationHeadState = -1000

Union

select (cast(Shi.StationAddress as varchar(20))+'-'+cast(Shi.StationHeadAddress as varchar(20))) as 读卡分站编号,
	Shi.StationHeadPlace as 安装位置,
	'正常' as 分站状态,
	Shi.StationHeadType as 读卡分站类型,
	SHi.AntennaA as 天线A,
	Shi.AntennaB as 天线B,		
	Shi.StationHeadTel as 联系电话,
	Shi.Remark AS 备注,Shi.StationHeadAddress,Shi.StationAddress
from Station_Head_Info as Shi left join Station_Info as Si on Shi.StationAddress=Si.StationAddress
where  not (Si.StationState = -1000) and not (Shi.StationHeadState = -1000) 

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shen_HisInOutStationHeadInfo_zdc]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shen_HisInOutStationHeadInfo_zdc]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.Shen_HisInOutStationHeadInfo_zdc
AS
SELECT HisSH.CodeSenderAddress BlockID, HisSH.UserID, HisSH.UserName, 
      HisSH.CsTypeID AS userType, HisSH.StationAddress, HisSH.StationHeadAddress, 
      SHI.StationHeadPlace AS StationPlace, HisSH.InStationHeadTime AS InStationTime, 
      HisSH.OutStationHeadTime AS OutStationTime, SHI.StationHeadX AS StationX, 
      SHI.StationHeadY AS StationY, datediff(s, HisSH.InStationHeadTime, 
      HisSH.OutStationHeadTime) AS StationTime, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptID
         FROM dbo.Emp_NowCompany ENC
         WHERE ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptID
         FROM dbo.Equ_BaseInfo EBI
         WHERE EBI.EquID = HisSH.UserID) END AS DeptID, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Emp_NowCompany ENC ON DI.DeptID = ENC.DeptID AND 
               ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Equ_BaseInfo EBI ON EBI.DeptID = DI.DeptID AND 
               EBI.EquID = HisSH.UserID) END AS DeptName
FROM dbo.His_InOutStationHead HisSH JOIN
      dbo.Station_Head_Info SHI ON HisSH.StationAddress = SHI.StationAddress AND 
      HisSH.StationHeadAddress = SHI.StationHeadAddress
UNION
SELECT dbo.RT_InStationHeadInfo.CodeSenderAddress, dbo.RT_InStationHeadInfo.UserID, 
      dbo.Emp_Info.EmpName, dbo.RT_InStationHeadInfo.CsTypeID, 
      dbo.Station_Head_Info.StationAddress, dbo.Station_Head_Info.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadPlace, 
      dbo.RT_InStationHeadInfo.StationHeadTime, 
      dbo.RT_InStationHeadInfo.InStationHeadTime, dbo.Station_Head_Info.StationHeadX, 
      dbo.Station_Head_Info.StationHeadY, '8', dbo.Emp_NowCompany.DeptID, 
      dbo.Dept_Info.DeptName
FROM dbo.RT_InStationHeadInfo INNER JOIN
      dbo.Emp_Info ON 
      dbo.RT_InStationHeadInfo.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RT_InStationHeadInfo.StationHeadID = dbo.Station_Head_Info.StationHeadID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Shine_HisInOutStationHeadInfo_zzha]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[Shine_HisInOutStationHeadInfo_zzha]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.Shine_HisInOutStationHeadInfo_zzha
AS
SELECT HisSH.CodeSenderAddress BlockID, HisSH.UserID, HisSH.UserName, 
      HisSH.CsTypeID AS userType, HisSH.StationAddress, HisSH.StationHeadAddress, 
      SHI.StationHeadPlace AS StationPlace, HisSH.InStationHeadTime AS InStationTime, 
      HisSH.OutStationHeadTime AS OutStationTime, SHI.StationHeadX AS StationX, 
      SHI.StationHeadY AS StationY, datediff(s, HisSH.InStationHeadTime, 
      HisSH.OutStationHeadTime) AS StationTime, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptID
         FROM dbo.Emp_NowCompany ENC
         WHERE ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptID
         FROM dbo.Equ_BaseInfo EBI
         WHERE EBI.EquID = HisSH.UserID) END AS DeptID, 
      CASE HisSH.CsTypeID WHEN 0 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Emp_NowCompany ENC ON DI.DeptID = ENC.DeptID AND 
               ENC.empID = HisSH.UserID) WHEN 1 THEN
          (SELECT DeptName
         FROM dbo.Dept_Info DI INNER JOIN
               Equ_BaseInfo EBI ON EBI.DeptID = DI.DeptID AND 
               EBI.EquID = HisSH.UserID) END AS DeptName
FROM dbo.His_InOutStationHead HisSH JOIN
      dbo.Station_Head_Info SHI ON HisSH.StationAddress = SHI.StationAddress AND 
      HisSH.StationHeadAddress = SHI.StationHeadAddress
UNION
SELECT dbo.RT_InStationHeadInfo.CodeSenderAddress, dbo.RT_InStationHeadInfo.UserID, 
      dbo.Emp_Info.EmpName, dbo.RT_InStationHeadInfo.CsTypeID, 
      dbo.Station_Head_Info.StationAddress, dbo.Station_Head_Info.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadPlace, 
      dbo.RT_InStationHeadInfo.StationHeadTime, 
      dbo.RT_InStationHeadInfo.InStationHeadTime, dbo.Station_Head_Info.StationHeadX, 
      dbo.Station_Head_Info.StationHeadY, '8', dbo.Emp_NowCompany.DeptID, 
      dbo.Dept_Info.DeptName
FROM dbo.RT_InStationHeadInfo INNER JOIN
      dbo.Emp_Info ON 
      dbo.RT_InStationHeadInfo.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.Emp_Info.EmpID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RT_InStationHeadInfo.StationHeadID = dbo.Station_Head_Info.StationHeadID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_Graphics_StationHeadState]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_Graphics_StationHeadState]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_Graphics_StationHeadState
AS
SELECT SHeadInfo.StationAddress, SHeadInfo.StationHeadAddress, 
      SHeadInfo.StationHeadPlace, SHeadInfo.StationHeadX, SHeadInfo.StationHeadY, 
      dbo.EnumTable.Title
FROM (SELECT dbo.Station_Head_Info.StationAddress, 
              dbo.Station_Head_Info.StationHeadAddress, 
              dbo.Station_Head_Info.StationHeadPlace, 
              dbo.Station_Head_Info.StationHeadX, dbo.Station_Head_Info.StationHeadY, 
              CASE WHEN dbo.Station_Head_Info.StationHeadState >= 0 THEN
                  (SELECT stationstate
                 FROM Station_info
                 WHERE stationaddress = dbo.Station_Head_Info.StationAddress) 
              WHEN dbo.Station_Head_Info.StationHeadState < 0 THEN dbo.Station_Head_Info.StationHeadState
               END AS StationHeadState
        FROM dbo.Station_Head_Info) SHeadInfo INNER JOIN
      dbo.EnumTable ON SHeadInfo.StationHeadState = dbo.EnumTable.EnumID AND 
      dbo.EnumTable.FunID = 7

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[View_RealTimeInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[View_RealTimeInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.View_RealTimeInWell
AS
SELECT rtIm.CodeSenderAddress, e.EmpNO, e.EmpName, d.DeptName, wi.WtName, 
      duty.DutyName, en.ClassGroup, ic.ClassName, tim.IntervalName, 
      shi.StationHeadPlace, rtIm.InTime, CONVERT(varchar(20), DATEDIFF(mi, rtIm.InTime, 
      GETDATE()) / 60) + '时' + CONVERT(varchar(20), DATEDIFF(mi, rtIm.InTime, GETDATE()) 
      % 60) + '分' AS InTimeLong, rtis.stationheadplace AS InWellPlace, 
      CONVERT(varchar(20), DATEDIFF(mi, rtis.StationHeadTime, GETDATE()) / 60) 
      + '时' + CONVERT(varchar(20), DATEDIFF(mi, rtis.StationHeadTime, GETDATE()) % 60) 
      + '分' AS InHereLong, rtis.StationHeadTime AS StationHeadDetectTime, 
      rtis.directional, d.DeptID, wi.WorkTypeID, duty.DutyID, duty.DutyClassID
FROM dbo.RT_InOutMine rtIm INNER JOIN
      dbo.CodeSender_Set cs ON 
      rtIm.CodeSenderAddress = cs.CodeSenderAddress INNER JOIN
      dbo.Emp_Info e ON e.EmpID = cs.UserID AND cs.CsTypeID = 0 INNER JOIN
      dbo.Station_Head_Info shi ON 
      shi.StationHeadID = rtIm.StationHeadID LEFT OUTER JOIN
      dbo.Emp_NowCompany en ON e.EmpID = en.EmpID LEFT OUTER JOIN
      dbo.Dept_Info d ON d.DeptID = en.DeptID LEFT OUTER JOIN
      dbo.Duty_Info duty ON duty.DutyID = en.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType ew ON ew.EmpID = e.EmpID AND 
      ew.IsEnable = 1 LEFT OUTER JOIN
      dbo.WorkType_Info wi ON wi.WorkTypeID = ew.WorkTypeID LEFT OUTER JOIN
          (SELECT rts.codesenderaddress, rts.StationHeadTime, shif.stationheadplace, 
               rts.directional
         FROM dbo.RT_InStationHeadInfo AS rts INNER JOIN
               dbo.Station_Head_Info AS shif ON rts.StationHeadID = shif.StationHeadID) 
      rtis ON rtis.codesenderaddress = rtIm.CodeSenderAddress LEFT OUTER JOIN
      dbo.RealTimeAttendance rta ON 
      rta.BlockID = cs.CodeSenderAddress LEFT OUTER JOIN
      dbo.InfoClass ic ON ic.ID = rta.ClassID LEFT OUTER JOIN
      dbo.TimerInterval tim ON tim.ID = rta.TimerIntervalID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO




if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTStaHead_Emp]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_RTStaHead_Emp
AS
SELECT Rts.CodeSenderAddress AS 标识卡号, Ei.EmpName AS 姓名, 
      Dei.DeptName AS 部门, Dui.DutyName AS 职务, Wti.WtName AS 工种, 
      Shi.StationAddress AS 传输分站编号, Shi.StationHeadAddress AS 读卡分站编号, 
      Shi.StationHeadPlace AS 读卡分站位置, Rts.InStationHeadTime AS 监测时间, 
      CASE WHEN InOutFlag = 1 THEN '出读卡分站' ELSE '进读卡分站' END AS 进出状态, 
      Dei.DeptID, Shi.StationHeadTypeID, Css.CsTypeID, Rts.Directional AS 方向性
FROM dbo.RT_InStationHeadInfo Rts LEFT OUTER JOIN
      dbo.Station_Head_Info Shi ON 
      Rts.StationHeadID = Shi.StationHeadID LEFT OUTER JOIN
      dbo.CodeSender_Set Css ON 
      Rts.CodeSenderAddress = Css.CodeSenderAddress LEFT OUTER JOIN
      dbo.Emp_Info Ei ON Css.UserID = Ei.EmpID LEFT OUTER JOIN
      dbo.Emp_NowCompany Enc ON Ei.EmpID = Enc.EmpID LEFT OUTER JOIN
      dbo.Dept_Info Dei ON Enc.DeptID = Dei.DeptID LEFT OUTER JOIN
      dbo.Duty_Info Dui ON Enc.DutyID = Dui.DutyID LEFT OUTER JOIN
      dbo.Emp_WorkType Ewt ON Ei.EmpID = Ewt.EmpID AND 
      Ewt.IsEnable = 1 LEFT OUTER JOIN
      dbo.WorkType_Info Wti ON Ewt.WorkTypeID = Wti.WorkTypeID

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_View_His_OverEmployees]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_View_His_OverEmployees]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_View_His_OverEmployees
AS
SELECT ratingEmpCount AS 额定超员人数, maxEmpCount AS 超员最高人数, 
      beginTime AS 开始时间, endTime AS 结束时间, existstime AS 持续时长, 
      HisOverEmployeeID
FROM dbo.HisOverEmployee
WHERE (endTime IS NOT NULL)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTStaHead_Emp]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_DeptTree_RTStaHead_Emp
AS
SELECT DeptID AS ID, DeptName AS Name, ParentDeptID AS ParentID, 'true' AS IsChild, 
      'false' AS IsUserNum,
          (SELECT COUNT(1)
         FROM A_RTStaHead_Emp AS Rt
         WHERE Rt.DeptID = Dei.DeptID) AS Num
FROM dbo.Dept_Info Dei

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTStaHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTStaHead_Equ]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_DeptTree_RTStaHead_Equ
AS
SELECT DeptID AS ID, DeptName AS Name, ParentDeptID AS ParentID, 'true' AS IsChild, 
      'false' AS IsUserNum,
          (SELECT COUNT(1)
         FROM A_RTStaHead_Equ
         WHERE DeptID = Dei.DeptID) AS Num
FROM dbo.Dept_Info Dei

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StaHeadTree_RTStaHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StaHeadTree_RTStaHead_Emp]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_StaHeadTree_RTStaHead_Emp
AS
SELECT 'S' + CONVERT(varchar, Si.StationAddress) AS ID, Si.StationPlace AS Name, 
      '0' AS ParentID, 'true' AS IsChild, 'false' AS IsUserNum, 0 AS Num
FROM Station_Info AS Si
UNION
SELECT 'H' + CONVERT(varchar, Shi.StationHeadAddress) AS ID, 
      Shi.StationHeadPlace AS Name, 'S' + CONVERT(varchar, Shi.StationAddress) 
      AS ParentID, 'true' AS IsChild, 'false' AS IsUserNum,
          (SELECT COUNT(1)
         FROM A_RTStaHead_Emp
         WHERE 读卡分站编号 = Shi.StationHeadAddress AND 
               传输分站编号 = Shi.StationAddress) AS Num
FROM Station_Head_Info AS Shi

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_StaHeadTree_RTStaHead_Equ]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_StaHeadTree_RTStaHead_Equ]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_StaHeadTree_RTStaHead_Equ
AS
SELECT 'S' + CONVERT(varchar, Si.StationAddress) AS ID, Si.StationPlace AS Name, 
      '0' AS ParentID, 'true' AS IsChild, 'false' AS IsUserNum, 0 AS Num
FROM Station_Info AS Si
UNION
SELECT 'H' + CONVERT(varchar, Shi.StationHeadAddress) AS ID, 
      Shi.StationHeadPlace AS Name, 'S' + CONVERT(varchar, Shi.StationAddress) 
      AS ParentID, 'true' AS IsChild, 'false' AS IsUserNum,
          (SELECT COUNT(1)
         FROM A_RTStaHead_Equ
         WHERE 读卡分站编号 = Shi.StationHeadAddress AND 
               传输分站编号 = Shi.StationAddress) AS Num
FROM Station_Head_Info AS Shi

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO






if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_workType_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_workType_RTInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO


--实时下井表工种树视图
CREATE view a_workType_RTInWell
as
select wt.workTypeID as ID,
wt.wtName as Name ,
0 as ParentID,
'true' as IsChild ,
'true' as IsUserNum ,
(select count(1) From View_RealTimeInWell as Rtv where Rtv.workTypeID=wt.workTypeID) as Num 
From WorkType_Info as wt
union all
select 99999 as id,'未配置' as Name,0 as ParentID,'true' as IsChild ,'true' as IsUserNum ,count(1) as Num From View_RealTimeInWell 
where codeSenderAddress not in(select codeSenderAddress from View_RealTimeInWell vr
join WorkType_Info wi on vr.workTypeID=wi.workTypeID)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[a_DutyInfo_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[a_DutyInfo_RTInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

/*实时下井表职务树视图*/
CREATE VIEW dbo.a_DutyInfo_RTInWell
AS
SELECT DutyID AS ID, DutyName AS Name, 0 AS ParentID, 'true' AS IsChild, 
      'true' AS IsUserNum,
          (SELECT COUNT(1)
         FROM View_RealTimeInWell AS Rtv
         WHERE Rtv.DutyID = wt.DutyID) AS Num
FROM dbo.Duty_Info wt
UNION ALL
SELECT TOP 1 '99999' AS ID, '未配置' AS Name, 0 AS ParentID, 'true' AS IsChild, 
      'true' AS IsUserNum,
          (SELECT COUNT(1)
         FROM View_RealTimeInWell AS Rtv
         WHERE Rtv.DutyID IS NULL) AS Num
--FROM dbo.Duty_Info wt

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_His_StationHead_Emp]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_His_StationHead_Emp]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_His_StationHead_Emp
AS
SELECT CodeSenderAddress AS 标识卡号, UserName AS 称呼, 
      StationAddress AS 传输分站编号, StationHeadAddress AS 读卡分站编号, 
      StationHeadPlace AS 读卡分站位置, InStationHeadTime AS 进入时间, 
      OutStationHeadTime AS 离开时间, dbo.FunConvertTime(DATEDIFF(s, 
      InStationHeadTime, OutStationHeadTime)) AS 持续时长, HisStationHeadID, UserID, 
      CsTypeID
FROM dbo.His_InOutStationHead His
WHERE (DATEDIFF(s, InStationHeadTime, OutStationHeadTime) > 0)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_DeptTree_RTInWell]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_DeptTree_RTInWell]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

/*实时下井表部门树视图*/
CREATE VIEW dbo.A_DeptTree_RTInWell
AS
SELECT DeptID AS ID, DeptName AS Name, ParentDeptID AS ParentID, 'true' AS IsChild, 
      'true' AS IsUserNum,
          (SELECT COUNT(1)
         FROM View_RealTimeInWell AS Rtv
         WHERE Rtv.DeptID = Dei.DeptID) AS Num, SerialNO
FROM dbo.Dept_Info Dei
UNION ALL
SELECT TOP 1 99999 AS ID, '未配置' AS Name, 0 AS ParentID, 'true' AS IsChild, 
      'true' AS IsUserNum,
          (SELECT COUNT(1)
         FROM View_RealTimeInWell AS Rtv
         WHERE Rtv.DeptID IS NULL) AS Num, SerialNO
FROM dbo.Dept_Info Dei

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[A_RTStationHeadView]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [dbo].[A_RTStationHeadView]
GO

SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

CREATE VIEW dbo.A_RTStationHeadView
AS
SELECT dbo.RT_InStationHeadInfo.CodeSenderAddress AS 标识卡, 
      dbo.Emp_Info.EmpName AS 姓名, dbo.Dept_Info.DeptName AS 部门, 
      dbo.RT_InStationHeadInfo.StationHeadTime AS 时间, 
      dbo.Station_Head_Info.StationAddress, dbo.Station_Head_Info.StationHeadAddress, 
      dbo.Station_Head_Info.StationHeadTypeID, 
      dbo.RT_InStationHeadInfo.InOutFlag
FROM dbo.RT_InStationHeadInfo INNER JOIN
      dbo.Emp_NowCompany ON 
      dbo.RT_InStationHeadInfo.UserID = dbo.Emp_NowCompany.EmpID INNER JOIN
      dbo.Emp_Info ON 
      dbo.RT_InStationHeadInfo.UserID = dbo.Emp_Info.EmpID INNER JOIN
      dbo.Dept_Info ON dbo.Emp_NowCompany.DeptID = dbo.Dept_Info.DeptID INNER JOIN
      dbo.Station_Head_Info ON 
      dbo.RT_InStationHeadInfo.StationHeadID = dbo.Station_Head_Info.StationHeadID
WHERE (dbo.RT_InStationHeadInfo.CsTypeID = 0)

GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO
